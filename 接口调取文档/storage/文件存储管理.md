# æ–‡ä»¶å­˜å‚¨ç®¡ç† API

## åŸºç¡€ä¿¡æ¯

**åŸºç¡€URL**: `http://localhost:8080/api/storage`

## æ¦‚è¿°

ç»Ÿä¸€æ–‡ä»¶å­˜å‚¨ç®¡ç†æ¥å£ï¼Œæ”¯æŒæ–‡ä»¶ä¸Šä¼ ã€ä¸‹è½½ã€é¢„è§ˆåŠŸèƒ½ã€‚æ”¯æŒå°æ–‡ä»¶ç›´è¿ä¸Šä¼ ï¼ˆ< 15GBï¼‰å’Œè¶…å¤§æ–‡ä»¶åˆ†ç‰‡ä¸Šä¼ ï¼ˆ> 15GBï¼‰ã€‚

**âœ¨ UUIDæ˜ å°„æœºåˆ¶**ï¼šé‡‡ç”¨UUIDæ˜ å°„+æƒé™è¡¨å®ç°è·¨ç”¨æˆ·æ–‡ä»¶å»é‡ï¼Œç›¸åŒæ–‡ä»¶åªå­˜å‚¨ä¸€ä»½ç‰©ç†å‰¯æœ¬ã€‚

**âš¡ é‡‡æ ·å“ˆå¸Œ**ï¼šå°æ–‡ä»¶å®Œæ•´å“ˆå¸Œï¼Œå¤§æ–‡ä»¶é‡‡æ ·å“ˆå¸Œï¼ˆå…ƒä¿¡æ¯+å¼€å¤´/ä¸­é—´/ç»“å°¾å„10MBï¼‰ï¼Œé¿å…æµè§ˆå™¨å†…å­˜æº¢å‡ºã€‚

**ğŸš€ é¢„ç­¾åURL**ï¼šå®¢æˆ·ç«¯ç›´è¿MinIOï¼Œæ”¯æŒè§†é¢‘æµå¼æ’­æ”¾ã€Rangeè¯·æ±‚ã€æ–­ç‚¹ç»­ä¼ ã€‚

## æ ¸å¿ƒåŠŸèƒ½

- âœ… **UUIDæ˜ å°„å»é‡**ï¼ˆç§’ä¼ ï¼Œè·¨ç”¨æˆ·ç”Ÿæ•ˆï¼‰
- âœ… **é‡‡æ ·å“ˆå¸Œè®¡ç®—**ï¼ˆé¿å…å¤§æ–‡ä»¶å†…å­˜æº¢å‡ºï¼‰
- âœ… ä¸€æ¬¡æ€§Tokenä¸Šä¼ ï¼ˆ< 15GBï¼‰
- âœ… é¢„ç­¾åURLåˆ†ç‰‡ä¸Šä¼ ï¼ˆ> 15GBï¼‰
- âœ… é¢„ç­¾åURLä¸‹è½½ï¼ˆç›´è¿MinIOï¼Œ3å°æ—¶-7å¤©æœ‰æ•ˆï¼‰
- âœ… åŸºäºæƒé™è¡¨çš„è®¿é—®æ§åˆ¶
- âœ… æ™ºèƒ½æœ‰æ•ˆæœŸç®¡ç†

---

## 1. è¯·æ±‚æ–‡ä»¶ä¸Šä¼ 

### æ¥å£ä¿¡æ¯

- **URL**: `/api/storage/upload/request`
- **æ–¹æ³•**: `POST`
- **éœ€è¦é‰´æƒ**: æ˜¯ï¼ˆBearer Tokenï¼‰

### è¯·æ±‚å‚æ•°

```json
{
  "file_type": "user_image",
  "storage_location": "user_files",
  "related_id": null,
  "filename": "example.jpg",
  "file_size": 6400000,
  "content_type": "image/jpeg",
  "file_hash": "abc123...",
  "force_upload": false,
  "estimated_upload_time": 3600
}
```

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| file_type | string | æ˜¯ | æ–‡ä»¶ç±»å‹ï¼šuser_image, user_video, user_document, friend_imageç­‰ |
| storage_location | string | æ˜¯ | å­˜å‚¨ä½ç½®ï¼šuser_files, friend_messages, group_files, avatars |
| related_id | string | å¦ | å…³è”IDï¼ˆå¥½å‹IDæˆ–ç¾¤IDï¼‰ |
| filename | string | æ˜¯ | åŸå§‹æ–‡ä»¶å |
| file_size | number | æ˜¯ | æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰ |
| content_type | string | æ˜¯ | MIMEç±»å‹ |
| file_hash | string | å¦ | é‡‡æ ·SHA-256å“ˆå¸Œå€¼ï¼ˆ64ä½åå…­è¿›åˆ¶ï¼‰ï¼Œå°æ–‡ä»¶å®Œæ•´å“ˆå¸Œï¼Œå¤§æ–‡ä»¶é‡‡æ ·å“ˆå¸Œ |
| force_upload | boolean | å¦ | æ˜¯å¦å¼ºåˆ¶ä¸Šä¼ ï¼ˆè·³è¿‡ç§’ä¼ ï¼‰ï¼Œé»˜è®¤false |
| estimated_upload_time | number | å¦ | é¢„è®¡ä¸Šä¼ æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œä»…è¶…å¤§æ–‡ä»¶éœ€è¦ |

**file_hashè¯´æ˜**ï¼š
- å°æ–‡ä»¶ï¼ˆ< 30MBï¼‰ï¼šè®¡ç®—å®Œæ•´SHA-256å“ˆå¸Œ
- å¤§æ–‡ä»¶ï¼ˆâ‰¥ 30MBï¼‰ï¼šé‡‡æ ·å“ˆå¸Œç­–ç•¥
  - æ–‡ä»¶å…ƒä¿¡æ¯ï¼ˆæ–‡ä»¶å+å¤§å°+ä¿®æ”¹æ—¶é—´+ç±»å‹ï¼‰
  - å¼€å¤´10MBæ•°æ®
  - ä¸­é—´10MBæ•°æ®
  - ç»“å°¾10MBæ•°æ®
  - åˆå¹¶è®¡ç®—SHA-256
- ä¼˜åŠ¿ï¼šé¿å…æµè§ˆå™¨å†…å­˜æº¢å‡ºï¼Œ3GBè§†é¢‘ä¹Ÿèƒ½å¿«é€Ÿè®¡ç®—å“ˆå¸Œ

### å“åº”ç¤ºä¾‹

**æˆåŠŸå“åº”ï¼ˆä¸€æ¬¡æ€§Tokenï¼‰**:
```json
{
  "mode": "one_time_token",
  "preview_support": "inline_preview",
  "upload_token": "token_xxx",
  "upload_url": "http://localhost:8080/api/storage/upload/direct?token=xxx",
  "expires_in": 300,
  "presigned_url": null,
  "multipart_upload_id": null,
  "file_key": "user_id/images/timestamp_hash_filename.jpg",
  "max_file_size": 104857600,
  "instant_upload": false,
  "existing_file_url": null
}
```

**ç§’ä¼ å“åº”ï¼ˆUUIDæ˜ å°„ï¼‰**:
```json
{
  "mode": "one_time_token",
  "preview_support": "inline_preview",
  "instant_upload": true,
  "existing_file_url": "http://localhost:8080/api/storage/file/{uuid}",
  "file_key": "user_id/images/..."
}
```

> **é‡è¦**: è¿”å›çš„ `existing_file_url` æ˜¯UUIDæ ¼å¼çš„è®¿é—®è·¯å¾„ï¼Œä¸æ˜¯MinIOç›´è¿è·¯å¾„ã€‚
> è¿™æ ·å¯ä»¥å®ç°è·¨ç”¨æˆ·å»é‡ï¼Œç›¸åŒæ–‡ä»¶åªå­˜å‚¨ä¸€ä»½ã€‚

### Fetch API è°ƒç”¨ç¤ºä¾‹

```javascript
// è®¡ç®—æ–‡ä»¶é‡‡æ ·SHA-256å“ˆå¸Œï¼ˆé€‚ç”¨äºæ‰€æœ‰æ–‡ä»¶å¤§å°ï¼‰
async function calculateSHA256(file) {
  const SAMPLE_SIZE = 10 * 1024 * 1024; // 10MB
  
  // æ–‡ä»¶å…ƒä¿¡æ¯
  const metadata = `${file.name}|${file.size}|${file.lastModified}|${file.type}`;
  const metadataBuffer = new TextEncoder().encode(metadata);
  
  let dataToHash;
  
  if (file.size <= SAMPLE_SIZE * 3) {
    // å°æ–‡ä»¶ï¼ˆ< 30MBï¼‰ï¼šè®¡ç®—å®Œæ•´å“ˆå¸Œ
    dataToHash = await file.arrayBuffer();
  } else {
    // å¤§æ–‡ä»¶ï¼šé‡‡æ ·å“ˆå¸Œç­–ç•¥
    const chunks = [];
    
    // è¯»å–å¼€å¤´10MB
    const startBlob = file.slice(0, SAMPLE_SIZE);
    chunks.push(new Uint8Array(await startBlob.arrayBuffer()));
    
    // è¯»å–ä¸­é—´10MB
    const middleStart = Math.floor((file.size - SAMPLE_SIZE) / 2);
    const middleBlob = file.slice(middleStart, middleStart + SAMPLE_SIZE);
    chunks.push(new Uint8Array(await middleBlob.arrayBuffer()));
    
    // è¯»å–ç»“å°¾10MB
    const endBlob = file.slice(file.size - SAMPLE_SIZE, file.size);
    chunks.push(new Uint8Array(await endBlob.arrayBuffer()));
    
    // åˆå¹¶æ‰€æœ‰æ•°æ®
    const totalLength = metadataBuffer.length + chunks.reduce((sum, chunk) => sum + chunk.length, 0);
    dataToHash = new Uint8Array(totalLength);
    let offset = 0;
    
    dataToHash.set(metadataBuffer, offset);
    offset += metadataBuffer.length;
    
    for (const chunk of chunks) {
      dataToHash.set(chunk, offset);
      offset += chunk.length;
    }
  }
  
  // è®¡ç®—SHA-256å“ˆå¸Œ
  const hashBuffer = await crypto.subtle.digest('SHA-256', dataToHash);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

// è¯·æ±‚ä¸Šä¼ 
async function requestUpload(file, fileType = 'user_image') {
  const accessToken = localStorage.getItem('access_token');
  
  // 1. è®¡ç®—æ–‡ä»¶å“ˆå¸Œ
  const fileHash = await calculateSHA256(file);
  
  // 2. è¯·æ±‚ä¸Šä¼ URL
  const response = await fetch('http://localhost:8080/api/storage/upload/request', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${accessToken}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      file_type: fileType,
      storage_location: 'user_files',
      filename: file.name,
      file_size: file.size,
      content_type: file.type,
      file_hash: fileHash,
      force_upload: false
    })
  });
  
  const result = await response.json();
  
  // 3. æ£€æŸ¥æ˜¯å¦ç§’ä¼ 
  if (result.instant_upload) {
    console.log('ç§’ä¼ æˆåŠŸï¼', result.existing_file_url);
    return result;
  }
  
  return result;
}
```

---

## 2. ç›´æ¥ä¸Šä¼ æ–‡ä»¶

### æ¥å£ä¿¡æ¯

- **URL**: `/api/storage/upload/direct?token={token}`
- **æ–¹æ³•**: `POST`
- **éœ€è¦é‰´æƒ**: å¦ï¼ˆä½¿ç”¨ä¸€æ¬¡æ€§Tokenï¼‰
- **Content-Type**: `multipart/form-data`

### è¯·æ±‚å‚æ•°

Form Data:
- `file`: æ–‡ä»¶æ•°æ®

### å“åº”ç¤ºä¾‹

```json
{
  "file_url": "http://localhost:8080/api/storage/file/{uuid}",
  "file_key": "user_id/images/...",
  "file_size": 6400000,
  "content_type": "image/jpeg",
  "preview_support": "inline_preview"
}
```

> **é‡è¦**: è¿”å›çš„ `file_url` æ˜¯UUIDæ ¼å¼çš„è®¿é—®è·¯å¾„ï¼Œéœ€è¦é€šè¿‡åç«¯APIè®¿é—®ï¼Œä¸æ˜¯MinIOç›´è¿è·¯å¾„ã€‚

### Fetch API è°ƒç”¨ç¤ºä¾‹

```javascript
// ä¸Šä¼ æ–‡ä»¶
async function uploadFile(file, uploadUrl) {
  const formData = new FormData();
  formData.append('file', file);
  
  const response = await fetch(uploadUrl, {
    method: 'POST',
    body: formData
    // æ³¨æ„ï¼šä¸éœ€è¦Authorization headerï¼ŒTokenå·²åœ¨URLä¸­
  });
  
  if (!response.ok) {
    throw new Error('ä¸Šä¼ å¤±è´¥');
  }
  
  return await response.json();
}
```

---

## 3. è·å–åˆ†ç‰‡ä¸Šä¼ URLï¼ˆè¶…å¤§æ–‡ä»¶ï¼‰

### æ¥å£ä¿¡æ¯

- **URL**: `/api/storage/multipart/part_url`
- **æ–¹æ³•**: `GET`
- **éœ€è¦é‰´æƒ**: æ˜¯ï¼ˆBearer Tokenï¼‰

### è¯·æ±‚å‚æ•°

Query Parameters:
- `file_key`: æ–‡ä»¶key
- `upload_id`: åˆ†ç‰‡ä¸Šä¼ ID
- `part_number`: åˆ†ç‰‡ç¼–å·ï¼ˆä»1å¼€å§‹ï¼‰

### å“åº”ç¤ºä¾‹

```json
{
  "part_url": "http://localhost:9000/...",
  "part_number": 1,
  "expires_in": 3600
}
```

### Fetch API è°ƒç”¨ç¤ºä¾‹

```javascript
// åˆ†ç‰‡ä¸Šä¼ ï¼ˆè¶…å¤§æ–‡ä»¶ï¼‰
async function uploadLargeFile(file, uploadInfo) {
  const accessToken = localStorage.getItem('access_token');
  const chunkSize = 50 * 1024 * 1024; // 50MB
  const chunks = Math.ceil(file.size / chunkSize);
  
  for (let i = 0; i < chunks; i++) {
    const start = i * chunkSize;
    const end = Math.min(start + chunkSize, file.size);
    const chunk = file.slice(start, end);
    
    // è·å–åˆ†ç‰‡URL
    const partUrlResponse = await fetch(
      `http://localhost:8080/api/storage/multipart/part_url?file_key=${uploadInfo.file_key}&upload_id=${uploadInfo.multipart_upload_id}&part_number=${i + 1}`,
      {
        headers: {
          'Authorization': `Bearer ${accessToken}`
        }
      }
    );
    
    const { part_url } = await partUrlResponse.json();
    
    // ä¸Šä¼ åˆ†ç‰‡
    await fetch(part_url, {
      method: 'PUT',
      body: chunk
    });
    
    console.log(`åˆ†ç‰‡ ${i + 1}/${chunks} ä¸Šä¼ å®Œæˆ`);
  }
}
```

---

## å®Œæ•´ä¸Šä¼ æµç¨‹ç¤ºä¾‹

```javascript
// å®Œæ•´çš„æ–‡ä»¶ä¸Šä¼ æµç¨‹
async function uploadFileComplete(file) {
  try {
    console.log('å¼€å§‹ä¸Šä¼ :', file.name);
    
    // 1. è®¡ç®—æ–‡ä»¶å“ˆå¸Œ
    console.log('è®¡ç®—æ–‡ä»¶å“ˆå¸Œ...');
    const fileHash = await calculateSHA256(file);
    
    // 2. è¯·æ±‚ä¸Šä¼ 
    const uploadInfo = await requestUpload(file, 'user_image');
    
    // 3. æ£€æŸ¥ç§’ä¼ 
    if (uploadInfo.instant_upload) {
      console.log('ç§’ä¼ æˆåŠŸï¼ä½¿ç”¨UUIDæ˜ å°„');
      return {
        success: true,
        instant: true,
        url: uploadInfo.existing_file_url  // UUIDæ ¼å¼çš„è®¿é—®URL
      };
    }
    
    // 4. æ ¹æ®æ¨¡å¼ä¸Šä¼ 
    if (uploadInfo.mode === 'one_time_token') {
      // å°æ–‡ä»¶ç›´æ¥ä¸Šä¼ 
      const result = await uploadFile(file, uploadInfo.upload_url);
      console.log('ä¸Šä¼ æˆåŠŸï¼');
      return {
        success: true,
        instant: false,
        url: result.file_url
      };
    } else {
      // è¶…å¤§æ–‡ä»¶åˆ†ç‰‡ä¸Šä¼ 
      await uploadLargeFile(file, uploadInfo);
      console.log('åˆ†ç‰‡ä¸Šä¼ å®Œæˆï¼');
      return {
        success: true,
        instant: false
      };
    }
    
  } catch (error) {
    console.error('ä¸Šä¼ å¤±è´¥:', error);
    throw error;
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const fileInput = document.querySelector('#file-input');
fileInput.addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  
  try {
    const result = await uploadFileComplete(file);
    alert(`ä¸Šä¼ æˆåŠŸï¼${result.instant ? 'ï¼ˆç§’ä¼ ï¼‰' : ''}`);
  } catch (error) {
    alert('ä¸Šä¼ å¤±è´¥: ' + error.message);
  }
});
```

---

## 4. é€šè¿‡UUIDè®¿é—®æ–‡ä»¶

### æ¥å£ä¿¡æ¯

- **URL**: `/api/storage/file/{uuid}`
- **æ–¹æ³•**: `GET`
- **éœ€è¦é‰´æƒ**: æ˜¯ï¼ˆBearer Tokenï¼‰

### åŠŸèƒ½è¯´æ˜

é€šè¿‡UUIDè®¿é—®æ–‡ä»¶ï¼Œç³»ç»Ÿä¼šï¼š
1. éªŒè¯ç”¨æˆ·Token
2. æ£€æŸ¥æƒé™è¡¨ï¼ˆ`file_access_permissions`ï¼‰
3. æŸ¥è¯¢UUIDæ˜ å°„è¡¨è·å–ç‰©ç†æ–‡ä»¶è·¯å¾„
4. ä»MinIOè¯»å–æ–‡ä»¶å¹¶è¿”å›æ–‡ä»¶æµ

### è·¯å¾„å‚æ•°

- `uuid`: æ–‡ä»¶çš„UUIDæ ‡è¯†ï¼ˆ36ä½UUIDå­—ç¬¦ä¸²ï¼‰

### è¯·æ±‚ç¤ºä¾‹

```bash
curl -X GET "http://localhost:8080/api/storage/file/f5f23929-1689-4b04-98e7-0073fac1eea4" \
  -H "Authorization: Bearer {access_token}"
```

### å“åº”

- **æˆåŠŸ**: è¿”å›æ–‡ä»¶æµï¼ˆäºŒè¿›åˆ¶æ•°æ®ï¼‰
  - Status: 200 OK
  - Content-Type: æ–‡ä»¶çš„MIMEç±»å‹
  - Content-Length: æ–‡ä»¶å¤§å°
  - Cache-Control: public, max-age=31536000
  
- **æ— æƒé™**: 
  ```json
  {
    "error": "æ— æƒè®¿é—®æ­¤æ–‡ä»¶"
  }
  ```
  - Status: 403 Forbidden
  
- **æ–‡ä»¶ä¸å­˜åœ¨**:
  ```json
  {
    "error": "æ–‡ä»¶ä¸å­˜åœ¨"
  }
  ```
  - Status: 404 Not Found

### Fetch API è°ƒç”¨ç¤ºä¾‹

```javascript
// è®¿é—®UUIDæ–‡ä»¶
async function accessFileByUuid(uuid) {
  const accessToken = localStorage.getItem('access_token');
  
  const response = await fetch(
    `http://localhost:8080/api/storage/file/${uuid}`,
    {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${accessToken}`
      }
    }
  );
  
  if (!response.ok) {
    if (response.status === 403) {
      throw new Error('æ— æƒè®¿é—®æ­¤æ–‡ä»¶');
    } else if (response.status === 404) {
      throw new Error('æ–‡ä»¶ä¸å­˜åœ¨');
    }
    throw new Error('è®¿é—®å¤±è´¥');
  }
  
  // è·å–æ–‡ä»¶blob
  const blob = await response.blob();
  return URL.createObjectURL(blob);
}

// åœ¨é¡µé¢ä¸­æ˜¾ç¤ºå›¾ç‰‡
async function displayImage(uuid) {
  try {
    const blobUrl = await accessFileByUuid(uuid);
    const img = document.createElement('img');
    img.src = blobUrl;
    document.body.appendChild(img);
  } catch (error) {
    console.error('æ˜¾ç¤ºå¤±è´¥:', error);
  }
}

// åœ¨è§†é¢‘æ ‡ç­¾ä¸­æ’­æ”¾
async function playVideo(uuid) {
  try {
    const blobUrl = await accessFileByUuid(uuid);
    const video = document.querySelector('video');
    video.src = blobUrl;
    video.play();
  } catch (error) {
    console.error('æ’­æ”¾å¤±è´¥:', error);
  }
}

// ç›´æ¥åœ¨imgæ ‡ç­¾ä¸­ä½¿ç”¨ï¼ˆéœ€è¦tokenåœ¨headerä¸­ï¼Œä»…æ”¯æŒfetchæ–¹å¼ï¼‰
function displayImageDirectly(uuid) {
  const img = document.querySelector('#preview-img');
  // æ³¨æ„ï¼šç›´æ¥åœ¨img.srcä¸­æ— æ³•ä¼ é€’Authorization header
  // å»ºè®®ä½¿ç”¨fetchè·å–blobåè½¬ä¸ºobjectURL
}
```

---

## 5. æ–‡ä»¶ç±»å‹å’Œå¤§å°é™åˆ¶

| æ–‡ä»¶ç±»å‹ | å¤§å°èŒƒå›´ | ä¸Šä¼ æ–¹å¼ | é¢„è§ˆæ”¯æŒ |
|---------|---------|---------|---------|
| å¤´åƒ | < 5MB | ä¸€æ¬¡æ€§Token | åœ¨çº¿é¢„è§ˆ |
| å›¾ç‰‡ | < 100MB | ä¸€æ¬¡æ€§Token | åœ¨çº¿é¢„è§ˆ |
| å›¾ç‰‡ï¼ˆå¤§ï¼‰ | 100MB - 15GB | ä¸€æ¬¡æ€§Token | ä»…ä¸‹è½½ |
| è§†é¢‘ | < 15GB | ä¸€æ¬¡æ€§Token | åœ¨çº¿é¢„è§ˆ |
| è§†é¢‘ï¼ˆå¤§ï¼‰ | 15GB - 30GB | ä¸€æ¬¡æ€§Token | ä»…ä¸‹è½½ |
| æ–‡æ¡£ | < 15GB | ä¸€æ¬¡æ€§Token | ä»…ä¸‹è½½ |
| è¶…å¤§æ–‡ä»¶ | 15GB - 30GB | é¢„ç­¾åURLï¼ˆåˆ†ç‰‡ï¼‰ | ä»…ä¸‹è½½ |

---

## å­˜å‚¨è·¯å¾„è§„èŒƒ

æŒ‰ç…§ `MinIO/data.md` è§„èŒƒï¼š

- **avatars**: `{user_id}.{ext}`
- **user-file**: `{user_id}/{type}/{timestamp}_{hash}_{filename}`
- **friends-file**: `{conversation_uuid}/{type}/{timestamp}_{hash}_{filename}`
- **group-file**: `{group_id}/{type}/{timestamp}_{hash}_{filename}`

typeåˆ†ç±»ï¼š
- `images/` - å›¾ç‰‡æ–‡ä»¶
- `videos/` - è§†é¢‘æ–‡ä»¶
- `files/` - æ–‡æ¡£æ–‡ä»¶

---

## é”™è¯¯å¤„ç†

```javascript
try {
  const result = await uploadFileComplete(file);
} catch (error) {
  if (error.message.includes('Tokenæ— æ•ˆ')) {
    // Tokenè¿‡æœŸæˆ–æ— æ•ˆ
    alert('è¯·é‡æ–°ç™»å½•');
  } else if (error.message.includes('æ–‡ä»¶å¤§å°è¶…è¿‡é™åˆ¶')) {
    // æ–‡ä»¶å¤ªå¤§
    alert('æ–‡ä»¶è¿‡å¤§ï¼Œæ— æ³•ä¸Šä¼ ');
  } else if (error.message.includes('å“ˆå¸Œä¸åŒ¹é…')) {
    // æ–‡ä»¶æŸå
    alert('æ–‡ä»¶å·²æŸåï¼Œè¯·é‡è¯•');
  } else {
    // å…¶ä»–é”™è¯¯
    alert('ä¸Šä¼ å¤±è´¥: ' + error.message);
  }
}
```

---

## æ³¨æ„äº‹é¡¹

1. **æ–‡ä»¶å“ˆå¸Œè®¡ç®—**ï¼šå¿…é¡»åœ¨å®¢æˆ·ç«¯è®¡ç®—SHA-256å“ˆå¸Œï¼Œç”¨äºå»é‡å’Œå®Œæ•´æ€§æ ¡éªŒ
2. **ä¸€æ¬¡æ€§Token**ï¼šæ¯ä¸ªTokenåªèƒ½ä½¿ç”¨ä¸€æ¬¡ï¼Œä½¿ç”¨åè‡ªåŠ¨å¤±æ•ˆ
3. **æœ‰æ•ˆæœŸ**ï¼šæ ¹æ®æ–‡ä»¶å¤§å°è‡ªåŠ¨åˆ†é…ï¼ˆ5åˆ†é’Ÿ-4å°æ—¶ï¼‰
4. **ç›´è¿ä¸Šä¼ **ï¼šå¤§æ–‡ä»¶ç›´è¿MinIOï¼Œä¸å ç”¨åç«¯å¸¦å®½
5. **ç§’ä¼ åŠŸèƒ½**ï¼šç›¸åŒå“ˆå¸Œçš„æ–‡ä»¶ä¼šè‡ªåŠ¨ç§’ä¼ ï¼ŒèŠ‚çœæ—¶é—´å’Œå¸¦å®½
6. **è¿›åº¦è·Ÿè¸ª**ï¼šå»ºè®®åœ¨å‰ç«¯æ˜¾ç¤ºä¸Šä¼ è¿›åº¦ï¼ˆä½¿ç”¨XMLHttpRequestæˆ–Fetchçš„progressäº‹ä»¶ï¼‰

---

## UUIDæ˜ å°„æœºåˆ¶è¯¦è§£

### è®¾è®¡åŸç†

é‡‡ç”¨**UUIDæ˜ å°„è¡¨ + æƒé™è¡¨**å®ç°è·¨ç”¨æˆ·æ–‡ä»¶å»é‡ï¼š

```
ç”¨æˆ·Aä¸Šä¼  test.jpg (å“ˆå¸Œ: abc123...)
  â”œâ”€ ç‰©ç†å­˜å‚¨: user-file/userA/images/xxx_abc123_test.jpg
  â”œâ”€ ç”ŸæˆUUID: f5f23929-1689-4b04-98e7-0073fac1eea4
  â”œâ”€ æ˜ å°„è¡¨è®°å½•: UUID â†’ ç‰©ç†è·¯å¾„
  â””â”€ æƒé™è¡¨è®°å½•: UUID + userA â†’ owner

ç”¨æˆ·Bä¸Šä¼ ç›¸åŒæ–‡ä»¶ test.jpg (å“ˆå¸Œ: abc123...)
  â”œâ”€ æŸ¥è¯¢åˆ°å·²å­˜åœ¨çš„UUID
  â”œâ”€ ç§’ä¼ ï¼šæ— éœ€é‡å¤ä¸Šä¼ ç‰©ç†æ–‡ä»¶
  â”œâ”€ æƒé™è¡¨è®°å½•: UUID + userB â†’ owner
  â””â”€ è¿”å›ç›¸åŒçš„UUIDè®¿é—®URL

è®¿é—®æµç¨‹ï¼š
  ç”¨æˆ·A/Bè®¿é—®: /api/storage/file/{uuid}
  â”œâ”€ éªŒè¯Token
  â”œâ”€ æŸ¥è¯¢æƒé™è¡¨ï¼ˆæ˜¯å¦æœ‰è®¿é—®æƒé™ï¼‰
  â”œâ”€ æŸ¥è¯¢æ˜ å°„è¡¨ï¼ˆè·å–ç‰©ç†è·¯å¾„ï¼‰
  â””â”€ ä»MinIOè¯»å–å¹¶è¿”å›æ–‡ä»¶æµ
```

### æ ¸å¿ƒä¼˜åŠ¿

1. **çœŸæ­£çš„è·¨ç”¨æˆ·å»é‡**
   - ç›¸åŒæ–‡ä»¶åªå­˜å‚¨ä¸€ä»½ç‰©ç†å‰¯æœ¬
   - èŠ‚çœå­˜å‚¨ç©ºé—´50-90%

2. **ç»Ÿä¸€çš„æƒé™æ§åˆ¶**
   - åŸºäºæ•°æ®åº“æƒé™è¡¨ï¼Œä¸ä¾èµ–MinIO bucketç­–ç•¥
   - æ”¯æŒçµæ´»çš„æƒé™æˆäºˆå’Œæ’¤é”€

3. **ç”¨æˆ·éš”ç¦»**
   - æ¯ä¸ªç”¨æˆ·æœ‰ç‹¬ç«‹çš„file_key
   - ä¸ä¼šæš´éœ²å…¶ä»–ç”¨æˆ·çš„æ–‡ä»¶è·¯å¾„

4. **è½¯åˆ é™¤æ”¯æŒ**
   - æ’¤é”€æƒé™æ—¶è®¾ç½®`revoked_at`
   - ç‰©ç†æ–‡ä»¶ä¿ç•™ç›´åˆ°æ‰€æœ‰æƒé™éƒ½è¢«æ’¤é”€

### æ•°æ®åº“è¡¨ç»“æ„

#### file_uuid_mappingï¼ˆUUIDæ˜ å°„è¡¨ï¼‰
| å­—æ®µ | è¯´æ˜ |
|------|------|
| uuid | éšæœºUUIDï¼Œè®¿é—®æ ‡è¯† |
| physical_file_key | å®é™…ç‰©ç†æ–‡ä»¶è·¯å¾„ |
| file_hash | SHA-256å“ˆå¸Œï¼ˆå»é‡æŸ¥è¯¢ï¼‰ |
| first_uploader_id | é¦–æ¬¡ä¸Šä¼ è€… |

#### file_access_permissionsï¼ˆæƒé™è¡¨ï¼‰
| å­—æ®µ | è¯´æ˜ |
|------|------|
| file_uuid | å…³è”UUID |
| user_id | æˆæƒç”¨æˆ· |
| access_type | owner/read |
| granted_by | upload/share/friend/group |
| revoked_at | è½¯åˆ é™¤æ—¶é—´ |

### æ€§èƒ½è€ƒé‡

- é¦–æ¬¡ä¸Šä¼ ï¼š1æ¬¡æ•°æ®åº“æŸ¥è¯¢ï¼ˆ< 2msï¼‰
- ç§’ä¼ ï¼š2æ¬¡æ•°æ®åº“å†™å…¥ï¼ˆ< 5msï¼‰
- æ–‡ä»¶è®¿é—®ï¼š2æ¬¡æ•°æ®åº“æŸ¥è¯¢ï¼ˆ< 8msï¼‰
- é«˜å¹¶å‘æ”¯æŒï¼šçº¦2000æ¬¡/ç§’æ–‡ä»¶è®¿é—®

---

## 5. ç”Ÿæˆæ–‡ä»¶é¢„ç­¾åURLï¼ˆæ™®é€šæ–‡ä»¶ï¼‰â­ æ–°å¢

### æ¥å£ä¿¡æ¯

- **URL**: `/api/storage/file/{uuid}/presigned_url`
- **æ–¹æ³•**: `POST`
- **éœ€è¦é‰´æƒ**: æ˜¯ï¼ˆBearer Tokenï¼‰

### åŠŸèƒ½è¯´æ˜

é€šè¿‡UUIDç”ŸæˆMinIOé¢„ç­¾åä¸‹è½½URLï¼Œå®ç°å®¢æˆ·ç«¯ç›´è¿MinIOä¸‹è½½/é¢„è§ˆæ–‡ä»¶ï¼Œå‡è½»åç«¯å‹åŠ›ã€‚

**é€‚ç”¨åœºæ™¯**ï¼š
- æ™®é€šæ–‡ä»¶ï¼ˆ< 15GBï¼‰
- å›¾ç‰‡åœ¨çº¿é¢„è§ˆ
- è§†é¢‘æµå¼æ’­æ”¾
- PDFåœ¨çº¿æŸ¥çœ‹

**æ ¸å¿ƒä¼˜åŠ¿**ï¼š
- âœ… å®¢æˆ·ç«¯ç›´è¿MinIOï¼Œåç«¯é›¶å‹åŠ›
- âœ… æ”¯æŒRangeè¯·æ±‚ï¼ˆè§†é¢‘æ‹–åŠ¨ï¼‰
- âœ… æµè§ˆå™¨å¯ç¼“å­˜
- âœ… çœŸæ­£çš„æµå¼æ’­æ”¾

### è¯·æ±‚å‚æ•°

**Path Parameter**:
- `uuid`: æ–‡ä»¶UUIDï¼ˆä»ä¸Šä¼ å“åº”ä¸­è·å–ï¼‰

**Request Body**:
```json
{
  "operation": "download",
  "expires_in": 10800
}
```

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| operation | string | å¦ | æ“ä½œç±»å‹ï¼š"download" æˆ– "preview"ï¼Œé»˜è®¤ "download" |
| expires_in | number | å¦ | æœ‰æ•ˆæœŸï¼ˆç§’ï¼‰ï¼Œé»˜è®¤10800ï¼ˆ3å°æ—¶ï¼‰ï¼Œæœ€å¤§10800 |

### å“åº”ç¤ºä¾‹

**æˆåŠŸå“åº”**:
```json
{
  "presigned_url": "http://localhost:9000/user-file/alice/images/xxx.jpg?X-Amz-Algorithm=AWS4-HMAC-SHA256&...",
  "expires_at": "2025-11-30T12:59:18+00:00",
  "file_uuid": "cb31fb54-770d-4198-84d6-18ce9c6d290f",
  "file_size": 1048576,
  "content_type": "image/jpeg",
  "warning": null
}
```

**é”™è¯¯å“åº”**:
```json
{
  "error": "æ— æƒè®¿é—®æ­¤æ–‡ä»¶"
}
```

### Fetch API è°ƒç”¨ç¤ºä¾‹ï¼ˆå®Œæ•´ç‰ˆï¼Œå¸¦è‡ªåŠ¨é‡è¯•ï¼‰

```javascript
// ==========================================
// å®Œæ•´çš„é¢„ç­¾åURLè·å–å‡½æ•°ï¼ˆç”Ÿäº§ç¯å¢ƒæ¨èï¼‰
// ==========================================

// å…¨å±€çŠ¶æ€ç®¡ç†
const state = {
  accessToken: localStorage.getItem('accessToken') || '',
  refreshToken: localStorage.getItem('refreshToken') || '',
  presignedUrls: {} // ç¼“å­˜é¢„ç­¾åURL: { uuid: { url, expiresAt, cachedAt } }
};

// åˆ·æ–°Access Token
async function refreshAccessToken() {
  if (!state.refreshToken) {
    throw new Error('ç¼ºå°‘ refresh_token');
  }
  
  const res = await fetch('http://localhost:8080/api/auth/refresh', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ refresh_token: state.refreshToken }),
  });
  
  const data = await res.json();
  if (res.ok && data.access_token) {
    state.accessToken = data.access_token;
    localStorage.setItem('accessToken', state.accessToken);
    console.log('âœ… Access Tokenåˆ·æ–°æˆåŠŸ');
  } else {
    throw new Error(data.error || 'Tokenåˆ·æ–°å¤±è´¥');
  }
}

// è§£ç JWT Token
function decodeJwt(token) {
  try {
    const [, payload] = token.split('.');
    const json = atob(payload.replace(/-/g, '+').replace(/_/g, '/'));
    return JSON.parse(json);
  } catch {
    return null;
  }
}

// è·å–é¢„ç­¾åURLï¼ˆå¸¦ç¼“å­˜ã€è‡ªåŠ¨é‡è¯•ã€Tokenåˆ·æ–°ï¼‰
async function getPresignedUrl(uuid, filename, retryCount = 0) {
  const MAX_RETRIES = 2;
  
  // 1. æ£€æŸ¥Tokenæ˜¯å¦å­˜åœ¨
  if (!state.accessToken) {
    throw new Error('æœªç™»å½•ï¼Œè¯·å…ˆç™»å½•');
  }
  
  // 2. æ£€æŸ¥Tokenæ˜¯å¦è¿‡æœŸ
  const claims = decodeJwt(state.accessToken);
  if (claims && claims.exp && claims.exp * 1000 < Date.now()) {
    console.log('ğŸ”„ Access Tokenå·²è¿‡æœŸï¼Œå°è¯•åˆ·æ–°...');
    try {
      await refreshAccessToken();
    } catch (e) {
      throw new Error('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
    }
  }
  
  // 3. æ£€æŸ¥ç¼“å­˜æ˜¯å¦æœ‰æ•ˆï¼ˆè¿‡æœŸå‰5åˆ†é’Ÿéœ€è¦åˆ·æ–°ï¼‰
  const cached = state.presignedUrls[uuid];
  if (cached && cached.expiresAt) {
    const expiresTime = new Date(cached.expiresAt);
    const now = new Date();
    const remainingMs = expiresTime - now;
    
    if (remainingMs > 5 * 60 * 1000) {
      console.log(`âœ… ä½¿ç”¨ç¼“å­˜çš„é¢„ç­¾åURLï¼Œå‰©ä½™: ${Math.floor(remainingMs / 60000)}åˆ†é’Ÿ`);
      return cached.url;
    } else if (remainingMs > 0) {
      console.log(`âš ï¸ URLå³å°†è¿‡æœŸï¼Œé‡æ–°è·å–ä¸­...`);
    } else {
      console.log('ğŸ”„ ç¼“å­˜çš„URLå·²è¿‡æœŸï¼Œé‡æ–°è·å–...');
      delete state.presignedUrls[uuid];
    }
  }
  
  // 4. æ£€æµ‹æ–‡ä»¶å¤§å°ï¼ˆè¶…å¤§æ–‡ä»¶éœ€è¦ç‰¹æ®Šå¤„ç†ï¼‰
  const fileInfo = getFileInfo(uuid); // ä»æœ¬åœ°å­˜å‚¨æˆ–çŠ¶æ€ä¸­è·å–
  const LARGE_FILE_THRESHOLD = 15 * 1024 * 1024 * 1024; // 15GB
  const isLargeFile = fileInfo && fileInfo.file_size > LARGE_FILE_THRESHOLD;
  
  let endpoint, body;
  
  if (isLargeFile) {
    // è¶…å¤§æ–‡ä»¶ï¼šæç¤ºç”¨æˆ·è¾“å…¥é¢„è®¡ä¸‹è½½æ—¶é—´
    const hours = prompt(
      `æ£€æµ‹åˆ°å¤§æ–‡ä»¶ï¼ˆ${formatFileSize(fileInfo.file_size)}ï¼‰\n` +
      `è¯·è¾“å…¥é¢„è®¡ä¸‹è½½æ—¶é—´ï¼ˆå°æ—¶ï¼Œæœ€å°‘3ï¼Œæœ€å¤š168ï¼‰:`,
      '6'
    );
    
    if (!hours || parseInt(hours) < 3) {
      throw new Error('å·²å–æ¶ˆæˆ–æ—¶é—´æ— æ•ˆï¼ˆæœ€å°‘3å°æ—¶ï¼‰');
    }
    
    const estimatedSeconds = Math.min(parseInt(hours) * 3600, 604800);
    endpoint = `http://localhost:8080/api/storage/file/${uuid}/presigned_url/extended`;
    body = { operation: 'download', estimated_download_time: estimatedSeconds };
  } else {
    // æ™®é€šæ–‡ä»¶ï¼š3å°æ—¶æœ‰æ•ˆæœŸ
    endpoint = `http://localhost:8080/api/storage/file/${uuid}/presigned_url`;
    body = { operation: 'download' };
  }
  
  // 5. è¯·æ±‚é¢„ç­¾åURL
  const response = await fetch(endpoint, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${state.accessToken}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(body)
  });
  
  // 6. é”™è¯¯å¤„ç†ï¼ˆæ”¯æŒè‡ªåŠ¨é‡è¯•ï¼‰
  if (!response.ok) {
    let errorMessage = 'è·å–ä¸‹è½½é“¾æ¥å¤±è´¥';
    
    try {
      const error = await response.json();
      errorMessage = error.error || errorMessage;
    } catch (e) {
      // å“åº”ä¸æ˜¯JSON
      if (response.status === 401) {
        // Tokenè¿‡æœŸï¼Œå°è¯•åˆ·æ–°å¹¶é‡è¯•
        if (retryCount < MAX_RETRIES) {
          console.log(`ğŸ”„ æ£€æµ‹åˆ°401é”™è¯¯ï¼Œåˆ·æ–°Tokenå¹¶é‡è¯• (${retryCount + 1}/${MAX_RETRIES})...`);
          try {
            await refreshAccessToken();
            return await getPresignedUrl(uuid, filename, retryCount + 1);
          } catch (refreshError) {
            errorMessage = 'ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•';
            state.accessToken = '';
            state.refreshToken = '';
            localStorage.removeItem('accessToken');
            localStorage.removeItem('refreshToken');
          }
        } else {
          errorMessage = 'ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•';
        }
      } else if (response.status === 403) {
        errorMessage = 'æ— æƒè®¿é—®æ­¤æ–‡ä»¶';
      } else if (response.status === 404) {
        errorMessage = 'æ–‡ä»¶ä¸å­˜åœ¨';
      } else {
        const text = await response.text().catch(() => '');
        errorMessage = `æœåŠ¡å™¨é”™è¯¯ (${response.status})${text ? ': ' + text.substring(0, 100) : ''}`;
      }
    }
    
    throw new Error(errorMessage);
  }
  
  const data = await response.json();
  
  // 7. ç¼“å­˜é¢„ç­¾åURL
  state.presignedUrls[uuid] = {
    url: data.presigned_url,
    expiresAt: data.expires_at,
    cachedAt: new Date().toISOString()
  };
  
  console.log(`âœ… è·å–æ–°çš„é¢„ç­¾åURLï¼Œè¿‡æœŸæ—¶é—´: ${data.expires_at}`);
  if (data.warning) {
    console.warn(`âš ï¸ ${data.warning}`);
  }
  
  return data.presigned_url;
}

// ==========================================
// åª’ä½“åŠ è½½é”™è¯¯è‡ªåŠ¨å¤„ç†ï¼ˆURLè¿‡æœŸè‡ªåŠ¨åˆ·æ–°ï¼‰
// ==========================================

// å¤„ç†å›¾ç‰‡/è§†é¢‘åŠ è½½å¤±è´¥ï¼ˆè‡ªåŠ¨é‡æ–°è·å–URLï¼‰
async function handleMediaError(event, uuid, filename, mediaElement) {
  console.warn('âš ï¸ åª’ä½“åŠ è½½å¤±è´¥ï¼Œæ£€æŸ¥URLæ˜¯å¦è¿‡æœŸ...');
  
  const cached = state.presignedUrls[uuid];
  if (cached && cached.expiresAt) {
    const expiresTime = new Date(cached.expiresAt);
    const now = new Date();
    
    if (now > expiresTime) {
      console.log('ğŸ”„ URLå·²è¿‡æœŸï¼Œè‡ªåŠ¨é‡æ–°è·å–...');
      try {
        // æ¸…é™¤è¿‡æœŸç¼“å­˜
        delete state.presignedUrls[uuid];
        
        // é‡æ–°è·å–é¢„ç­¾åURL
        const newUrl = await getPresignedUrl(uuid, filename);
        
        // æ›´æ–°åª’ä½“å…ƒç´ 
        if (mediaElement) {
          // ä¿å­˜å½“å‰æ’­æ”¾ä½ç½®ï¼ˆè§†é¢‘ï¼‰
          const currentTime = mediaElement.currentTime || 0;
          
          mediaElement.src = newUrl;
          
          // æ¢å¤æ’­æ”¾ä½ç½®ï¼ˆè§†é¢‘ï¼‰
          if (mediaElement.tagName === 'VIDEO' && currentTime > 0) {
            mediaElement.currentTime = currentTime;
          }
          
          mediaElement.load();
          console.log('âœ… URLå·²æ›´æ–°å¹¶é‡æ–°åŠ è½½');
        }
        
        return newUrl;
      } catch (error) {
        console.error('âŒ é‡æ–°è·å–URLå¤±è´¥:', error);
        throw error;
      }
    }
  }
  
  throw new Error('åª’ä½“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
}

// ==========================================
// ä½¿ç”¨ç¤ºä¾‹
// ==========================================

// ç¤ºä¾‹1ï¼šå›¾ç‰‡é¢„è§ˆï¼ˆå¸¦è‡ªåŠ¨é‡è¯•ï¼‰
async function previewImage(uuid, filename) {
  try {
    const presignedUrl = await getPresignedUrl(uuid, filename);
    
    const img = document.createElement('img');
    img.src = presignedUrl;
    img.alt = filename;
    
    // æ·»åŠ é”™è¯¯å¤„ç†ï¼šURLè¿‡æœŸæ—¶è‡ªåŠ¨åˆ·æ–°
    img.onerror = async () => {
      try {
        img.onerror = null; // é˜²æ­¢å¾ªç¯
        const newUrl = await handleMediaError(null, uuid, filename, img);
        img.src = newUrl;
      } catch (error) {
        console.error('å›¾ç‰‡åŠ è½½å¤±è´¥:', error);
        alert('å›¾ç‰‡åŠ è½½å¤±è´¥: ' + error.message);
      }
    };
    
    document.body.appendChild(img);
  } catch (error) {
    console.error('è·å–å›¾ç‰‡URLå¤±è´¥:', error);
    alert('è·å–å›¾ç‰‡å¤±è´¥: ' + error.message);
  }
}

// ç¤ºä¾‹2ï¼šè§†é¢‘æ’­æ”¾ï¼ˆå¸¦è‡ªåŠ¨é‡è¯•ï¼‰
async function playVideo(uuid, filename) {
  try {
    const presignedUrl = await getPresignedUrl(uuid, filename);
    
    const video = document.createElement('video');
    video.controls = true;
    video.style.width = '100%';
    
    const source = document.createElement('source');
    source.src = presignedUrl;
    source.type = 'video/mp4';
    video.appendChild(source);
    
    // æ·»åŠ é”™è¯¯å¤„ç†ï¼šURLè¿‡æœŸæ—¶è‡ªåŠ¨åˆ·æ–°
    video.onerror = async () => {
      try {
        video.onerror = null; // é˜²æ­¢å¾ªç¯
        const currentTime = video.currentTime || 0;
        const newUrl = await handleMediaError(null, uuid, filename, video);
        video.src = newUrl;
        video.currentTime = currentTime; // æ¢å¤æ’­æ”¾ä½ç½®
        video.load();
      } catch (error) {
        console.error('è§†é¢‘åŠ è½½å¤±è´¥:', error);
        alert('è§†é¢‘åŠ è½½å¤±è´¥: ' + error.message);
      }
    };
    
    document.body.appendChild(video);
    video.play();
  } catch (error) {
    console.error('è·å–è§†é¢‘URLå¤±è´¥:', error);
    alert('è·å–è§†é¢‘å¤±è´¥: ' + error.message);
  }
}

// ç¤ºä¾‹3ï¼šæ–‡ä»¶ä¸‹è½½
async function downloadFile(uuid, filename) {
  try {
    const presignedUrl = await getPresignedUrl(uuid, filename);
    
    const a = document.createElement('a');
    a.href = presignedUrl;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    
    console.log('âœ… ä¸‹è½½å·²å¼€å§‹');
  } catch (error) {
    console.error('ä¸‹è½½å¤±è´¥:', error);
    alert('ä¸‹è½½å¤±è´¥: ' + error.message);
  }
}

// è¾…åŠ©å‡½æ•°
function formatFileSize(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
  if (bytes < 1024 * 1024 * 1024) return (bytes / 1024 / 1024).toFixed(2) + ' MB';
  return (bytes / 1024 / 1024 / 1024).toFixed(2) + ' GB';
}

function getFileInfo(uuid) {
  // ä»localStorageæˆ–å…¨å±€çŠ¶æ€è·å–æ–‡ä»¶ä¿¡æ¯
  const uploadedFiles = JSON.parse(localStorage.getItem('uploadedFiles') || '[]');
  return uploadedFiles.find(f => f.file_url && f.file_url.includes(uuid));
}
```

### æ ¸å¿ƒç‰¹æ€§è¯´æ˜

#### âœ… **è‡ªåŠ¨Tokenåˆ·æ–°**
- æ£€æµ‹åˆ°Tokenè¿‡æœŸæ—¶è‡ªåŠ¨è°ƒç”¨refreshæ¥å£
- åˆ·æ–°æˆåŠŸåè‡ªåŠ¨é‡è¯•åŸè¯·æ±‚
- æœ€å¤šé‡è¯•2æ¬¡ï¼Œé¿å…æ— é™å¾ªç¯

#### âœ… **æ™ºèƒ½ç¼“å­˜ç®¡ç†**
- ç¼“å­˜é¢„ç­¾åURLï¼Œé¿å…é‡å¤è¯·æ±‚
- è¿‡æœŸå‰5åˆ†é’Ÿè‡ªåŠ¨åˆ·æ–°
- å·²è¿‡æœŸçš„URLè‡ªåŠ¨æ¸…é™¤

#### âœ… **URLè¿‡æœŸè‡ªåŠ¨æ¢å¤**
- åª’ä½“åŠ è½½å¤±è´¥æ—¶è‡ªåŠ¨æ£€æµ‹æ˜¯å¦URLè¿‡æœŸ
- è¿‡æœŸæ—¶è‡ªåŠ¨é‡æ–°è·å–æ–°URL
- è§†é¢‘æ’­æ”¾æ—¶ä¿ç•™å½“å‰æ’­æ”¾ä½ç½®

#### âœ… **å®Œå–„çš„é”™è¯¯å¤„ç†**
- åŒºåˆ†ä¸åŒHTTPçŠ¶æ€ç ï¼ˆ401/403/404ï¼‰
- å®‰å…¨è§£æéJSONå“åº”
- å‹å¥½çš„é”™è¯¯æç¤ºä¿¡æ¯

#### âœ… **æ”¯æŒè¶…å¤§æ–‡ä»¶**
- è‡ªåŠ¨æ£€æµ‹æ–‡ä»¶å¤§å°
- è¶…è¿‡15GBæ—¶æç¤ºç”¨æˆ·è¾“å…¥ä¸‹è½½æ—¶é—´
- ä½¿ç”¨æ‰©å±•æ¥å£è·å–æ›´é•¿æœ‰æ•ˆæœŸ

---

### ç®€åŒ–ç‰ˆè°ƒç”¨ç¤ºä¾‹ï¼ˆå¿«é€Ÿå¼€å§‹ï¼‰

```javascript
// è·å–é¢„ç­¾åURLï¼ˆå¸¦ç¼“å­˜ï¼‰
async function getPresignedUrl(uuid, filename) {
  const accessToken = localStorage.getItem('access_token');
  
  // 1. æ£€æŸ¥ç¼“å­˜
  const cached = presignedUrlCache[uuid];
  if (cached && new Date(cached.expiresAt) > new Date(Date.now() + 300000)) {
    return cached.url; // è¿˜æœ‰5åˆ†é’Ÿä»¥ä¸Šï¼Œä½¿ç”¨ç¼“å­˜
  }
  
  // 2. è¯·æ±‚æ–°çš„é¢„ç­¾åURL
  const response = await fetch(
    `http://localhost:8080/api/storage/file/${uuid}/presigned_url`,
    {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        operation: 'download'
      })
    }
  );
  
  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.error || 'è·å–é¢„ç­¾åURLå¤±è´¥');
  }
  
  const data = await response.json();
  
  // 3. ç¼“å­˜URL
  presignedUrlCache[uuid] = {
    url: data.presigned_url,
    expiresAt: data.expires_at
  };
  
  return data.presigned_url;
}

// å›¾ç‰‡é¢„è§ˆç¤ºä¾‹
async function previewImage(uuid, filename) {
  const presignedUrl = await getPresignedUrl(uuid, filename);
  
  // ç›´æ¥ä½¿ç”¨é¢„ç­¾åURLä½œä¸ºimg src
  const img = document.createElement('img');
  img.src = presignedUrl;
  img.alt = filename;
  document.body.appendChild(img);
}

// è§†é¢‘æ’­æ”¾ç¤ºä¾‹ï¼ˆçœŸæ­£çš„æµå¼æ’­æ”¾ï¼‰
async function playVideo(uuid, filename) {
  const presignedUrl = await getPresignedUrl(uuid, filename);
  
  // ç›´æ¥ä½¿ç”¨é¢„ç­¾åURLä½œä¸ºvideo src
  const video = document.createElement('video');
  video.controls = true;
  const source = document.createElement('source');
  source.src = presignedUrl;
  source.type = 'video/mp4';
  video.appendChild(source);
  document.body.appendChild(video);
  
  // æ”¯æŒæ‹–åŠ¨è¿›åº¦æ¡ï¼Œæ”¯æŒRangeè¯·æ±‚
}

// æ–‡ä»¶ä¸‹è½½ç¤ºä¾‹
async function downloadFile(uuid, filename) {
  const presignedUrl = await getPresignedUrl(uuid, filename);
  
  // ä½¿ç”¨é¢„ç­¾åURLä¸‹è½½
  const a = document.createElement('a');
  a.href = presignedUrl;
  a.download = filename;
  a.click();
}
```

### cURL è°ƒç”¨ç¤ºä¾‹

```bash
# è·å–é¢„ç­¾åURL
curl -X POST "http://localhost:8080/api/storage/file/cb31fb54-770d-4198-84d6-18ce9c6d290f/presigned_url" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"operation": "download"}'

# ä½¿ç”¨è¿”å›çš„é¢„ç­¾åURLç›´æ¥ä¸‹è½½ï¼ˆæ— éœ€Authorizationï¼‰
curl "http://localhost:9000/user-file/alice/images/xxx.jpg?X-Amz-Signature=..." \
  -o downloaded_file.jpg
```

### æ³¨æ„äº‹é¡¹

1. **æƒé™éªŒè¯**
   - ç”ŸæˆURLå‰ä¼šéªŒè¯ç”¨æˆ·æ˜¯å¦æœ‰è®¿é—®æƒé™
   - æ£€æŸ¥ `file_access_permissions` è¡¨
   - æ— æƒé™è¿”å›403é”™è¯¯

2. **æœ‰æ•ˆæœŸç®¡ç†**
   - æ™®é€šæ–‡ä»¶å›ºå®š3å°æ—¶æœ‰æ•ˆæœŸ
   - URLè¿‡æœŸåéœ€è¦é‡æ–°è¯·æ±‚
   - å»ºè®®è¿‡æœŸå‰5åˆ†é’Ÿæé†’ç”¨æˆ·åˆ·æ–°

3. **ç¼“å­˜ç­–ç•¥**
   - å‰ç«¯åº”ç¼“å­˜é¢„ç­¾åURL
   - é¿å…é‡å¤è¯·æ±‚
   - æ£€æŸ¥è¿‡æœŸæ—¶é—´

4. **å®‰å…¨è€ƒé‡**
   - URLåœ¨æœ‰æ•ˆæœŸå†…å¯è¢«ä»»ä½•äººè®¿é—®
   - ä¸è¦åˆ†äº«ç»™æœªæˆæƒç”¨æˆ·
   - è¿‡æœŸåè‡ªåŠ¨å¤±æ•ˆ

---

## 6. ç”Ÿæˆæ‰©å±•é¢„ç­¾åURLï¼ˆè¶…å¤§æ–‡ä»¶ï¼‰â­ æ–°å¢

### æ¥å£ä¿¡æ¯

- **URL**: `/api/storage/file/{uuid}/presigned_url/extended`
- **æ–¹æ³•**: `POST`
- **éœ€è¦é‰´æƒ**: æ˜¯ï¼ˆBearer Tokenï¼‰

### åŠŸèƒ½è¯´æ˜

ä¸ºè¶…å¤§æ–‡ä»¶ï¼ˆâ‰¥ 15GBï¼‰ç”Ÿæˆè‡ªå®šä¹‰æœ‰æ•ˆæœŸçš„é¢„ç­¾åURLã€‚

**é€‚ç”¨åœºæ™¯**ï¼š
- å¤§å‹è§†é¢‘æ–‡ä»¶ï¼ˆ> 15GBï¼‰
- æ…¢é€Ÿç½‘ç»œä¸‹è½½
- éœ€è¦é•¿æ—¶é—´è®¿é—®çš„æ–‡ä»¶

### è¯·æ±‚å‚æ•°

**Path Parameter**:
- `uuid`: æ–‡ä»¶UUID

**Request Body**:
```json
{
  "operation": "download",
  "estimated_download_time": 86400
}
```

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| operation | string | å¦ | æ“ä½œç±»å‹ |
| estimated_download_time | number | æ˜¯ | é¢„è®¡ä¸‹è½½æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œæœ€å°‘10800ï¼ˆ3å°æ—¶ï¼‰ï¼Œæœ€å¤š604800ï¼ˆ7å¤©ï¼‰ |

### å“åº”ç¤ºä¾‹

```json
{
  "presigned_url": "http://localhost:9000/user-file/xxx?X-Amz-Signature=...",
  "expires_at": "2025-12-01T16:00:00+00:00",
  "file_uuid": "...",
  "file_size": 30000000000,
  "content_type": "video/mp4",
  "warning": "æ­¤é“¾æ¥å°†åœ¨24å°æ—¶åè¿‡æœŸ"
}
```

### Fetch API è°ƒç”¨ç¤ºä¾‹

```javascript
// è¶…å¤§æ–‡ä»¶é¢„ç­¾åURLè¯·æ±‚
async function getLargeFilePresignedUrl(uuid, filename, fileSize) {
  const accessToken = localStorage.getItem('access_token');
  
  // æ£€æµ‹æ˜¯å¦ä¸ºè¶…å¤§æ–‡ä»¶ï¼ˆ15GBé˜ˆå€¼ï¼‰
  const LARGE_FILE_THRESHOLD = 15 * 1024 * 1024 * 1024;
  
  if (fileSize >= LARGE_FILE_THRESHOLD) {
    // æç¤ºç”¨æˆ·è¾“å…¥é¢„è®¡ä¸‹è½½æ—¶é—´
    const hours = prompt(
      `æ£€æµ‹åˆ°å¤§æ–‡ä»¶ï¼ˆ${formatFileSize(fileSize)}ï¼‰\nè¯·è¾“å…¥é¢„è®¡ä¸‹è½½æ—¶é—´ï¼ˆå°æ—¶ï¼Œæœ€å°‘3ï¼Œæœ€å¤š168ï¼‰:`,
      '6'
    );
    
    if (!hours || parseInt(hours) < 3) {
      throw new Error('å·²å–æ¶ˆæˆ–æ—¶é—´æ— æ•ˆ');
    }
    
    const estimatedSeconds = Math.min(parseInt(hours) * 3600, 604800);
    
    const response = await fetch(
      `http://localhost:8080/api/storage/file/${uuid}/presigned_url/extended`,
      {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${accessToken}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          operation: 'download',
          estimated_download_time: estimatedSeconds
        })
      }
    );
    
    const data = await response.json();
    if (data.warning) {
      console.warn(data.warning);
    }
    
    return data.presigned_url;
  }
}
```

### æ³¨æ„äº‹é¡¹

1. **æ—¶é—´é™åˆ¶**
   - æœ€å°‘ï¼š3å°æ—¶ï¼ˆ10800ç§’ï¼‰
   - æœ€å¤šï¼š7å¤©ï¼ˆ604800ç§’ï¼‰
   - è¶…å‡ºèŒƒå›´è¿”å›é”™è¯¯

2. **ç”¨æˆ·ä½“éªŒ**
   - éœ€è¦ç”¨æˆ·æ‰‹åŠ¨è¾“å…¥ä¸‹è½½æ—¶é—´
   - æä¾›åˆç†çš„é»˜è®¤å€¼å»ºè®®
   - æ˜¾ç¤ºè­¦å‘Šä¿¡æ¯

3. **æ–‡ä»¶å¤§å°é˜ˆå€¼**
   - å»ºè®®15GBä½œä¸ºåˆ†ç•Œçº¿
   - æ™®é€šæ–‡ä»¶ä½¿ç”¨æ ‡å‡†æ¥å£
   - è¶…å¤§æ–‡ä»¶ä½¿ç”¨æ‰©å±•æ¥å£

---

## é¢„ç­¾åURL vs UUIDç›´æ¥è®¿é—®å¯¹æ¯”

| ç‰¹æ€§ | UUIDç›´æ¥è®¿é—® | é¢„ç­¾åURL |
|------|-------------|-----------|
| **åç«¯å‹åŠ›** | âš ï¸ æ‰€æœ‰æµé‡ç»è¿‡åç«¯ | âœ… ç›´è¿MinIOï¼Œé›¶å‹åŠ› |
| **è§†é¢‘æ’­æ”¾** | âŒ éœ€å®Œæ•´ä¸‹è½½ | âœ… çœŸæ­£æµå¼ï¼Œå¯æ‹–åŠ¨ |
| **Rangeè¯·æ±‚** | âŒ ä¸æ”¯æŒ | âœ… æ”¯æŒ |
| **æµè§ˆå™¨ç¼“å­˜** | âŒ ä¸å¯ç¼“å­˜ | âœ… å¯ç¼“å­˜ |
| **æƒé™éªŒè¯** | âœ… å®æ—¶éªŒè¯ | âš ï¸ æ—¶æ•ˆæ€§éªŒè¯ |
| **å®‰å…¨æ€§** | âœ… å¯éšæ—¶æ’¤é”€ | âš ï¸ è¿‡æœŸå‰æœ‰æ•ˆ |
| **ä»£ç å¤æ‚åº¦** | å¤æ‚ | ç®€å• |

**æ¨èä½¿ç”¨é¢„ç­¾åURL**ç”¨äºï¼š
- å›¾ç‰‡/è§†é¢‘é¢„è§ˆ
- å¤§æ–‡ä»¶ä¸‹è½½
- éœ€è¦æµå¼æ’­æ”¾çš„åœºæ™¯

**UUIDç›´æ¥è®¿é—®å·²åºŸå¼ƒ**ï¼Œå»ºè®®å…¨éƒ¨ä½¿ç”¨é¢„ç­¾åURLæ–¹æ¡ˆã€‚

---

## 7. æŸ¥è¯¢ä¸ªäººæ–‡ä»¶åˆ—è¡¨ â­ æ–°å¢

### æ¥å£ä¿¡æ¯

- **URL**: `/api/storage/files`
- **æ–¹æ³•**: `GET`
- **éœ€è¦é‰´æƒ**: æ˜¯ï¼ˆBearer Tokenï¼‰

### åŠŸèƒ½è¯´æ˜

æŸ¥è¯¢å½“å‰ç”¨æˆ·æœ‰æƒè®¿é—®çš„æ‰€æœ‰æ–‡ä»¶åˆ—è¡¨ï¼Œæ”¯æŒåˆ†é¡µã€æ’åºåŠŸèƒ½ã€‚åŸºäºæƒé™è¡¨æŸ¥è¯¢ï¼Œåªè¿”å›ç”¨æˆ·æœ‰è®¿é—®æƒé™çš„æ–‡ä»¶ã€‚

**é€‚ç”¨åœºæ™¯**ï¼š
- ä¸ªäººæ–‡ä»¶ç®¡ç†é¡µé¢
- å†å²ä¸Šä¼ è®°å½•æŸ¥è¯¢
- å­˜å‚¨ç©ºé—´ä½¿ç”¨ç»Ÿè®¡
- æ–‡ä»¶æ‰¹é‡ç®¡ç†

### è¯·æ±‚å‚æ•°

Query Parameters:

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| page | number | å¦ | é¡µç ï¼ˆä»1å¼€å§‹ï¼‰ï¼Œé»˜è®¤1 |
| limit | number | å¦ | æ¯é¡µæ•°é‡ï¼Œé»˜è®¤20ï¼Œæœ€å¤§100 |
| sort_by | string | å¦ | æ’åºå­—æ®µï¼šcreated_atï¼ˆé»˜è®¤ï¼‰ã€file_size |
| sort_order | string | å¦ | æ’åºæ–¹å‘ï¼šdescï¼ˆé»˜è®¤ï¼‰ã€asc |

### å“åº”ç¤ºä¾‹

**æˆåŠŸå“åº”**:
```json
{
  "files": [
    {
      "file_uuid": "f5f23929-1689-4b04-98e7-0073fac1eea4",
      "filename": "example.jpg",
      "file_size": 1048576,
      "content_type": "image/jpeg",
      "preview_support": "inline_preview",
      "created_at": "2025-11-30T10:00:00Z",
      "file_url": "http://localhost:8080/api/storage/file/f5f23929-1689-4b04-98e7-0073fac1eea4"
    },
    {
      "file_uuid": "a3c2e1f0-2345-4567-89ab-cdef01234567",
      "filename": "video.mp4",
      "file_size": 52428800,
      "content_type": "video/mp4",
      "preview_support": "inline_preview",
      "created_at": "2025-11-30T09:30:00Z",
      "file_url": "http://localhost:8080/api/storage/file/a3c2e1f0-2345-4567-89ab-cdef01234567"
    }
  ],
  "total": 45,
  "page": 1,
  "page_size": 20,
  "total_pages": 3,
  "has_more": true
}
```

**ç©ºåˆ—è¡¨å“åº”**:
```json
{
  "files": [],
  "total": 0,
  "page": 1,
  "page_size": 20,
  "total_pages": 0,
  "has_more": false
}
```

### Fetch API è°ƒç”¨ç¤ºä¾‹

```javascript
// æŸ¥è¯¢æ–‡ä»¶åˆ—è¡¨ï¼ˆåŸºç¡€ï¼‰
async function listUserFiles() {
  const accessToken = localStorage.getItem('access_token');
  
  const response = await fetch('http://localhost:8080/api/storage/files', {
    method: 'GET',
    headers: {
      'Authorization': `Bearer ${accessToken}`
    }
  });
  
  if (!response.ok) {
    throw new Error('æŸ¥è¯¢å¤±è´¥');
  }
  
  const data = await response.json();
  console.log(`å…± ${data.total} ä¸ªæ–‡ä»¶`);
  return data;
}

// æŸ¥è¯¢æ–‡ä»¶åˆ—è¡¨ï¼ˆå¸¦åˆ†é¡µå’Œæ’åºï¼‰
async function listUserFilesWithParams(page = 1, limit = 20, sortBy = 'created_at', sortOrder = 'desc') {
  const accessToken = localStorage.getItem('access_token');
  
  const params = new URLSearchParams({
    page: page.toString(),
    limit: limit.toString(),
    sort_by: sortBy,
    sort_order: sortOrder
  });
  
  const response = await fetch(
    `http://localhost:8080/api/storage/files?${params}`,
    {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${accessToken}`
      }
    }
  );
  
  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.error || 'æŸ¥è¯¢å¤±è´¥');
  }
  
  return await response.json();
}

// ä½¿ç”¨ç¤ºä¾‹1ï¼šæŸ¥è¯¢ç¬¬ä¸€é¡µ
async function example1() {
  try {
    const result = await listUserFiles();
    console.log('æ–‡ä»¶åˆ—è¡¨:', result.files);
    console.log(`ç¬¬ ${result.page}/${result.total_pages} é¡µ`);
  } catch (error) {
    console.error('æŸ¥è¯¢å¤±è´¥:', error);
  }
}

// ä½¿ç”¨ç¤ºä¾‹2ï¼šæŸ¥è¯¢ç¬¬2é¡µï¼ŒæŒ‰æ–‡ä»¶å¤§å°é™åº
async function example2() {
  try {
    const result = await listUserFilesWithParams(2, 20, 'file_size', 'desc');
    result.files.forEach(file => {
      console.log(`${file.filename}: ${formatFileSize(file.file_size)}`);
    });
  } catch (error) {
    console.error('æŸ¥è¯¢å¤±è´¥:', error);
  }
}

// ä½¿ç”¨ç¤ºä¾‹3ï¼šåˆ†é¡µåŠ è½½ï¼ˆæ— é™æ»šåŠ¨ï¼‰
async function loadMoreFiles() {
  let page = 1;
  let allFiles = [];
  
  while (true) {
    const result = await listUserFilesWithParams(page, 50);
    allFiles = allFiles.concat(result.files);
    
    console.log(`å·²åŠ è½½ ${allFiles.length}/${result.total} ä¸ªæ–‡ä»¶`);
    
    if (!result.has_more) {
      break;
    }
    
    page++;
  }
  
  return allFiles;
}

// è¾…åŠ©å‡½æ•°ï¼šæ ¼å¼åŒ–æ–‡ä»¶å¤§å°
function formatFileSize(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
  if (bytes < 1024 * 1024 * 1024) return (bytes / 1024 / 1024).toFixed(2) + ' MB';
  return (bytes / 1024 / 1024 / 1024).toFixed(2) + ' GB';
}
```

### cURL è°ƒç”¨ç¤ºä¾‹

```bash
# æŸ¥è¯¢ç¬¬ä¸€é¡µï¼ˆé»˜è®¤å‚æ•°ï¼‰
curl -X GET "http://localhost:8080/api/storage/files" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"

# æŸ¥è¯¢ç¬¬2é¡µï¼Œæ¯é¡µ10æ¡
curl -X GET "http://localhost:8080/api/storage/files?page=2&limit=10" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"

# æŒ‰æ–‡ä»¶å¤§å°é™åºæ’åº
curl -X GET "http://localhost:8080/api/storage/files?sort_by=file_size&sort_order=desc" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"

# ç»„åˆæŸ¥è¯¢ï¼šç¬¬3é¡µï¼Œæ¯é¡µ50æ¡ï¼ŒæŒ‰åˆ›å»ºæ—¶é—´å‡åº
curl -X GET "http://localhost:8080/api/storage/files?page=3&limit=50&sort_by=created_at&sort_order=asc" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"
```

### å“åº”å­—æ®µè¯´æ˜

#### FileItem å­—æ®µ

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| file_uuid | string | æ–‡ä»¶UUIDæ ‡è¯†ï¼Œç”¨äºè®¿é—®æ–‡ä»¶ |
| filename | string | åŸå§‹æ–‡ä»¶å |
| file_size | number | æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰ |
| content_type | string | MIMEç±»å‹ |
| preview_support | string | é¢„è§ˆæ”¯æŒï¼šinline_preview æˆ– download_only |
| created_at | string | åˆ›å»ºæ—¶é—´ï¼ˆISO 8601æ ¼å¼ï¼‰ |
| file_url | string | æ–‡ä»¶è®¿é—®URLï¼ˆUUIDæ ¼å¼ï¼‰ |

#### åˆ†é¡µå­—æ®µ

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| files | array | æ–‡ä»¶åˆ—è¡¨ |
| total | number | æ€»æ–‡ä»¶æ•° |
| page | number | å½“å‰é¡µç  |
| page_size | number | æ¯é¡µæ•°é‡ |
| total_pages | number | æ€»é¡µæ•° |
| has_more | boolean | æ˜¯å¦è¿˜æœ‰æ›´å¤šæ•°æ® |

### æ³¨æ„äº‹é¡¹

1. **æƒé™è¿‡æ»¤**
   - åªè¿”å›ç”¨æˆ·æœ‰æƒè®¿é—®çš„æ–‡ä»¶
   - åŸºäº `file_access_permissions` è¡¨æŸ¥è¯¢
   - å·²æ’¤é”€æƒé™çš„æ–‡ä»¶ä¸ä¼šå‡ºç°

2. **åˆ†é¡µé™åˆ¶**
   - æœ€å°é¡µç ï¼š1
   - æœ€å°æ¯é¡µæ•°é‡ï¼š1
   - æœ€å¤§æ¯é¡µæ•°é‡ï¼š100
   - è¶…å‡ºèŒƒå›´ä¼šè‡ªåŠ¨è°ƒæ•´

3. **æ’åºå­—æ®µ**
   - `created_at`ï¼šæŒ‰åˆ›å»ºæ—¶é—´æ’åºï¼ˆé»˜è®¤ï¼‰
   - `file_size`ï¼šæŒ‰æ–‡ä»¶å¤§å°æ’åº
   - å…¶ä»–å€¼ä¼šä½¿ç”¨é»˜è®¤æ’åº

4. **æ€§èƒ½ä¼˜åŒ–**
   - æ•°æ®åº“å·²å»ºç«‹ç´¢å¼•ï¼ŒæŸ¥è¯¢æ€§èƒ½è‰¯å¥½
   - å»ºè®®æ¯é¡µ20-50æ¡ï¼Œé¿å…ä¸€æ¬¡åŠ è½½è¿‡å¤š
   - ä½¿ç”¨ `has_more` å­—æ®µåˆ¤æ–­æ˜¯å¦éœ€è¦ç»§ç»­åŠ è½½

5. **æ–‡ä»¶è®¿é—®**
   - è¿”å›çš„ `file_url` æ˜¯UUIDæ ¼å¼
   - éœ€è¦é…åˆé¢„ç­¾åURLæ¥å£è·å–å®é™…ä¸‹è½½é“¾æ¥
   - æˆ–ç›´æ¥ä½¿ç”¨UUIDè®¿é—®æ¥å£

### é”™è¯¯å¤„ç†

```javascript
async function listFilesWithErrorHandling() {
  try {
    const accessToken = localStorage.getItem('access_token');
    
    if (!accessToken) {
      throw new Error('æœªç™»å½•ï¼Œè¯·å…ˆç™»å½•');
    }
    
    const response = await fetch('http://localhost:8080/api/storage/files', {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${accessToken}`
      }
    });
    
    if (!response.ok) {
      if (response.status === 401) {
        throw new Error('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
      } else if (response.status === 500) {
        throw new Error('æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
      } else {
        const error = await response.json();
        throw new Error(error.error || 'æŸ¥è¯¢å¤±è´¥');
      }
    }
    
    return await response.json();
    
  } catch (error) {
    console.error('æŸ¥è¯¢æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', error);
    throw error;
  }
}
```

### å®Œæ•´çš„UIé›†æˆç¤ºä¾‹

```javascript
// Vue.js ç¤ºä¾‹
export default {
  data() {
    return {
      files: [],
      loading: false,
      currentPage: 1,
      pageSize: 20,
      total: 0,
      sortBy: 'created_at',
      sortOrder: 'desc',
    };
  },
  
  computed: {
    totalPages() {
      return Math.ceil(this.total / this.pageSize);
    }
  },
  
  methods: {
    async loadFiles() {
      this.loading = true;
      
      try {
        const accessToken = localStorage.getItem('access_token');
        const params = new URLSearchParams({
          page: this.currentPage.toString(),
          limit: this.pageSize.toString(),
          sort_by: this.sortBy,
          sort_order: this.sortOrder,
        });
        
        const response = await fetch(
          `http://localhost:8080/api/storage/files?${params}`,
          {
            headers: {
              'Authorization': `Bearer ${accessToken}`
            }
          }
        );
        
        const data = await response.json();
        this.files = data.files;
        this.total = data.total;
        
      } catch (error) {
        console.error('åŠ è½½å¤±è´¥:', error);
        alert('åŠ è½½æ–‡ä»¶åˆ—è¡¨å¤±è´¥');
      } finally {
        this.loading = false;
      }
    },
    
    changePage(page) {
      this.currentPage = page;
      this.loadFiles();
    },
    
    changeSort(field) {
      if (this.sortBy === field) {
        this.sortOrder = this.sortOrder === 'asc' ? 'desc' : 'asc';
      } else {
        this.sortBy = field;
        this.sortOrder = 'desc';
      }
      this.currentPage = 1;
      this.loadFiles();
    }
  },
  
  mounted() {
    this.loadFiles();
  }
};
```

---

