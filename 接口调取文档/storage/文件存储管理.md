# æ–‡ä»¶å­˜å‚¨ç®¡ç† API

## åŸºç¡€ä¿¡æ¯

**åŸºç¡€URL**: `http://localhost/api/storage`ï¼ˆé€šè¿‡Nginxä»£ç†ï¼‰

## æ¦‚è¿°

ç»Ÿä¸€æ–‡ä»¶å­˜å‚¨ç®¡ç†æ¥å£ï¼Œæ”¯æŒæ–‡ä»¶ä¸Šä¼ ã€ä¸‹è½½ã€é¢„è§ˆåŠŸèƒ½ã€‚**æ‰€æœ‰æ–‡ä»¶ä¸Šä¼ å‡ä½¿ç”¨é¢„ç­¾ååˆ†ç‰‡ä¸Šä¼ ç›´ä¼ MinIO**ï¼Œåç«¯ä¸å‚ä¸æ•°æ®ä¼ è¾“ï¼Œå®Œç¾æ”¯æŒ Cloudflare ä»£ç†ï¼ˆæ¯ä¸ªåˆ†ç‰‡ < 100MBï¼‰ã€‚

**âœ¨ UUIDæ˜ å°„æœºåˆ¶**ï¼šé‡‡ç”¨UUIDæ˜ å°„+æƒé™è¡¨å®ç°è·¨ç”¨æˆ·æ–‡ä»¶å»é‡ï¼Œç›¸åŒæ–‡ä»¶åªå­˜å‚¨ä¸€ä»½ç‰©ç†å‰¯æœ¬ã€‚

**âš¡ é‡‡æ ·å“ˆå¸Œ**ï¼šå°æ–‡ä»¶å®Œæ•´å“ˆå¸Œï¼Œå¤§æ–‡ä»¶é‡‡æ ·å“ˆå¸Œï¼ˆå…ƒä¿¡æ¯+å¼€å¤´/ä¸­é—´/ç»“å°¾å„10MBï¼‰ï¼Œé¿å…æµè§ˆå™¨å†…å­˜æº¢å‡ºã€‚

**ğŸš€ é¢„ç­¾ååˆ†ç‰‡ä¸Šä¼ **ï¼šå®¢æˆ·ç«¯ç›´è¿MinIOä¸Šä¼ å’Œä¸‹è½½ï¼Œæ”¯æŒè§†é¢‘æµå¼æ’­æ”¾ã€Rangeè¯·æ±‚ã€æ–­ç‚¹ç»­ä¼ ã€‚åˆ†ç‰‡å¤§å° 90MBï¼Œå®Œç¾å…¼å®¹ Cloudflare 100MB é™åˆ¶ã€‚

## æ ¸å¿ƒåŠŸèƒ½

- âœ… **UUIDæ˜ å°„å»é‡**ï¼ˆç§’ä¼ ï¼Œè·¨ç”¨æˆ·ç”Ÿæ•ˆï¼‰
- âœ… **é‡‡æ ·å“ˆå¸Œè®¡ç®—**ï¼ˆé¿å…å¤§æ–‡ä»¶å†…å­˜æº¢å‡ºï¼‰
- âœ… **é¢„ç­¾ååˆ†ç‰‡ä¸Šä¼ **ï¼ˆç»Ÿä¸€ä½¿ç”¨ï¼Œåˆ†ç‰‡å¤§å° 90MBï¼‰
- âœ… **ä¸Šä¼ ç¡®è®¤æœºåˆ¶**ï¼ˆconfirmæ¥å£ç¡®è®¤æ–‡ä»¶å®Œæ•´æ€§ï¼‰
- âœ… é¢„ç­¾åURLä¸‹è½½ï¼ˆç›´è¿MinIOï¼Œ3å°æ—¶-7å¤©æœ‰æ•ˆï¼‰
- âœ… åŸºäºæƒé™è¡¨çš„è®¿é—®æ§åˆ¶
- âœ… æ™ºèƒ½æœ‰æ•ˆæœŸç®¡ç†
- âœ… **Cloudflare å‹å¥½**ï¼ˆæ¯ä¸ªè¯·æ±‚ < 100MBï¼‰

---

## 1. è¯·æ±‚æ–‡ä»¶ä¸Šä¼ 

### æ¥å£ä¿¡æ¯

- **URL**: `/api/storage/upload/request`
- **æ–¹æ³•**: `POST`
- **éœ€è¦é‰´æƒ**: æ˜¯ï¼ˆBearer Tokenï¼‰

### è¯·æ±‚å‚æ•°

```json
{
  "file_type": "user_image",
  "storage_location": "user_files",
  "related_id": null,
  "filename": "example.jpg",
  "file_size": 6400000,
  "content_type": "image/jpeg",
  "file_hash": "abc123...",
  "force_upload": false,
  "estimated_upload_time": 3600
}
```

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| file_type | string | æ˜¯ | æ–‡ä»¶ç±»å‹ï¼šuser_image, user_video, user_document, friend_imageç­‰ |
| storage_location | string | æ˜¯ | å­˜å‚¨ä½ç½®ï¼šuser_files, friend_messages, group_files, avatars |
| related_id | string | å¦ | å…³è”IDï¼ˆå¥½å‹IDæˆ–ç¾¤IDï¼‰ |
| filename | string | æ˜¯ | åŸå§‹æ–‡ä»¶å |
| file_size | number | æ˜¯ | æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰ |
| content_type | string | æ˜¯ | MIMEç±»å‹ |
| file_hash | string | å¦ | é‡‡æ ·SHA-256å“ˆå¸Œå€¼ï¼ˆ64ä½åå…­è¿›åˆ¶ï¼‰ï¼Œå°æ–‡ä»¶å®Œæ•´å“ˆå¸Œï¼Œå¤§æ–‡ä»¶é‡‡æ ·å“ˆå¸Œ |
| force_upload | boolean | å¦ | æ˜¯å¦å¼ºåˆ¶ä¸Šä¼ ï¼ˆè·³è¿‡ç§’ä¼ ï¼‰ï¼Œé»˜è®¤false |
| estimated_upload_time | number | å¦ | é¢„è®¡ä¸Šä¼ æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œä»…è¶…å¤§æ–‡ä»¶éœ€è¦ |

**file_hashè¯´æ˜**ï¼š
- å°æ–‡ä»¶ï¼ˆ< 30MBï¼‰ï¼šè®¡ç®—å®Œæ•´SHA-256å“ˆå¸Œ
- å¤§æ–‡ä»¶ï¼ˆâ‰¥ 30MBï¼‰ï¼šé‡‡æ ·å“ˆå¸Œç­–ç•¥
  - æ–‡ä»¶å…ƒä¿¡æ¯ï¼ˆæ–‡ä»¶å+å¤§å°+ä¿®æ”¹æ—¶é—´+ç±»å‹ï¼‰
  - å¼€å¤´10MBæ•°æ®
  - ä¸­é—´10MBæ•°æ®
  - ç»“å°¾10MBæ•°æ®
  - åˆå¹¶è®¡ç®—SHA-256
- ä¼˜åŠ¿ï¼šé¿å…æµè§ˆå™¨å†…å­˜æº¢å‡ºï¼Œ3GBè§†é¢‘ä¹Ÿèƒ½å¿«é€Ÿè®¡ç®—å“ˆå¸Œ

### å“åº”ç¤ºä¾‹

**æˆåŠŸå“åº”ï¼ˆåˆ†ç‰‡ä¸Šä¼ ï¼‰**:
```json
{
  "mode": "multipart",
  "preview_support": "inline_preview",
  "multipart_upload_id": "upload-id-xxx",
  "expires_in": 3600,
  "chunk_size": 94371840,
  "total_chunks": 1,
  "file_key": "user_id/images/timestamp_hash_filename.jpg",
  "max_file_size": 107374182400,
  "instant_upload": false,
  "existing_file_url": null
}
```

> **è¯´æ˜**: `chunk_size` ä¸º 90MB (94371840 å­—èŠ‚)ï¼Œ`total_chunks` ä¸ºæ€»åˆ†ç‰‡æ•°ã€‚å®¢æˆ·ç«¯éœ€è¦å¾ªç¯è·å–æ¯ä¸ªåˆ†ç‰‡çš„é¢„ç­¾åURLå¹¶ä¸Šä¼ ã€‚

**ç§’ä¼ å“åº”ï¼ˆUUIDæ˜ å°„ï¼‰**:
```json
{
  "mode": "multipart",
  "preview_support": "inline_preview",
  "multipart_upload_id": null,
  "expires_in": null,
  "chunk_size": null,
  "total_chunks": null,
  "file_key": "user_id/images/...",
  "max_file_size": 0,
  "instant_upload": true,
  "existing_file_url": "http://localhost/api/storage/file/{uuid}"
}
```

**ç§’ä¼ å“åº”ï¼ˆå¥½å‹æ–‡ä»¶ - è‡ªåŠ¨å‘é€æ¶ˆæ¯ï¼‰ï¼š**
```json
{
  "mode": "multipart",
  "preview_support": "inline_preview",
  "multipart_upload_id": null,
  "expires_in": null,
  "chunk_size": null,
  "total_chunks": null,
  "max_file_size": 0,
  "instant_upload": true,
  "existing_file_url": "http://localhost/api/storage/file/{uuid}",
  "file_key": "conv-user1-user2/images/...",
  "message_uuid": "81e2705b-7c9b-44f5-af92-2b654c850d11",
  "message_send_time": "2025-12-03T06:36:51.382515670+00:00"
}
```

> **é‡è¦**: è¿”å›çš„ `existing_file_url` æ˜¯UUIDæ ¼å¼çš„è®¿é—®è·¯å¾„ï¼Œä¸æ˜¯MinIOç›´è¿è·¯å¾„ã€‚
> è¿™æ ·å¯ä»¥å®ç°è·¨ç”¨æˆ·å»é‡ï¼Œç›¸åŒæ–‡ä»¶åªå­˜å‚¨ä¸€ä»½ã€‚

> **å¥½å‹æ–‡ä»¶ç§’ä¼ **ï¼šå½“ `storage_location` ä¸º `friend_messages` ä¸”è§¦å‘ç§’ä¼ æ—¶ï¼š
> - è‡ªåŠ¨åœ¨èŠå¤©è®°å½•ä¸­æ’å…¥æ–‡ä»¶æ¶ˆæ¯
> - æ¶ˆæ¯å†…å®¹æ ¼å¼ï¼š`[å›¾ç‰‡] æ–‡ä»¶å`ã€`[è§†é¢‘] æ–‡ä»¶å`ã€`[æ–‡ä»¶] æ–‡ä»¶å`
> - è¿”å› `message_uuid` å’Œ `message_send_time` ç”¨äºå‰ç«¯æ›´æ–°èŠå¤©ç•Œé¢

### Fetch API è°ƒç”¨ç¤ºä¾‹

```javascript
// è®¡ç®—æ–‡ä»¶SHA-256å“ˆå¸Œï¼ˆä»…åŒ…å«æ–‡ä»¶å¤§å°å’Œå†…å®¹ï¼Œç¡®ä¿ç›¸åŒå†…å®¹äº§ç”Ÿç›¸åŒå“ˆå¸Œï¼‰
async function calculateSHA256(file) {
  const SAMPLE_SIZE = 10 * 1024 * 1024; // 10MB
  
  // æ–‡ä»¶å¤§å°ä¿¡æ¯ï¼ˆä¸åŒ…å«æ–‡ä»¶åç­‰å…ƒä¿¡æ¯ï¼Œç¡®ä¿ç›¸åŒå†…å®¹ç›¸åŒå“ˆå¸Œï¼‰
  const sizeBuffer = new TextEncoder().encode(`|size:${file.size}|`);
  
  let dataToHash;
  
  if (file.size <= SAMPLE_SIZE * 3) {
    // å°æ–‡ä»¶ï¼ˆ< 30MBï¼‰ï¼šè®¡ç®—å®Œæ•´å“ˆå¸Œ
    const fileBuffer = new Uint8Array(await file.arrayBuffer());
    dataToHash = new Uint8Array(sizeBuffer.length + fileBuffer.length);
    dataToHash.set(sizeBuffer, 0);
    dataToHash.set(fileBuffer, sizeBuffer.length);
  } else {
    // å¤§æ–‡ä»¶ï¼šé‡‡æ ·å“ˆå¸Œç­–ç•¥
    const chunks = [];
    
    // è¯»å–å¼€å¤´10MB
    const startBlob = file.slice(0, SAMPLE_SIZE);
    chunks.push(new Uint8Array(await startBlob.arrayBuffer()));
    
    // è¯»å–ä¸­é—´10MB
    const middleStart = Math.floor((file.size - SAMPLE_SIZE) / 2);
    const middleBlob = file.slice(middleStart, middleStart + SAMPLE_SIZE);
    chunks.push(new Uint8Array(await middleBlob.arrayBuffer()));
    
    // è¯»å–ç»“å°¾10MB
    const endBlob = file.slice(file.size - SAMPLE_SIZE, file.size);
    chunks.push(new Uint8Array(await endBlob.arrayBuffer()));
    
    // åˆå¹¶æ‰€æœ‰æ•°æ®
    const totalLength = sizeBuffer.length + chunks.reduce((sum, chunk) => sum + chunk.length, 0);
    dataToHash = new Uint8Array(totalLength);
    let offset = 0;
    
    dataToHash.set(sizeBuffer, offset);
    offset += sizeBuffer.length;
    
    for (const chunk of chunks) {
      dataToHash.set(chunk, offset);
      offset += chunk.length;
    }
  }
  
  // è®¡ç®—SHA-256å“ˆå¸Œ
  const hashBuffer = await crypto.subtle.digest('SHA-256', dataToHash);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

// è¯·æ±‚ä¸Šä¼ 
async function requestUpload(file, fileType = 'user_image') {
  const accessToken = localStorage.getItem('access_token');
  
  // 1. è®¡ç®—æ–‡ä»¶å“ˆå¸Œ
  const fileHash = await calculateSHA256(file);
  
  // 2. è¯·æ±‚ä¸Šä¼ URL
  const response = await fetch('/api/storage/upload/request', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${accessToken}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      file_type: fileType,
      storage_location: 'user_files',
      filename: file.name,
      file_size: file.size,
      content_type: file.type,
      file_hash: fileHash,
      force_upload: false
    })
  });
  
  const result = await response.json();
  
  // 3. æ£€æŸ¥æ˜¯å¦ç§’ä¼ 
  if (result.instant_upload) {
    console.log('ç§’ä¼ æˆåŠŸï¼', result.existing_file_url);
    return result;
  }
  
  return result;
}
```

---

## 2. åˆ†ç‰‡ä¸Šä¼ æ–‡ä»¶åˆ°MinIO

### ä¸Šä¼ æ–¹å¼è¯´æ˜

æ–‡ä»¶ä¸Šä¼ é‡‡ç”¨**é¢„ç­¾ååˆ†ç‰‡ä¸Šä¼ ç›´ä¼ MinIO**æ–¹å¼ï¼Œåç«¯ä¸å‚ä¸æ•°æ®ä¼ è¾“ï¼š

| æ‰€æœ‰æ–‡ä»¶ | ä¸Šä¼ æ¨¡å¼ | è¯´æ˜ |
|---------|---------|------|
| ä»»æ„å¤§å° | `multipart` | åˆ†ç‰‡ä¸Šä¼ åˆ°MinIOï¼Œæ¯ç‰‡ 90MB |

> **Cloudflare å‹å¥½**ï¼šæ¯ä¸ªåˆ†ç‰‡è¯·æ±‚ < 100MBï¼Œå®Œç¾æ”¯æŒ Cloudflare å…è´¹ç‰ˆé™åˆ¶ã€‚

### åˆ†ç‰‡ä¸Šä¼ æµç¨‹

1. è°ƒç”¨ `request` æ¥å£è·å– `multipart_upload_id`ã€`chunk_size`ã€`total_chunks`
2. å¾ªç¯è°ƒç”¨ `part_url` æ¥å£è·å–æ¯ä¸ªåˆ†ç‰‡çš„é¢„ç­¾åURL
3. ä½¿ç”¨ `PUT` æ–¹æ³•ä¸Šä¼ æ¯ä¸ªåˆ†ç‰‡
4. è°ƒç”¨ `confirm` æ¥å£ç¡®è®¤ä¸Šä¼ å®Œæˆ

### Fetch API è°ƒç”¨ç¤ºä¾‹

```javascript
// åˆ†ç‰‡ä¸Šä¼ æ–‡ä»¶åˆ°MinIOï¼ˆå¸¦è¿›åº¦ï¼‰
async function uploadWithMultipart(file, uploadInfo, onProgress) {
  const chunkSize = uploadInfo.chunk_size || (90 * 1024 * 1024); // é»˜è®¤90MB
  const totalChunks = uploadInfo.total_chunks || Math.ceil(file.size / chunkSize);
  const accessToken = localStorage.getItem('access_token');
  
  let totalUploaded = 0;
  
  for (let i = 0; i < totalChunks; i++) {
    // 1. è·å–åˆ†ç‰‡é¢„ç­¾åURL
    const partUrlRes = await fetch(
      `/api/storage/multipart/part_url?file_key=${encodeURIComponent(uploadInfo.file_key)}&upload_id=${encodeURIComponent(uploadInfo.multipart_upload_id)}&part_number=${i + 1}`,
      {
        headers: { 'Authorization': `Bearer ${accessToken}` }
      }
    );
    
    if (!partUrlRes.ok) throw new Error('è·å–åˆ†ç‰‡URLå¤±è´¥');
    const { part_url } = await partUrlRes.json();
    
    // 2. åˆ‡å‰²åˆ†ç‰‡
    const start = i * chunkSize;
    const end = Math.min(start + chunkSize, file.size);
    const chunk = file.slice(start, end);
    
    // 3. ä¸Šä¼ åˆ†ç‰‡
    await uploadChunk(part_url, chunk);
    
    // 4. æ›´æ–°è¿›åº¦
    totalUploaded += chunk.size;
    if (onProgress) {
      onProgress({
        percent: (totalUploaded / file.size) * 100,
        loaded: totalUploaded,
        total: file.size,
        currentChunk: i + 1,
        totalChunks
      });
    }
  }
  
  return true;
}

// ä¸Šä¼ å•ä¸ªåˆ†ç‰‡
function uploadChunk(url, chunk) {
  return new Promise((resolve, reject) => {
    const xhr = new XMLHttpRequest();
    
    xhr.onload = () => {
      if (xhr.status >= 200 && xhr.status < 300) {
        resolve();
      } else {
        reject(new Error(`åˆ†ç‰‡ä¸Šä¼ å¤±è´¥: HTTP ${xhr.status}`));
      }
    };
    
    xhr.onerror = () => reject(new Error('ç½‘ç»œé”™è¯¯'));
    
    xhr.open('PUT', url);
    xhr.send(chunk);
  });
}
```

---

## 3. ç¡®è®¤ä¸Šä¼ å®Œæˆï¼ˆé¢„ç­¾åä¸Šä¼ ä¸“ç”¨ï¼‰

### æ¥å£ä¿¡æ¯

- **URL**: `/api/storage/upload/confirm`
- **æ–¹æ³•**: `POST`
- **éœ€è¦é‰´æƒ**: æ˜¯ï¼ˆBearer Tokenï¼‰

### åŠŸèƒ½è¯´æ˜

ç¡®è®¤é¢„ç­¾åä¸Šä¼ å·²å®Œæˆã€‚åç«¯ä¼šéªŒè¯æ–‡ä»¶å·²å­˜åœ¨äºMinIOåï¼Œå®Œæˆä»¥ä¸‹æ“ä½œï¼š
1. æ›´æ–°æ–‡ä»¶çŠ¶æ€ä¸ºå·²å®Œæˆ
2. åˆ›å»ºUUIDæ˜ å°„è®°å½•
3. æˆäºˆè®¿é—®æƒé™
4. å¯¹äºå¥½å‹/ç¾¤èŠæ–‡ä»¶ï¼Œè‡ªåŠ¨å‘é€æ¶ˆæ¯å¹¶è§¦å‘WebSocketé€šçŸ¥

### è¯·æ±‚å‚æ•°

```json
{
  "file_key": "user_id/images/timestamp_hash_filename.jpg"
}
```

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| file_key | string | æ˜¯ | æ–‡ä»¶keyï¼ˆ`request`æ¥å£è¿”å›çš„ï¼‰ |

### å“åº”ç¤ºä¾‹

**ä¸ªäººæ–‡ä»¶å“åº”ï¼š**
```json
{
  "file_url": "http://localhost/api/storage/file/{uuid}",
  "file_key": "user_id/images/...",
  "file_size": 6400000,
  "content_type": "image/jpeg",
  "preview_support": "inline_preview"
}
```

**å¥½å‹æ–‡ä»¶å“åº”ï¼ˆè‡ªåŠ¨æ’å…¥æ¶ˆæ¯+WebSocketé€šçŸ¥ï¼‰ï¼š**
```json
{
  "file_url": "http://localhost/api/storage/file/{uuid}",
  "file_key": "conv-user1-user2/images/...",
  "file_size": 6400000,
  "content_type": "image/jpeg",
  "preview_support": "inline_preview",
  "message_uuid": "e29469f7-0bcd-4331-aacf-26c71d15e737",
  "message_send_time": "2025-12-03T06:00:00+00:00"
}
```

> **é‡è¦**: è¿”å›çš„ `file_url` æ˜¯UUIDæ ¼å¼çš„è®¿é—®è·¯å¾„ï¼Œéœ€è¦é…åˆé¢„ç­¾åURLä½¿ç”¨ã€‚

> **å¥½å‹/ç¾¤èŠæ–‡ä»¶è‡ªåŠ¨æ¶ˆæ¯**ï¼šå½“æ–‡ä»¶ä¸ºå¥½å‹æˆ–ç¾¤èŠæ–‡ä»¶æ—¶ï¼Œç¡®è®¤å®Œæˆåï¼š
> - è‡ªåŠ¨åœ¨èŠå¤©è®°å½•ä¸­æ’å…¥æ–‡ä»¶æ¶ˆæ¯
> - æ¶ˆæ¯å†…å®¹æ ¼å¼ï¼š`[å›¾ç‰‡] æ–‡ä»¶å`ã€`[è§†é¢‘] æ–‡ä»¶å`ã€`[æ–‡ä»¶] æ–‡ä»¶å`
> - è§¦å‘WebSocketå®æ—¶é€šçŸ¥
> - è¿”å› `message_uuid` å’Œ `message_send_time` ç”¨äºå‰ç«¯æ›´æ–°

### Fetch API è°ƒç”¨ç¤ºä¾‹

```javascript
// ç¡®è®¤ä¸Šä¼ å®Œæˆ
async function confirmUpload(fileKey) {
  const accessToken = localStorage.getItem('access_token');
  
  const response = await fetch('/api/storage/upload/confirm', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${accessToken}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      file_key: fileKey
    })
  });
  
  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.error || 'ç¡®è®¤ä¸Šä¼ å¤±è´¥');
  }
  
  const result = await response.json();
  
  // å¥½å‹æ–‡ä»¶ï¼šæ£€æŸ¥æ˜¯å¦è‡ªåŠ¨å‘é€äº†æ¶ˆæ¯
  if (result.message_uuid) {
    console.log('æ–‡ä»¶æ¶ˆæ¯å·²è‡ªåŠ¨å‘é€:', result.message_uuid);
  }
  
  return result;
}
```

---

## 4. è·å–åˆ†ç‰‡ä¸Šä¼ URL

### æ¥å£ä¿¡æ¯

- **URL**: `/api/storage/multipart/part_url`
- **æ–¹æ³•**: `GET`
- **éœ€è¦é‰´æƒ**: æ˜¯ï¼ˆBearer Tokenï¼‰

### è¯·æ±‚å‚æ•°

Query Parameters:
- `file_key`: æ–‡ä»¶keyï¼ˆ`request` æ¥å£è¿”å›çš„ï¼‰
- `upload_id`: åˆ†ç‰‡ä¸Šä¼ IDï¼ˆ`request` æ¥å£è¿”å›çš„ `multipart_upload_id`ï¼‰
- `part_number`: åˆ†ç‰‡ç¼–å·ï¼ˆä»1å¼€å§‹ï¼‰

### å“åº”ç¤ºä¾‹

```json
{
  "part_url": "http://localhost/user-file/xxx?uploadId=xxx&partNumber=1&X-Amz-Signature=...",
  "part_number": 1,
  "expires_in": 3600
}
```

### Fetch API è°ƒç”¨ç¤ºä¾‹

```javascript
// è·å–åˆ†ç‰‡é¢„ç­¾åURL
async function getPartUrl(fileKey, uploadId, partNumber) {
  const accessToken = localStorage.getItem('access_token');
  
  const response = await fetch(
    `/api/storage/multipart/part_url?file_key=${encodeURIComponent(fileKey)}&upload_id=${encodeURIComponent(uploadId)}&part_number=${partNumber}`,
    {
      headers: {
        'Authorization': `Bearer ${accessToken}`
      }
    }
  );
  
  if (!response.ok) {
    throw new Error('è·å–åˆ†ç‰‡URLå¤±è´¥');
  }
  
  return await response.json();
}
```

---

## å®Œæ•´ä¸Šä¼ æµç¨‹ç¤ºä¾‹

```javascript
// å®Œæ•´çš„æ–‡ä»¶ä¸Šä¼ æµç¨‹ï¼ˆåˆ†ç‰‡ä¸Šä¼  + confirmç¡®è®¤ï¼‰
async function uploadFileComplete(file, onProgress) {
  try {
    const accessToken = localStorage.getItem('access_token');
    console.log('å¼€å§‹ä¸Šä¼ :', file.name);
    
    // 1. è®¡ç®—æ–‡ä»¶å“ˆå¸Œ
    console.log('è®¡ç®—æ–‡ä»¶å“ˆå¸Œ...');
    const fileHash = await calculateSHA256(file);
    
    // 2. è¯·æ±‚ä¸Šä¼ 
    const response = await fetch('/api/storage/upload/request', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        file_type: 'user_image',
        storage_location: 'user_files',
        filename: file.name,
        file_size: file.size,
        content_type: file.type,
        file_hash: fileHash,
        force_upload: false
      })
    });
    
    const uploadInfo = await response.json();
    
    // 3. æ£€æŸ¥ç§’ä¼ 
    if (uploadInfo.instant_upload) {
      console.log('ç§’ä¼ æˆåŠŸï¼ä½¿ç”¨UUIDæ˜ å°„');
      return {
        success: true,
        instant: true,
        url: uploadInfo.existing_file_url
      };
    }
    
    // 4. åˆ†ç‰‡ä¸Šä¼ 
    const chunkSize = uploadInfo.chunk_size || (90 * 1024 * 1024);
    const totalChunks = uploadInfo.total_chunks || Math.ceil(file.size / chunkSize);
    
    console.log(`å¼€å§‹åˆ†ç‰‡ä¸Šä¼ : ${totalChunks} ä¸ªåˆ†ç‰‡ï¼Œæ¯ç‰‡ ${(chunkSize / 1024 / 1024).toFixed(0)}MB`);
    
    let totalUploaded = 0;
    
    for (let i = 0; i < totalChunks; i++) {
      // è·å–åˆ†ç‰‡é¢„ç­¾åURL
      const partUrlRes = await fetch(
        `/api/storage/multipart/part_url?file_key=${encodeURIComponent(uploadInfo.file_key)}&upload_id=${encodeURIComponent(uploadInfo.multipart_upload_id)}&part_number=${i + 1}`,
        { headers: { 'Authorization': `Bearer ${accessToken}` } }
      );
      const { part_url } = await partUrlRes.json();
      
      // åˆ‡å‰²å¹¶ä¸Šä¼ åˆ†ç‰‡
      const start = i * chunkSize;
      const end = Math.min(start + chunkSize, file.size);
      const chunk = file.slice(start, end);
      
      await fetch(part_url, { method: 'PUT', body: chunk });
      
      // æ›´æ–°è¿›åº¦
      totalUploaded += chunk.size;
      if (onProgress) {
        onProgress({
          percent: (totalUploaded / file.size) * 100,
          loaded: totalUploaded,
          total: file.size,
          currentChunk: i + 1,
          totalChunks
        });
      }
      
      console.log(`åˆ†ç‰‡ ${i + 1}/${totalChunks} ä¸Šä¼ å®Œæˆ`);
    }
    
    // 5. ç¡®è®¤ä¸Šä¼ å®Œæˆ
    console.log('ç¡®è®¤ä¸Šä¼ ...');
    const confirmResult = await confirmUpload(uploadInfo.file_key);
    
    console.log('ä¸Šä¼ æˆåŠŸï¼');
    return {
      success: true,
      instant: false,
      url: confirmResult.file_url,
      messageUuid: confirmResult.message_uuid
    };
    
  } catch (error) {
    console.error('ä¸Šä¼ å¤±è´¥:', error);
    throw error;
  }
}

// ç¡®è®¤ä¸Šä¼ å®Œæˆ
async function confirmUpload(fileKey) {
  const accessToken = localStorage.getItem('access_token');
  
  const response = await fetch('/api/storage/upload/confirm', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${accessToken}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ file_key: fileKey })
  });
  
  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.error || 'ç¡®è®¤ä¸Šä¼ å¤±è´¥');
  }
  
  return await response.json();
}

// ä½¿ç”¨ç¤ºä¾‹
const fileInput = document.querySelector('#file-input');
fileInput.addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  
  const progressBar = document.querySelector('#progress');
  const progressText = document.querySelector('#progress-text');
  
  try {
    const result = await uploadFileComplete(file, (progress) => {
      progressBar.style.width = progress.percent + '%';
      progressText.textContent = `${progress.currentChunk}/${progress.totalChunks} (${progress.percent.toFixed(1)}%)`;
    });
    
    alert(`ä¸Šä¼ æˆåŠŸï¼${result.instant ? 'ï¼ˆç§’ä¼ ï¼‰' : ''}`);
  } catch (error) {
    alert('ä¸Šä¼ å¤±è´¥: ' + error.message);
  }
});
```

---

## 4. é€šè¿‡UUIDè®¿é—®æ–‡ä»¶

### æ¥å£ä¿¡æ¯

- **URL**: `/api/storage/file/{uuid}`
- **æ–¹æ³•**: `GET`
- **éœ€è¦é‰´æƒ**: æ˜¯ï¼ˆBearer Tokenï¼‰

### åŠŸèƒ½è¯´æ˜

é€šè¿‡UUIDè®¿é—®æ–‡ä»¶ï¼Œç³»ç»Ÿä¼šï¼š
1. éªŒè¯ç”¨æˆ·Token
2. æ£€æŸ¥æƒé™è¡¨ï¼ˆ`file_access_permissions`ï¼‰
3. æŸ¥è¯¢UUIDæ˜ å°„è¡¨è·å–ç‰©ç†æ–‡ä»¶è·¯å¾„
4. ä»MinIOè¯»å–æ–‡ä»¶å¹¶è¿”å›æ–‡ä»¶æµ

### è·¯å¾„å‚æ•°

- `uuid`: æ–‡ä»¶çš„UUIDæ ‡è¯†ï¼ˆ36ä½UUIDå­—ç¬¦ä¸²ï¼‰

### è¯·æ±‚ç¤ºä¾‹

```bash
curl -X GET "http://localhost:8080/api/storage/file/f5f23929-1689-4b04-98e7-0073fac1eea4" \
  -H "Authorization: Bearer {access_token}"
```

### å“åº”

- **æˆåŠŸ**: è¿”å›æ–‡ä»¶æµï¼ˆäºŒè¿›åˆ¶æ•°æ®ï¼‰
  - Status: 200 OK
  - Content-Type: æ–‡ä»¶çš„MIMEç±»å‹
  - Content-Length: æ–‡ä»¶å¤§å°
  - Cache-Control: public, max-age=31536000
  
- **æ— æƒé™**: 
  ```json
  {
    "error": "æ— æƒè®¿é—®æ­¤æ–‡ä»¶"
  }
  ```
  - Status: 403 Forbidden
  
- **æ–‡ä»¶ä¸å­˜åœ¨**:
  ```json
  {
    "error": "æ–‡ä»¶ä¸å­˜åœ¨"
  }
  ```
  - Status: 404 Not Found

### Fetch API è°ƒç”¨ç¤ºä¾‹

```javascript
// è®¿é—®UUIDæ–‡ä»¶
async function accessFileByUuid(uuid) {
  const accessToken = localStorage.getItem('access_token');
  
  const response = await fetch(
    `http://localhost:8080/api/storage/file/${uuid}`,
    {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${accessToken}`
      }
    }
  );
  
  if (!response.ok) {
    if (response.status === 403) {
      throw new Error('æ— æƒè®¿é—®æ­¤æ–‡ä»¶');
    } else if (response.status === 404) {
      throw new Error('æ–‡ä»¶ä¸å­˜åœ¨');
    }
    throw new Error('è®¿é—®å¤±è´¥');
  }
  
  // è·å–æ–‡ä»¶blob
  const blob = await response.blob();
  return URL.createObjectURL(blob);
}

// åœ¨é¡µé¢ä¸­æ˜¾ç¤ºå›¾ç‰‡
async function displayImage(uuid) {
  try {
    const blobUrl = await accessFileByUuid(uuid);
    const img = document.createElement('img');
    img.src = blobUrl;
    document.body.appendChild(img);
  } catch (error) {
    console.error('æ˜¾ç¤ºå¤±è´¥:', error);
  }
}

// åœ¨è§†é¢‘æ ‡ç­¾ä¸­æ’­æ”¾
async function playVideo(uuid) {
  try {
    const blobUrl = await accessFileByUuid(uuid);
    const video = document.querySelector('video');
    video.src = blobUrl;
    video.play();
  } catch (error) {
    console.error('æ’­æ”¾å¤±è´¥:', error);
  }
}

// ç›´æ¥åœ¨imgæ ‡ç­¾ä¸­ä½¿ç”¨ï¼ˆéœ€è¦tokenåœ¨headerä¸­ï¼Œä»…æ”¯æŒfetchæ–¹å¼ï¼‰
function displayImageDirectly(uuid) {
  const img = document.querySelector('#preview-img');
  // æ³¨æ„ï¼šç›´æ¥åœ¨img.srcä¸­æ— æ³•ä¼ é€’Authorization header
  // å»ºè®®ä½¿ç”¨fetchè·å–blobåè½¬ä¸ºobjectURL
}
```

---

## 5. æ–‡ä»¶ç±»å‹å’Œå¤§å°é™åˆ¶

| æ–‡ä»¶ç±»å‹ | å¤§å°èŒƒå›´ | ä¸Šä¼ æ–¹å¼ | é¢„è§ˆæ”¯æŒ |
|---------|---------|---------|---------|
| å¤´åƒ | < 10MB | åç«¯ç›´ä¼  | åœ¨çº¿é¢„è§ˆ |
| å›¾ç‰‡ | < 100MB | åˆ†ç‰‡ä¸Šä¼  | åœ¨çº¿é¢„è§ˆ |
| å›¾ç‰‡æ–‡ä»¶ | 100MB - 15GB | åˆ†ç‰‡ä¸Šä¼  | ä»…ä¸‹è½½ |
| è§†é¢‘ | < 15GB | åˆ†ç‰‡ä¸Šä¼  | åœ¨çº¿é¢„è§ˆ |
| è§†é¢‘æ–‡ä»¶ | 15GB - 30GB | åˆ†ç‰‡ä¸Šä¼  | ä»…ä¸‹è½½ |
| æ–‡æ¡£ | < 15GB | åˆ†ç‰‡ä¸Šä¼  | ä»…ä¸‹è½½ |

**ä¸Šä¼ æ¨¡å¼è¯´æ˜**ï¼š
- **multipart**ï¼šåˆ†ç‰‡ä¸Šä¼ ï¼Œæ¯ç‰‡ 90MBï¼Œæ‰€æœ‰æ–‡ä»¶ç»Ÿä¸€ä½¿ç”¨
- **å¤´åƒä¸Šä¼ **ï¼šä»ä½¿ç”¨åç«¯ç›´ä¼ æ–¹å¼ï¼ˆæ–‡ä»¶è¾ƒå°ï¼Œæ— éœ€åˆ†ç‰‡ï¼‰

**Cloudflare å…¼å®¹**ï¼š
- æ¯ä¸ªåˆ†ç‰‡è¯·æ±‚ < 100MBï¼Œå®Œç¾æ”¯æŒ Cloudflare å…è´¹ç‰ˆé™åˆ¶
- ç¯å¢ƒå˜é‡ `MULTIPART_CHUNK_SIZE` å¯è‡ªå®šä¹‰åˆ†ç‰‡å¤§å°ï¼ˆé»˜è®¤ 94371840 = 90MBï¼‰

---

## å­˜å‚¨è·¯å¾„è§„èŒƒ

æŒ‰ç…§ `MinIO/data.md` è§„èŒƒï¼š

- **avatars**: `{user_id}.{ext}`
- **user-file**: `{user_id}/{type}/{timestamp}_{hash}_{filename}`
- **friends-file**: `{conversation_uuid}/{type}/{timestamp}_{hash}_{filename}`
- **group-file**: `{group_id}/{type}/{timestamp}_{hash}_{filename}`

typeåˆ†ç±»ï¼š
- `images/` - å›¾ç‰‡æ–‡ä»¶
- `videos/` - è§†é¢‘æ–‡ä»¶
- `files/` - æ–‡æ¡£æ–‡ä»¶

---

## é”™è¯¯å¤„ç†

```javascript
try {
  const result = await uploadFileComplete(file);
} catch (error) {
  if (error.message.includes('Tokenæ— æ•ˆ')) {
    // Tokenè¿‡æœŸæˆ–æ— æ•ˆ
    alert('è¯·é‡æ–°ç™»å½•');
  } else if (error.message.includes('æ–‡ä»¶å¤§å°è¶…è¿‡é™åˆ¶')) {
    // æ–‡ä»¶å¤ªå¤§
    alert('æ–‡ä»¶è¿‡å¤§ï¼Œæ— æ³•ä¸Šä¼ ');
  } else if (error.message.includes('å“ˆå¸Œä¸åŒ¹é…')) {
    // æ–‡ä»¶æŸå
    alert('æ–‡ä»¶å·²æŸåï¼Œè¯·é‡è¯•');
  } else {
    // å…¶ä»–é”™è¯¯
    alert('ä¸Šä¼ å¤±è´¥: ' + error.message);
  }
}
```

---

## æ³¨æ„äº‹é¡¹

1. **æ–‡ä»¶å“ˆå¸Œè®¡ç®—**ï¼šå¿…é¡»åœ¨å®¢æˆ·ç«¯è®¡ç®—SHA-256å“ˆå¸Œï¼ˆä»…åŒ…å«æ–‡ä»¶å¤§å°å’Œå†…å®¹ï¼Œä¸åŒ…å«æ–‡ä»¶åï¼‰ï¼Œç”¨äºå»é‡å’Œç§’ä¼ 
2. **åˆ†ç‰‡ä¸Šä¼ **ï¼šæ‰€æœ‰æ–‡ä»¶ï¼ˆé™¤å¤´åƒå¤–ï¼‰ç»Ÿä¸€ä½¿ç”¨åˆ†ç‰‡ä¸Šä¼ ï¼Œæ¯ç‰‡ 90MB
3. **é¢„ç­¾åURLæœ‰æ•ˆæœŸ**ï¼šæ ¹æ®æ–‡ä»¶å¤§å°åŠ¨æ€è°ƒæ•´ï¼ˆç¯å¢ƒå˜é‡é…ç½®ï¼‰
4. **confirmç¡®è®¤**ï¼šåˆ†ç‰‡ä¸Šä¼ å®Œæˆå**å¿…é¡»è°ƒç”¨confirmæ¥å£**ï¼Œå¦åˆ™æ–‡ä»¶çŠ¶æ€ä¸º`pending_confirm`
5. **ç›´ä¼ MinIO**ï¼šæ‰€æœ‰ä¸Šä¼ éƒ½ç›´è¿MinIOï¼Œåç«¯ä¸å‚ä¸æ•°æ®ä¼ è¾“
6. **ç§’ä¼ åŠŸèƒ½**ï¼šç›¸åŒå“ˆå¸Œçš„æ–‡ä»¶ä¼šè‡ªåŠ¨ç§’ä¼ ï¼ŒèŠ‚çœæ—¶é—´å’Œå¸¦å®½
7. **è¿›åº¦è·Ÿè¸ª**ï¼šåˆ†ç‰‡ä¸Šä¼ å¯ç²¾ç¡®è·Ÿè¸ªæ¯ä¸ªåˆ†ç‰‡çš„ä¸Šä¼ è¿›åº¦
8. **WebSocketé€šçŸ¥**ï¼šå¥½å‹/ç¾¤èŠæ–‡ä»¶åœ¨confirmåä¼šè§¦å‘WebSocketå®æ—¶é€šçŸ¥
9. **Cloudflareå…¼å®¹**ï¼šæ¯ä¸ªåˆ†ç‰‡è¯·æ±‚ < 100MBï¼Œå®Œç¾æ”¯æŒ CF å…è´¹ç‰ˆ

---

## UUIDæ˜ å°„æœºåˆ¶è¯¦è§£

### è®¾è®¡åŸç†

é‡‡ç”¨**UUIDæ˜ å°„è¡¨ + æƒé™è¡¨**å®ç°è·¨ç”¨æˆ·æ–‡ä»¶å»é‡ï¼š

```
ç”¨æˆ·Aä¸Šä¼  test.jpg (å“ˆå¸Œ: abc123...)
  â”œâ”€ ç‰©ç†å­˜å‚¨: user-file/userA/images/xxx_abc123_test.jpg
  â”œâ”€ ç”ŸæˆUUID: f5f23929-1689-4b04-98e7-0073fac1eea4
  â”œâ”€ æ˜ å°„è¡¨è®°å½•: UUID â†’ ç‰©ç†è·¯å¾„
  â””â”€ æƒé™è¡¨è®°å½•: UUID + userA â†’ owner

ç”¨æˆ·Bä¸Šä¼ ç›¸åŒæ–‡ä»¶ test.jpg (å“ˆå¸Œ: abc123...)
  â”œâ”€ æŸ¥è¯¢åˆ°å·²å­˜åœ¨çš„UUID
  â”œâ”€ ç§’ä¼ ï¼šæ— éœ€é‡å¤ä¸Šä¼ ç‰©ç†æ–‡ä»¶
  â”œâ”€ æƒé™è¡¨è®°å½•: UUID + userB â†’ owner
  â””â”€ è¿”å›ç›¸åŒçš„UUIDè®¿é—®URL

è®¿é—®æµç¨‹ï¼š
  ç”¨æˆ·A/Bè®¿é—®: /api/storage/file/{uuid}
  â”œâ”€ éªŒè¯Token
  â”œâ”€ æŸ¥è¯¢æƒé™è¡¨ï¼ˆæ˜¯å¦æœ‰è®¿é—®æƒé™ï¼‰
  â”œâ”€ æŸ¥è¯¢æ˜ å°„è¡¨ï¼ˆè·å–ç‰©ç†è·¯å¾„ï¼‰
  â””â”€ ä»MinIOè¯»å–å¹¶è¿”å›æ–‡ä»¶æµ
```

### æ ¸å¿ƒä¼˜åŠ¿

1. **çœŸæ­£çš„è·¨ç”¨æˆ·å»é‡**
   - ç›¸åŒæ–‡ä»¶åªå­˜å‚¨ä¸€ä»½ç‰©ç†å‰¯æœ¬
   - èŠ‚çœå­˜å‚¨ç©ºé—´50-90%

2. **ç»Ÿä¸€çš„æƒé™æ§åˆ¶**
   - åŸºäºæ•°æ®åº“æƒé™è¡¨ï¼Œä¸ä¾èµ–MinIO bucketç­–ç•¥
   - æ”¯æŒçµæ´»çš„æƒé™æˆäºˆå’Œæ’¤é”€

3. **ç”¨æˆ·éš”ç¦»**
   - æ¯ä¸ªç”¨æˆ·æœ‰ç‹¬ç«‹çš„file_key
   - ä¸ä¼šæš´éœ²å…¶ä»–ç”¨æˆ·çš„æ–‡ä»¶è·¯å¾„

4. **è½¯åˆ é™¤æ”¯æŒ**
   - æ’¤é”€æƒé™æ—¶è®¾ç½®`revoked_at`
   - ç‰©ç†æ–‡ä»¶ä¿ç•™ç›´åˆ°æ‰€æœ‰æƒé™éƒ½è¢«æ’¤é”€

### æ•°æ®åº“è¡¨ç»“æ„

#### file_uuid_mappingï¼ˆUUIDæ˜ å°„è¡¨ï¼‰
| å­—æ®µ | è¯´æ˜ |
|------|------|
| uuid | éšæœºUUIDï¼Œè®¿é—®æ ‡è¯† |
| physical_file_key | å®é™…ç‰©ç†æ–‡ä»¶è·¯å¾„ |
| file_hash | SHA-256å“ˆå¸Œï¼ˆå»é‡æŸ¥è¯¢ï¼‰ |
| first_uploader_id | é¦–æ¬¡ä¸Šä¼ è€… |

#### file_access_permissionsï¼ˆæƒé™è¡¨ï¼‰
| å­—æ®µ | è¯´æ˜ |
|------|------|
| file_uuid | å…³è”UUID |
| user_id | æˆæƒç”¨æˆ· |
| access_type | owner/read |
| granted_by | upload/share/friend/group |
| revoked_at | è½¯åˆ é™¤æ—¶é—´ |

### æ€§èƒ½è€ƒé‡

- é¦–æ¬¡ä¸Šä¼ ï¼š1æ¬¡æ•°æ®åº“æŸ¥è¯¢ï¼ˆ< 2msï¼‰
- ç§’ä¼ ï¼š2æ¬¡æ•°æ®åº“å†™å…¥ï¼ˆ< 5msï¼‰
- æ–‡ä»¶è®¿é—®ï¼š2æ¬¡æ•°æ®åº“æŸ¥è¯¢ï¼ˆ< 8msï¼‰
- é«˜å¹¶å‘æ”¯æŒï¼šçº¦2000æ¬¡/ç§’æ–‡ä»¶è®¿é—®

---

## 5. ç”Ÿæˆæ–‡ä»¶é¢„ç­¾åURLï¼ˆæ™®é€šæ–‡ä»¶ï¼‰â­ æ–°å¢

### æ¥å£ä¿¡æ¯

- **URL**: `/api/storage/file/{uuid}/presigned_url`
- **æ–¹æ³•**: `POST`
- **éœ€è¦é‰´æƒ**: æ˜¯ï¼ˆBearer Tokenï¼‰

### åŠŸèƒ½è¯´æ˜

é€šè¿‡UUIDç”ŸæˆMinIOé¢„ç­¾åä¸‹è½½URLï¼Œå®ç°å®¢æˆ·ç«¯ç›´è¿MinIOä¸‹è½½/é¢„è§ˆæ–‡ä»¶ï¼Œå‡è½»åç«¯å‹åŠ›ã€‚

**é€‚ç”¨åœºæ™¯**ï¼š
- æ™®é€šæ–‡ä»¶ï¼ˆ< 15GBï¼‰
- å›¾ç‰‡åœ¨çº¿é¢„è§ˆ
- è§†é¢‘æµå¼æ’­æ”¾
- PDFåœ¨çº¿æŸ¥çœ‹

**æ ¸å¿ƒä¼˜åŠ¿**ï¼š
- âœ… å®¢æˆ·ç«¯ç›´è¿MinIOï¼Œåç«¯é›¶å‹åŠ›
- âœ… æ”¯æŒRangeè¯·æ±‚ï¼ˆè§†é¢‘æ‹–åŠ¨ï¼‰
- âœ… æµè§ˆå™¨å¯ç¼“å­˜
- âœ… çœŸæ­£çš„æµå¼æ’­æ”¾

### è¯·æ±‚å‚æ•°

**Path Parameter**:
- `uuid`: æ–‡ä»¶UUIDï¼ˆä»ä¸Šä¼ å“åº”ä¸­è·å–ï¼‰

**Request Body**:
```json
{
  "operation": "download",
  "expires_in": 10800
}
```

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| operation | string | å¦ | æ“ä½œç±»å‹ï¼š"download" æˆ– "preview"ï¼Œé»˜è®¤ "download" |
| expires_in | number | å¦ | æœ‰æ•ˆæœŸï¼ˆç§’ï¼‰ï¼Œé»˜è®¤10800ï¼ˆ3å°æ—¶ï¼‰ï¼Œæœ€å¤§10800 |

### å“åº”ç¤ºä¾‹

**æˆåŠŸå“åº”**:
```json
{
  "presigned_url": "http://localhost:9000/user-file/alice/images/xxx.jpg?X-Amz-Algorithm=AWS4-HMAC-SHA256&...",
  "expires_at": "2025-11-30T12:59:18+00:00",
  "file_uuid": "cb31fb54-770d-4198-84d6-18ce9c6d290f",
  "file_size": 1048576,
  "content_type": "image/jpeg",
  "warning": null
}
```

**é”™è¯¯å“åº”**:
```json
{
  "error": "æ— æƒè®¿é—®æ­¤æ–‡ä»¶"
}
```

### Fetch API è°ƒç”¨ç¤ºä¾‹ï¼ˆå®Œæ•´ç‰ˆï¼Œå¸¦è‡ªåŠ¨é‡è¯•ï¼‰

```javascript
// ==========================================
// å®Œæ•´çš„é¢„ç­¾åURLè·å–å‡½æ•°ï¼ˆç”Ÿäº§ç¯å¢ƒæ¨èï¼‰
// ==========================================

// å…¨å±€çŠ¶æ€ç®¡ç†
const state = {
  accessToken: localStorage.getItem('accessToken') || '',
  refreshToken: localStorage.getItem('refreshToken') || '',
  presignedUrls: {} // ç¼“å­˜é¢„ç­¾åURL: { uuid: { url, expiresAt, cachedAt } }
};

// åˆ·æ–°Access Token
async function refreshAccessToken() {
  if (!state.refreshToken) {
    throw new Error('ç¼ºå°‘ refresh_token');
  }
  
  const res = await fetch('http://localhost:8080/api/auth/refresh', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ refresh_token: state.refreshToken }),
  });
  
  const data = await res.json();
  if (res.ok && data.access_token) {
    state.accessToken = data.access_token;
    localStorage.setItem('accessToken', state.accessToken);
    console.log('âœ… Access Tokenåˆ·æ–°æˆåŠŸ');
  } else {
    throw new Error(data.error || 'Tokenåˆ·æ–°å¤±è´¥');
  }
}

// è§£ç JWT Token
function decodeJwt(token) {
  try {
    const [, payload] = token.split('.');
    const json = atob(payload.replace(/-/g, '+').replace(/_/g, '/'));
    return JSON.parse(json);
  } catch {
    return null;
  }
}

// è·å–é¢„ç­¾åURLï¼ˆå¸¦ç¼“å­˜ã€è‡ªåŠ¨é‡è¯•ã€Tokenåˆ·æ–°ï¼‰
async function getPresignedUrl(uuid, filename, retryCount = 0) {
  const MAX_RETRIES = 2;
  
  // 1. æ£€æŸ¥Tokenæ˜¯å¦å­˜åœ¨
  if (!state.accessToken) {
    throw new Error('æœªç™»å½•ï¼Œè¯·å…ˆç™»å½•');
  }
  
  // 2. æ£€æŸ¥Tokenæ˜¯å¦è¿‡æœŸ
  const claims = decodeJwt(state.accessToken);
  if (claims && claims.exp && claims.exp * 1000 < Date.now()) {
    console.log('ğŸ”„ Access Tokenå·²è¿‡æœŸï¼Œå°è¯•åˆ·æ–°...');
    try {
      await refreshAccessToken();
    } catch (e) {
      throw new Error('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
    }
  }
  
  // 3. æ£€æŸ¥ç¼“å­˜æ˜¯å¦æœ‰æ•ˆï¼ˆè¿‡æœŸå‰5åˆ†é’Ÿéœ€è¦åˆ·æ–°ï¼‰
  const cached = state.presignedUrls[uuid];
  if (cached && cached.expiresAt) {
    const expiresTime = new Date(cached.expiresAt);
    const now = new Date();
    const remainingMs = expiresTime - now;
    
    if (remainingMs > 5 * 60 * 1000) {
      console.log(`âœ… ä½¿ç”¨ç¼“å­˜çš„é¢„ç­¾åURLï¼Œå‰©ä½™: ${Math.floor(remainingMs / 60000)}åˆ†é’Ÿ`);
      return cached.url;
    } else if (remainingMs > 0) {
      console.log(`âš ï¸ URLå³å°†è¿‡æœŸï¼Œé‡æ–°è·å–ä¸­...`);
    } else {
      console.log('ğŸ”„ ç¼“å­˜çš„URLå·²è¿‡æœŸï¼Œé‡æ–°è·å–...');
      delete state.presignedUrls[uuid];
    }
  }
  
  // 4. æ£€æµ‹æ–‡ä»¶å¤§å°ï¼ˆè¶…å¤§æ–‡ä»¶éœ€è¦ç‰¹æ®Šå¤„ç†ï¼‰
  const fileInfo = getFileInfo(uuid); // ä»æœ¬åœ°å­˜å‚¨æˆ–çŠ¶æ€ä¸­è·å–
  const LARGE_FILE_THRESHOLD = 15 * 1024 * 1024 * 1024; // 15GB
  const isLargeFile = fileInfo && fileInfo.file_size > LARGE_FILE_THRESHOLD;
  
  let endpoint, body;
  
  if (isLargeFile) {
    // è¶…å¤§æ–‡ä»¶ï¼šæç¤ºç”¨æˆ·è¾“å…¥é¢„è®¡ä¸‹è½½æ—¶é—´
    const hours = prompt(
      `æ£€æµ‹åˆ°å¤§æ–‡ä»¶ï¼ˆ${formatFileSize(fileInfo.file_size)}ï¼‰\n` +
      `è¯·è¾“å…¥é¢„è®¡ä¸‹è½½æ—¶é—´ï¼ˆå°æ—¶ï¼Œæœ€å°‘3ï¼Œæœ€å¤š168ï¼‰:`,
      '6'
    );
    
    if (!hours || parseInt(hours) < 3) {
      throw new Error('å·²å–æ¶ˆæˆ–æ—¶é—´æ— æ•ˆï¼ˆæœ€å°‘3å°æ—¶ï¼‰');
    }
    
    const estimatedSeconds = Math.min(parseInt(hours) * 3600, 604800);
    endpoint = `http://localhost:8080/api/storage/file/${uuid}/presigned_url/extended`;
    body = { operation: 'download', estimated_download_time: estimatedSeconds };
  } else {
    // æ™®é€šæ–‡ä»¶ï¼š3å°æ—¶æœ‰æ•ˆæœŸ
    endpoint = `http://localhost:8080/api/storage/file/${uuid}/presigned_url`;
    body = { operation: 'download' };
  }
  
  // 5. è¯·æ±‚é¢„ç­¾åURL
  const response = await fetch(endpoint, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${state.accessToken}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(body)
  });
  
  // 6. é”™è¯¯å¤„ç†ï¼ˆæ”¯æŒè‡ªåŠ¨é‡è¯•ï¼‰
  if (!response.ok) {
    let errorMessage = 'è·å–ä¸‹è½½é“¾æ¥å¤±è´¥';
    
    try {
      const error = await response.json();
      errorMessage = error.error || errorMessage;
    } catch (e) {
      // å“åº”ä¸æ˜¯JSON
      if (response.status === 401) {
        // Tokenè¿‡æœŸï¼Œå°è¯•åˆ·æ–°å¹¶é‡è¯•
        if (retryCount < MAX_RETRIES) {
          console.log(`ğŸ”„ æ£€æµ‹åˆ°401é”™è¯¯ï¼Œåˆ·æ–°Tokenå¹¶é‡è¯• (${retryCount + 1}/${MAX_RETRIES})...`);
          try {
            await refreshAccessToken();
            return await getPresignedUrl(uuid, filename, retryCount + 1);
          } catch (refreshError) {
            errorMessage = 'ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•';
            state.accessToken = '';
            state.refreshToken = '';
            localStorage.removeItem('accessToken');
            localStorage.removeItem('refreshToken');
          }
        } else {
          errorMessage = 'ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•';
        }
      } else if (response.status === 403) {
        errorMessage = 'æ— æƒè®¿é—®æ­¤æ–‡ä»¶';
      } else if (response.status === 404) {
        errorMessage = 'æ–‡ä»¶ä¸å­˜åœ¨';
      } else {
        const text = await response.text().catch(() => '');
        errorMessage = `æœåŠ¡å™¨é”™è¯¯ (${response.status})${text ? ': ' + text.substring(0, 100) : ''}`;
      }
    }
    
    throw new Error(errorMessage);
  }
  
  const data = await response.json();
  
  // 7. ç¼“å­˜é¢„ç­¾åURL
  state.presignedUrls[uuid] = {
    url: data.presigned_url,
    expiresAt: data.expires_at,
    cachedAt: new Date().toISOString()
  };
  
  console.log(`âœ… è·å–æ–°çš„é¢„ç­¾åURLï¼Œè¿‡æœŸæ—¶é—´: ${data.expires_at}`);
  if (data.warning) {
    console.warn(`âš ï¸ ${data.warning}`);
  }
  
  return data.presigned_url;
}

// ==========================================
// åª’ä½“åŠ è½½é”™è¯¯è‡ªåŠ¨å¤„ç†ï¼ˆURLè¿‡æœŸè‡ªåŠ¨åˆ·æ–°ï¼‰
// ==========================================

// å¤„ç†å›¾ç‰‡/è§†é¢‘åŠ è½½å¤±è´¥ï¼ˆè‡ªåŠ¨é‡æ–°è·å–URLï¼‰
async function handleMediaError(event, uuid, filename, mediaElement) {
  console.warn('âš ï¸ åª’ä½“åŠ è½½å¤±è´¥ï¼Œæ£€æŸ¥URLæ˜¯å¦è¿‡æœŸ...');
  
  const cached = state.presignedUrls[uuid];
  if (cached && cached.expiresAt) {
    const expiresTime = new Date(cached.expiresAt);
    const now = new Date();
    
    if (now > expiresTime) {
      console.log('ğŸ”„ URLå·²è¿‡æœŸï¼Œè‡ªåŠ¨é‡æ–°è·å–...');
      try {
        // æ¸…é™¤è¿‡æœŸç¼“å­˜
        delete state.presignedUrls[uuid];
        
        // é‡æ–°è·å–é¢„ç­¾åURL
        const newUrl = await getPresignedUrl(uuid, filename);
        
        // æ›´æ–°åª’ä½“å…ƒç´ 
        if (mediaElement) {
          // ä¿å­˜å½“å‰æ’­æ”¾ä½ç½®ï¼ˆè§†é¢‘ï¼‰
          const currentTime = mediaElement.currentTime || 0;
          
          mediaElement.src = newUrl;
          
          // æ¢å¤æ’­æ”¾ä½ç½®ï¼ˆè§†é¢‘ï¼‰
          if (mediaElement.tagName === 'VIDEO' && currentTime > 0) {
            mediaElement.currentTime = currentTime;
          }
          
          mediaElement.load();
          console.log('âœ… URLå·²æ›´æ–°å¹¶é‡æ–°åŠ è½½');
        }
        
        return newUrl;
      } catch (error) {
        console.error('âŒ é‡æ–°è·å–URLå¤±è´¥:', error);
        throw error;
      }
    }
  }
  
  throw new Error('åª’ä½“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
}

// ==========================================
// ä½¿ç”¨ç¤ºä¾‹
// ==========================================

// ç¤ºä¾‹1ï¼šå›¾ç‰‡é¢„è§ˆï¼ˆå¸¦è‡ªåŠ¨é‡è¯•ï¼‰
async function previewImage(uuid, filename) {
  try {
    const presignedUrl = await getPresignedUrl(uuid, filename);
    
    const img = document.createElement('img');
    img.src = presignedUrl;
    img.alt = filename;
    
    // æ·»åŠ é”™è¯¯å¤„ç†ï¼šURLè¿‡æœŸæ—¶è‡ªåŠ¨åˆ·æ–°
    img.onerror = async () => {
      try {
        img.onerror = null; // é˜²æ­¢å¾ªç¯
        const newUrl = await handleMediaError(null, uuid, filename, img);
        img.src = newUrl;
      } catch (error) {
        console.error('å›¾ç‰‡åŠ è½½å¤±è´¥:', error);
        alert('å›¾ç‰‡åŠ è½½å¤±è´¥: ' + error.message);
      }
    };
    
    document.body.appendChild(img);
  } catch (error) {
    console.error('è·å–å›¾ç‰‡URLå¤±è´¥:', error);
    alert('è·å–å›¾ç‰‡å¤±è´¥: ' + error.message);
  }
}

// ç¤ºä¾‹2ï¼šè§†é¢‘æ’­æ”¾ï¼ˆå¸¦è‡ªåŠ¨é‡è¯•ï¼‰
async function playVideo(uuid, filename) {
  try {
    const presignedUrl = await getPresignedUrl(uuid, filename);
    
    const video = document.createElement('video');
    video.controls = true;
    video.style.width = '100%';
    
    const source = document.createElement('source');
    source.src = presignedUrl;
    source.type = 'video/mp4';
    video.appendChild(source);
    
    // æ·»åŠ é”™è¯¯å¤„ç†ï¼šURLè¿‡æœŸæ—¶è‡ªåŠ¨åˆ·æ–°
    video.onerror = async () => {
      try {
        video.onerror = null; // é˜²æ­¢å¾ªç¯
        const currentTime = video.currentTime || 0;
        const newUrl = await handleMediaError(null, uuid, filename, video);
        video.src = newUrl;
        video.currentTime = currentTime; // æ¢å¤æ’­æ”¾ä½ç½®
        video.load();
      } catch (error) {
        console.error('è§†é¢‘åŠ è½½å¤±è´¥:', error);
        alert('è§†é¢‘åŠ è½½å¤±è´¥: ' + error.message);
      }
    };
    
    document.body.appendChild(video);
    video.play();
  } catch (error) {
    console.error('è·å–è§†é¢‘URLå¤±è´¥:', error);
    alert('è·å–è§†é¢‘å¤±è´¥: ' + error.message);
  }
}

// ç¤ºä¾‹3ï¼šæ–‡ä»¶ä¸‹è½½
async function downloadFile(uuid, filename) {
  try {
    const presignedUrl = await getPresignedUrl(uuid, filename);
    
    const a = document.createElement('a');
    a.href = presignedUrl;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    
    console.log('âœ… ä¸‹è½½å·²å¼€å§‹');
  } catch (error) {
    console.error('ä¸‹è½½å¤±è´¥:', error);
    alert('ä¸‹è½½å¤±è´¥: ' + error.message);
  }
}

// è¾…åŠ©å‡½æ•°
function formatFileSize(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
  if (bytes < 1024 * 1024 * 1024) return (bytes / 1024 / 1024).toFixed(2) + ' MB';
  return (bytes / 1024 / 1024 / 1024).toFixed(2) + ' GB';
}

function getFileInfo(uuid) {
  // ä»localStorageæˆ–å…¨å±€çŠ¶æ€è·å–æ–‡ä»¶ä¿¡æ¯
  const uploadedFiles = JSON.parse(localStorage.getItem('uploadedFiles') || '[]');
  return uploadedFiles.find(f => f.file_url && f.file_url.includes(uuid));
}
```

### æ ¸å¿ƒç‰¹æ€§è¯´æ˜

#### âœ… **è‡ªåŠ¨Tokenåˆ·æ–°**
- æ£€æµ‹åˆ°Tokenè¿‡æœŸæ—¶è‡ªåŠ¨è°ƒç”¨refreshæ¥å£
- åˆ·æ–°æˆåŠŸåè‡ªåŠ¨é‡è¯•åŸè¯·æ±‚
- æœ€å¤šé‡è¯•2æ¬¡ï¼Œé¿å…æ— é™å¾ªç¯

#### âœ… **æ™ºèƒ½ç¼“å­˜ç®¡ç†**
- ç¼“å­˜é¢„ç­¾åURLï¼Œé¿å…é‡å¤è¯·æ±‚
- è¿‡æœŸå‰5åˆ†é’Ÿè‡ªåŠ¨åˆ·æ–°
- å·²è¿‡æœŸçš„URLè‡ªåŠ¨æ¸…é™¤

#### âœ… **URLè¿‡æœŸè‡ªåŠ¨æ¢å¤**
- åª’ä½“åŠ è½½å¤±è´¥æ—¶è‡ªåŠ¨æ£€æµ‹æ˜¯å¦URLè¿‡æœŸ
- è¿‡æœŸæ—¶è‡ªåŠ¨é‡æ–°è·å–æ–°URL
- è§†é¢‘æ’­æ”¾æ—¶ä¿ç•™å½“å‰æ’­æ”¾ä½ç½®

#### âœ… **å®Œå–„çš„é”™è¯¯å¤„ç†**
- åŒºåˆ†ä¸åŒHTTPçŠ¶æ€ç ï¼ˆ401/403/404ï¼‰
- å®‰å…¨è§£æéJSONå“åº”
- å‹å¥½çš„é”™è¯¯æç¤ºä¿¡æ¯

#### âœ… **æ”¯æŒè¶…å¤§æ–‡ä»¶**
- è‡ªåŠ¨æ£€æµ‹æ–‡ä»¶å¤§å°
- è¶…è¿‡15GBæ—¶æç¤ºç”¨æˆ·è¾“å…¥ä¸‹è½½æ—¶é—´
- ä½¿ç”¨æ‰©å±•æ¥å£è·å–æ›´é•¿æœ‰æ•ˆæœŸ

---

### ç®€åŒ–ç‰ˆè°ƒç”¨ç¤ºä¾‹ï¼ˆå¿«é€Ÿå¼€å§‹ï¼‰

```javascript
// è·å–é¢„ç­¾åURLï¼ˆå¸¦ç¼“å­˜ï¼‰
async function getPresignedUrl(uuid, filename) {
  const accessToken = localStorage.getItem('access_token');
  
  // 1. æ£€æŸ¥ç¼“å­˜
  const cached = presignedUrlCache[uuid];
  if (cached && new Date(cached.expiresAt) > new Date(Date.now() + 300000)) {
    return cached.url; // è¿˜æœ‰5åˆ†é’Ÿä»¥ä¸Šï¼Œä½¿ç”¨ç¼“å­˜
  }
  
  // 2. è¯·æ±‚æ–°çš„é¢„ç­¾åURL
  const response = await fetch(
    `http://localhost:8080/api/storage/file/${uuid}/presigned_url`,
    {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        operation: 'download'
      })
    }
  );
  
  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.error || 'è·å–é¢„ç­¾åURLå¤±è´¥');
  }
  
  const data = await response.json();
  
  // 3. ç¼“å­˜URL
  presignedUrlCache[uuid] = {
    url: data.presigned_url,
    expiresAt: data.expires_at
  };
  
  return data.presigned_url;
}

// å›¾ç‰‡é¢„è§ˆç¤ºä¾‹
async function previewImage(uuid, filename) {
  const presignedUrl = await getPresignedUrl(uuid, filename);
  
  // ç›´æ¥ä½¿ç”¨é¢„ç­¾åURLä½œä¸ºimg src
  const img = document.createElement('img');
  img.src = presignedUrl;
  img.alt = filename;
  document.body.appendChild(img);
}

// è§†é¢‘æ’­æ”¾ç¤ºä¾‹ï¼ˆçœŸæ­£çš„æµå¼æ’­æ”¾ï¼‰
async function playVideo(uuid, filename) {
  const presignedUrl = await getPresignedUrl(uuid, filename);
  
  // ç›´æ¥ä½¿ç”¨é¢„ç­¾åURLä½œä¸ºvideo src
  const video = document.createElement('video');
  video.controls = true;
  const source = document.createElement('source');
  source.src = presignedUrl;
  source.type = 'video/mp4';
  video.appendChild(source);
  document.body.appendChild(video);
  
  // æ”¯æŒæ‹–åŠ¨è¿›åº¦æ¡ï¼Œæ”¯æŒRangeè¯·æ±‚
}

// æ–‡ä»¶ä¸‹è½½ç¤ºä¾‹
async function downloadFile(uuid, filename) {
  const presignedUrl = await getPresignedUrl(uuid, filename);
  
  // ä½¿ç”¨é¢„ç­¾åURLä¸‹è½½
  const a = document.createElement('a');
  a.href = presignedUrl;
  a.download = filename;
  a.click();
}
```

### cURL è°ƒç”¨ç¤ºä¾‹

```bash
# è·å–é¢„ç­¾åURL
curl -X POST "http://localhost:8080/api/storage/file/cb31fb54-770d-4198-84d6-18ce9c6d290f/presigned_url" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"operation": "download"}'

# ä½¿ç”¨è¿”å›çš„é¢„ç­¾åURLç›´æ¥ä¸‹è½½ï¼ˆæ— éœ€Authorizationï¼‰
curl "http://localhost:9000/user-file/alice/images/xxx.jpg?X-Amz-Signature=..." \
  -o downloaded_file.jpg
```

### æ³¨æ„äº‹é¡¹

1. **æƒé™éªŒè¯**
   - ç”ŸæˆURLå‰ä¼šéªŒè¯ç”¨æˆ·æ˜¯å¦æœ‰è®¿é—®æƒé™
   - æ£€æŸ¥ `file_access_permissions` è¡¨
   - æ— æƒé™è¿”å›403é”™è¯¯

2. **æœ‰æ•ˆæœŸç®¡ç†**
   - æ™®é€šæ–‡ä»¶å›ºå®š3å°æ—¶æœ‰æ•ˆæœŸ
   - URLè¿‡æœŸåéœ€è¦é‡æ–°è¯·æ±‚
   - å»ºè®®è¿‡æœŸå‰5åˆ†é’Ÿæé†’ç”¨æˆ·åˆ·æ–°

3. **ç¼“å­˜ç­–ç•¥**
   - å‰ç«¯åº”ç¼“å­˜é¢„ç­¾åURL
   - é¿å…é‡å¤è¯·æ±‚
   - æ£€æŸ¥è¿‡æœŸæ—¶é—´

4. **å®‰å…¨è€ƒé‡**
   - URLåœ¨æœ‰æ•ˆæœŸå†…å¯è¢«ä»»ä½•äººè®¿é—®
   - ä¸è¦åˆ†äº«ç»™æœªæˆæƒç”¨æˆ·
   - è¿‡æœŸåè‡ªåŠ¨å¤±æ•ˆ

---

## 6. ç”Ÿæˆæ‰©å±•é¢„ç­¾åURLï¼ˆè¶…å¤§æ–‡ä»¶ï¼‰â­ æ–°å¢

### æ¥å£ä¿¡æ¯

- **URL**: `/api/storage/file/{uuid}/presigned_url/extended`
- **æ–¹æ³•**: `POST`
- **éœ€è¦é‰´æƒ**: æ˜¯ï¼ˆBearer Tokenï¼‰

### åŠŸèƒ½è¯´æ˜

ä¸ºè¶…å¤§æ–‡ä»¶ï¼ˆâ‰¥ 15GBï¼‰ç”Ÿæˆè‡ªå®šä¹‰æœ‰æ•ˆæœŸçš„é¢„ç­¾åURLã€‚

**é€‚ç”¨åœºæ™¯**ï¼š
- å¤§å‹è§†é¢‘æ–‡ä»¶ï¼ˆ> 15GBï¼‰
- æ…¢é€Ÿç½‘ç»œä¸‹è½½
- éœ€è¦é•¿æ—¶é—´è®¿é—®çš„æ–‡ä»¶

### è¯·æ±‚å‚æ•°

**Path Parameter**:
- `uuid`: æ–‡ä»¶UUID

**Request Body**:
```json
{
  "operation": "download",
  "estimated_download_time": 86400
}
```

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| operation | string | å¦ | æ“ä½œç±»å‹ |
| estimated_download_time | number | æ˜¯ | é¢„è®¡ä¸‹è½½æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œæœ€å°‘10800ï¼ˆ3å°æ—¶ï¼‰ï¼Œæœ€å¤š604800ï¼ˆ7å¤©ï¼‰ |

### å“åº”ç¤ºä¾‹

```json
{
  "presigned_url": "http://localhost:9000/user-file/xxx?X-Amz-Signature=...",
  "expires_at": "2025-12-01T16:00:00+00:00",
  "file_uuid": "...",
  "file_size": 30000000000,
  "content_type": "video/mp4",
  "warning": "æ­¤é“¾æ¥å°†åœ¨24å°æ—¶åè¿‡æœŸ"
}
```

### Fetch API è°ƒç”¨ç¤ºä¾‹

```javascript
// è¶…å¤§æ–‡ä»¶é¢„ç­¾åURLè¯·æ±‚
async function getLargeFilePresignedUrl(uuid, filename, fileSize) {
  const accessToken = localStorage.getItem('access_token');
  
  // æ£€æµ‹æ˜¯å¦ä¸ºè¶…å¤§æ–‡ä»¶ï¼ˆ15GBé˜ˆå€¼ï¼‰
  const LARGE_FILE_THRESHOLD = 15 * 1024 * 1024 * 1024;
  
  if (fileSize >= LARGE_FILE_THRESHOLD) {
    // æç¤ºç”¨æˆ·è¾“å…¥é¢„è®¡ä¸‹è½½æ—¶é—´
    const hours = prompt(
      `æ£€æµ‹åˆ°å¤§æ–‡ä»¶ï¼ˆ${formatFileSize(fileSize)}ï¼‰\nè¯·è¾“å…¥é¢„è®¡ä¸‹è½½æ—¶é—´ï¼ˆå°æ—¶ï¼Œæœ€å°‘3ï¼Œæœ€å¤š168ï¼‰:`,
      '6'
    );
    
    if (!hours || parseInt(hours) < 3) {
      throw new Error('å·²å–æ¶ˆæˆ–æ—¶é—´æ— æ•ˆ');
    }
    
    const estimatedSeconds = Math.min(parseInt(hours) * 3600, 604800);
    
    const response = await fetch(
      `http://localhost:8080/api/storage/file/${uuid}/presigned_url/extended`,
      {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${accessToken}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          operation: 'download',
          estimated_download_time: estimatedSeconds
        })
      }
    );
    
    const data = await response.json();
    if (data.warning) {
      console.warn(data.warning);
    }
    
    return data.presigned_url;
  }
}
```

### æ³¨æ„äº‹é¡¹

1. **æ—¶é—´é™åˆ¶**
   - æœ€å°‘ï¼š3å°æ—¶ï¼ˆ10800ç§’ï¼‰
   - æœ€å¤šï¼š7å¤©ï¼ˆ604800ç§’ï¼‰
   - è¶…å‡ºèŒƒå›´è¿”å›é”™è¯¯

2. **ç”¨æˆ·ä½“éªŒ**
   - éœ€è¦ç”¨æˆ·æ‰‹åŠ¨è¾“å…¥ä¸‹è½½æ—¶é—´
   - æä¾›åˆç†çš„é»˜è®¤å€¼å»ºè®®
   - æ˜¾ç¤ºè­¦å‘Šä¿¡æ¯

3. **æ–‡ä»¶å¤§å°é˜ˆå€¼**
   - å»ºè®®15GBä½œä¸ºåˆ†ç•Œçº¿
   - æ™®é€šæ–‡ä»¶ä½¿ç”¨æ ‡å‡†æ¥å£
   - è¶…å¤§æ–‡ä»¶ä½¿ç”¨æ‰©å±•æ¥å£

---

## é¢„ç­¾åURL vs UUIDç›´æ¥è®¿é—®å¯¹æ¯”

| ç‰¹æ€§ | UUIDç›´æ¥è®¿é—® | é¢„ç­¾åURL |
|------|-------------|-----------|
| **åç«¯å‹åŠ›** | âš ï¸ æ‰€æœ‰æµé‡ç»è¿‡åç«¯ | âœ… ç›´è¿MinIOï¼Œé›¶å‹åŠ› |
| **è§†é¢‘æ’­æ”¾** | âŒ éœ€å®Œæ•´ä¸‹è½½ | âœ… çœŸæ­£æµå¼ï¼Œå¯æ‹–åŠ¨ |
| **Rangeè¯·æ±‚** | âŒ ä¸æ”¯æŒ | âœ… æ”¯æŒ |
| **æµè§ˆå™¨ç¼“å­˜** | âŒ ä¸å¯ç¼“å­˜ | âœ… å¯ç¼“å­˜ |
| **æƒé™éªŒè¯** | âœ… å®æ—¶éªŒè¯ | âš ï¸ æ—¶æ•ˆæ€§éªŒè¯ |
| **å®‰å…¨æ€§** | âœ… å¯éšæ—¶æ’¤é”€ | âš ï¸ è¿‡æœŸå‰æœ‰æ•ˆ |
| **ä»£ç å¤æ‚åº¦** | å¤æ‚ | ç®€å• |

**æ¨èä½¿ç”¨é¢„ç­¾åURL**ç”¨äºï¼š
- å›¾ç‰‡/è§†é¢‘é¢„è§ˆ
- å¤§æ–‡ä»¶ä¸‹è½½
- éœ€è¦æµå¼æ’­æ”¾çš„åœºæ™¯

**UUIDç›´æ¥è®¿é—®å·²åºŸå¼ƒ**ï¼Œå»ºè®®å…¨éƒ¨ä½¿ç”¨é¢„ç­¾åURLæ–¹æ¡ˆã€‚

---

## 7. æŸ¥è¯¢ä¸ªäººæ–‡ä»¶åˆ—è¡¨ â­ æ–°å¢

### æ¥å£ä¿¡æ¯

- **URL**: `/api/storage/files`
- **æ–¹æ³•**: `GET`
- **éœ€è¦é‰´æƒ**: æ˜¯ï¼ˆBearer Tokenï¼‰

### åŠŸèƒ½è¯´æ˜

æŸ¥è¯¢å½“å‰ç”¨æˆ·æœ‰æƒè®¿é—®çš„æ‰€æœ‰æ–‡ä»¶åˆ—è¡¨ï¼Œæ”¯æŒåˆ†é¡µã€æ’åºåŠŸèƒ½ã€‚åŸºäºæƒé™è¡¨æŸ¥è¯¢ï¼Œåªè¿”å›ç”¨æˆ·æœ‰è®¿é—®æƒé™çš„æ–‡ä»¶ã€‚

**é€‚ç”¨åœºæ™¯**ï¼š
- ä¸ªäººæ–‡ä»¶ç®¡ç†é¡µé¢
- å†å²ä¸Šä¼ è®°å½•æŸ¥è¯¢
- å­˜å‚¨ç©ºé—´ä½¿ç”¨ç»Ÿè®¡
- æ–‡ä»¶æ‰¹é‡ç®¡ç†

### è¯·æ±‚å‚æ•°

Query Parameters:

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| page | number | å¦ | é¡µç ï¼ˆä»1å¼€å§‹ï¼‰ï¼Œé»˜è®¤1 |
| limit | number | å¦ | æ¯é¡µæ•°é‡ï¼Œé»˜è®¤20ï¼Œæœ€å¤§100 |
| sort_by | string | å¦ | æ’åºå­—æ®µï¼šcreated_atï¼ˆé»˜è®¤ï¼‰ã€file_size |
| sort_order | string | å¦ | æ’åºæ–¹å‘ï¼šdescï¼ˆé»˜è®¤ï¼‰ã€asc |

### å“åº”ç¤ºä¾‹

**æˆåŠŸå“åº”**:
```json
{
  "files": [
    {
      "file_uuid": "f5f23929-1689-4b04-98e7-0073fac1eea4",
      "filename": "example.jpg",
      "file_size": 1048576,
      "content_type": "image/jpeg",
      "preview_support": "inline_preview",
      "created_at": "2025-11-30T10:00:00Z",
      "file_url": "http://localhost:8080/api/storage/file/f5f23929-1689-4b04-98e7-0073fac1eea4"
    },
    {
      "file_uuid": "a3c2e1f0-2345-4567-89ab-cdef01234567",
      "filename": "video.mp4",
      "file_size": 52428800,
      "content_type": "video/mp4",
      "preview_support": "inline_preview",
      "created_at": "2025-11-30T09:30:00Z",
      "file_url": "http://localhost:8080/api/storage/file/a3c2e1f0-2345-4567-89ab-cdef01234567"
    }
  ],
  "total": 45,
  "page": 1,
  "page_size": 20,
  "total_pages": 3,
  "has_more": true
}
```

**ç©ºåˆ—è¡¨å“åº”**:
```json
{
  "files": [],
  "total": 0,
  "page": 1,
  "page_size": 20,
  "total_pages": 0,
  "has_more": false
}
```

### Fetch API è°ƒç”¨ç¤ºä¾‹

```javascript
// æŸ¥è¯¢æ–‡ä»¶åˆ—è¡¨ï¼ˆåŸºç¡€ï¼‰
async function listUserFiles() {
  const accessToken = localStorage.getItem('access_token');
  
  const response = await fetch('http://localhost:8080/api/storage/files', {
    method: 'GET',
    headers: {
      'Authorization': `Bearer ${accessToken}`
    }
  });
  
  if (!response.ok) {
    throw new Error('æŸ¥è¯¢å¤±è´¥');
  }
  
  const data = await response.json();
  console.log(`å…± ${data.total} ä¸ªæ–‡ä»¶`);
  return data;
}

// æŸ¥è¯¢æ–‡ä»¶åˆ—è¡¨ï¼ˆå¸¦åˆ†é¡µå’Œæ’åºï¼‰
async function listUserFilesWithParams(page = 1, limit = 20, sortBy = 'created_at', sortOrder = 'desc') {
  const accessToken = localStorage.getItem('access_token');
  
  const params = new URLSearchParams({
    page: page.toString(),
    limit: limit.toString(),
    sort_by: sortBy,
    sort_order: sortOrder
  });
  
  const response = await fetch(
    `http://localhost:8080/api/storage/files?${params}`,
    {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${accessToken}`
      }
    }
  );
  
  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.error || 'æŸ¥è¯¢å¤±è´¥');
  }
  
  return await response.json();
}

// ä½¿ç”¨ç¤ºä¾‹1ï¼šæŸ¥è¯¢ç¬¬ä¸€é¡µ
async function example1() {
  try {
    const result = await listUserFiles();
    console.log('æ–‡ä»¶åˆ—è¡¨:', result.files);
    console.log(`ç¬¬ ${result.page}/${result.total_pages} é¡µ`);
  } catch (error) {
    console.error('æŸ¥è¯¢å¤±è´¥:', error);
  }
}

// ä½¿ç”¨ç¤ºä¾‹2ï¼šæŸ¥è¯¢ç¬¬2é¡µï¼ŒæŒ‰æ–‡ä»¶å¤§å°é™åº
async function example2() {
  try {
    const result = await listUserFilesWithParams(2, 20, 'file_size', 'desc');
    result.files.forEach(file => {
      console.log(`${file.filename}: ${formatFileSize(file.file_size)}`);
    });
  } catch (error) {
    console.error('æŸ¥è¯¢å¤±è´¥:', error);
  }
}

// ä½¿ç”¨ç¤ºä¾‹3ï¼šåˆ†é¡µåŠ è½½ï¼ˆæ— é™æ»šåŠ¨ï¼‰
async function loadMoreFiles() {
  let page = 1;
  let allFiles = [];
  
  while (true) {
    const result = await listUserFilesWithParams(page, 50);
    allFiles = allFiles.concat(result.files);
    
    console.log(`å·²åŠ è½½ ${allFiles.length}/${result.total} ä¸ªæ–‡ä»¶`);
    
    if (!result.has_more) {
      break;
    }
    
    page++;
  }
  
  return allFiles;
}

// è¾…åŠ©å‡½æ•°ï¼šæ ¼å¼åŒ–æ–‡ä»¶å¤§å°
function formatFileSize(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
  if (bytes < 1024 * 1024 * 1024) return (bytes / 1024 / 1024).toFixed(2) + ' MB';
  return (bytes / 1024 / 1024 / 1024).toFixed(2) + ' GB';
}
```

### cURL è°ƒç”¨ç¤ºä¾‹

```bash
# æŸ¥è¯¢ç¬¬ä¸€é¡µï¼ˆé»˜è®¤å‚æ•°ï¼‰
curl -X GET "http://localhost:8080/api/storage/files" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"

# æŸ¥è¯¢ç¬¬2é¡µï¼Œæ¯é¡µ10æ¡
curl -X GET "http://localhost:8080/api/storage/files?page=2&limit=10" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"

# æŒ‰æ–‡ä»¶å¤§å°é™åºæ’åº
curl -X GET "http://localhost:8080/api/storage/files?sort_by=file_size&sort_order=desc" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"

# ç»„åˆæŸ¥è¯¢ï¼šç¬¬3é¡µï¼Œæ¯é¡µ50æ¡ï¼ŒæŒ‰åˆ›å»ºæ—¶é—´å‡åº
curl -X GET "http://localhost:8080/api/storage/files?page=3&limit=50&sort_by=created_at&sort_order=asc" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"
```

### å“åº”å­—æ®µè¯´æ˜

#### FileItem å­—æ®µ

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| file_uuid | string | æ–‡ä»¶UUIDæ ‡è¯†ï¼Œç”¨äºè®¿é—®æ–‡ä»¶ |
| filename | string | åŸå§‹æ–‡ä»¶å |
| file_size | number | æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰ |
| content_type | string | MIMEç±»å‹ |
| preview_support | string | é¢„è§ˆæ”¯æŒï¼šinline_preview æˆ– download_only |
| created_at | string | åˆ›å»ºæ—¶é—´ï¼ˆISO 8601æ ¼å¼ï¼‰ |
| file_url | string | æ–‡ä»¶è®¿é—®URLï¼ˆUUIDæ ¼å¼ï¼‰ |

#### åˆ†é¡µå­—æ®µ

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| files | array | æ–‡ä»¶åˆ—è¡¨ |
| total | number | æ€»æ–‡ä»¶æ•° |
| page | number | å½“å‰é¡µç  |
| page_size | number | æ¯é¡µæ•°é‡ |
| total_pages | number | æ€»é¡µæ•° |
| has_more | boolean | æ˜¯å¦è¿˜æœ‰æ›´å¤šæ•°æ® |

### æ³¨æ„äº‹é¡¹

1. **æƒé™è¿‡æ»¤**
   - åªè¿”å›ç”¨æˆ·æœ‰æƒè®¿é—®çš„æ–‡ä»¶
   - åŸºäº `file_access_permissions` è¡¨æŸ¥è¯¢
   - å·²æ’¤é”€æƒé™çš„æ–‡ä»¶ä¸ä¼šå‡ºç°

2. **åˆ†é¡µé™åˆ¶**
   - æœ€å°é¡µç ï¼š1
   - æœ€å°æ¯é¡µæ•°é‡ï¼š1
   - æœ€å¤§æ¯é¡µæ•°é‡ï¼š100
   - è¶…å‡ºèŒƒå›´ä¼šè‡ªåŠ¨è°ƒæ•´

3. **æ’åºå­—æ®µ**
   - `created_at`ï¼šæŒ‰åˆ›å»ºæ—¶é—´æ’åºï¼ˆé»˜è®¤ï¼‰
   - `file_size`ï¼šæŒ‰æ–‡ä»¶å¤§å°æ’åº
   - å…¶ä»–å€¼ä¼šä½¿ç”¨é»˜è®¤æ’åº

4. **æ€§èƒ½ä¼˜åŒ–**
   - æ•°æ®åº“å·²å»ºç«‹ç´¢å¼•ï¼ŒæŸ¥è¯¢æ€§èƒ½è‰¯å¥½
   - å»ºè®®æ¯é¡µ20-50æ¡ï¼Œé¿å…ä¸€æ¬¡åŠ è½½è¿‡å¤š
   - ä½¿ç”¨ `has_more` å­—æ®µåˆ¤æ–­æ˜¯å¦éœ€è¦ç»§ç»­åŠ è½½

5. **æ–‡ä»¶è®¿é—®**
   - è¿”å›çš„ `file_url` æ˜¯UUIDæ ¼å¼
   - éœ€è¦é…åˆé¢„ç­¾åURLæ¥å£è·å–å®é™…ä¸‹è½½é“¾æ¥
   - æˆ–ç›´æ¥ä½¿ç”¨UUIDè®¿é—®æ¥å£

### é”™è¯¯å¤„ç†

```javascript
async function listFilesWithErrorHandling() {
  try {
    const accessToken = localStorage.getItem('access_token');
    
    if (!accessToken) {
      throw new Error('æœªç™»å½•ï¼Œè¯·å…ˆç™»å½•');
    }
    
    const response = await fetch('http://localhost:8080/api/storage/files', {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${accessToken}`
      }
    });
    
    if (!response.ok) {
      if (response.status === 401) {
        throw new Error('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
      } else if (response.status === 500) {
        throw new Error('æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
      } else {
        const error = await response.json();
        throw new Error(error.error || 'æŸ¥è¯¢å¤±è´¥');
      }
    }
    
    return await response.json();
    
  } catch (error) {
    console.error('æŸ¥è¯¢æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', error);
    throw error;
  }
}
```

### å®Œæ•´çš„UIé›†æˆç¤ºä¾‹

```javascript
// Vue.js ç¤ºä¾‹
export default {
  data() {
    return {
      files: [],
      loading: false,
      currentPage: 1,
      pageSize: 20,
      total: 0,
      sortBy: 'created_at',
      sortOrder: 'desc',
    };
  },
  
  computed: {
    totalPages() {
      return Math.ceil(this.total / this.pageSize);
    }
  },
  
  methods: {
    async loadFiles() {
      this.loading = true;
      
      try {
        const accessToken = localStorage.getItem('access_token');
        const params = new URLSearchParams({
          page: this.currentPage.toString(),
          limit: this.pageSize.toString(),
          sort_by: this.sortBy,
          sort_order: this.sortOrder,
        });
        
        const response = await fetch(
          `http://localhost:8080/api/storage/files?${params}`,
          {
            headers: {
              'Authorization': `Bearer ${accessToken}`
            }
          }
        );
        
        const data = await response.json();
        this.files = data.files;
        this.total = data.total;
        
      } catch (error) {
        console.error('åŠ è½½å¤±è´¥:', error);
        alert('åŠ è½½æ–‡ä»¶åˆ—è¡¨å¤±è´¥');
      } finally {
        this.loading = false;
      }
    },
    
    changePage(page) {
      this.currentPage = page;
      this.loadFiles();
    },
    
    changeSort(field) {
      if (this.sortBy === field) {
        this.sortOrder = this.sortOrder === 'asc' ? 'desc' : 'asc';
      } else {
        this.sortBy = field;
        this.sortOrder = 'desc';
      }
      this.currentPage = 1;
      this.loadFiles();
    }
  },
  
  mounted() {
    this.loadFiles();
  }
};
```

---

## 8. å¥½å‹æ–‡ä»¶ä¸Šä¼  â­ æ–°å¢

### åŠŸèƒ½è¯´æ˜

å¥½å‹æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½å¤ç”¨ä¸ªäººæ–‡ä»¶çš„ä¸Šä¼ æœºåˆ¶ï¼Œä½†æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š
- **å­˜å‚¨è·¯å¾„**ï¼š`friends-file/{conversation-uuid}/{type}/{filename}`
- **æƒé™æˆäºˆ**ï¼šä¸Šä¼ å®Œæˆåè‡ªåŠ¨æˆæƒåŒæ–¹è®¿é—®
- **ç§’ä¼ èŒƒå›´**ï¼šå…¨å±€èŒƒå›´ï¼ˆä¸ä¸ªäººæ–‡ä»¶ä¸€è‡´ï¼‰
- **å¥½å‹éªŒè¯**ï¼šä¸Šä¼ æ—¶éªŒè¯å¥½å‹å…³ç³»
- **è‡ªåŠ¨æ¶ˆæ¯**ï¼šconfirmåè‡ªåŠ¨å‘é€æ¶ˆæ¯å¹¶è§¦å‘WebSocketé€šçŸ¥

### ä¸Šä¼ æµç¨‹

1. **è¯·æ±‚ä¸Šä¼ **ï¼šæŒ‡å®š `storage_location: "friend_messages"`ï¼Œ`related_id: "å¥½å‹ID"`
2. **éªŒè¯å¥½å‹å…³ç³»**ï¼šåç«¯è‡ªåŠ¨éªŒè¯
3. **é¢„ç­¾åç›´ä¼ **ï¼šä½¿ç”¨è¿”å›çš„ `presigned_url` ç›´ä¼ åˆ°MinIO
4. **ç¡®è®¤ä¸Šä¼ **ï¼šè°ƒç”¨confirmæ¥å£ï¼Œè‡ªåŠ¨å‘é€æ¶ˆæ¯å’Œè§¦å‘é€šçŸ¥
5. **è‡ªåŠ¨æˆæƒ**ï¼šä¸Šä¼ å®Œæˆåè‡ªåŠ¨æˆæƒå¥½å‹è®¿é—®

### è¯·æ±‚ç¤ºä¾‹

```javascript
// å¥½å‹æ–‡ä»¶ä¸Šä¼ ï¼ˆå®Œæ•´æµç¨‹ï¼‰
async function uploadFriendFile(file, friendId, onProgress) {
  const accessToken = localStorage.getItem('access_token');
  
  // 1. è®¡ç®—æ–‡ä»¶å“ˆå¸Œ
  const fileHash = await calculateSHA256(file);
  
  // 2. ç¡®å®šfile_type
  let file_type;
  if (file.type.startsWith('image/')) file_type = 'friend_image';
  else if (file.type.startsWith('video/')) file_type = 'friend_video';
  else file_type = 'friend_document';
  
  // 3. è¯·æ±‚ä¸Šä¼ URL
  const response = await fetch('/api/storage/upload/request', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${accessToken}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      file_type: file_type,                // friend_image/friend_video/friend_document
      storage_location: 'friend_messages', // å¿…é¡»æŒ‡å®šä¸ºå¥½å‹æ¶ˆæ¯
      related_id: friendId,                // å¥½å‹ç”¨æˆ·IDï¼ˆå¿…å¡«ï¼ï¼‰
      filename: file.name,
      file_size: file.size,
      content_type: file.type,
      file_hash: fileHash,
      force_upload: false
    })
  });
  
  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.error || 'è¯·æ±‚ä¸Šä¼ å¤±è´¥');
  }
  
  const uploadInfo = await response.json();
  
  // 4. æ£€æŸ¥ç§’ä¼ ï¼ˆç§’ä¼ æ—¶åç«¯å·²è‡ªåŠ¨å‘é€æ¶ˆæ¯ï¼‰
  if (uploadInfo.instant_upload) {
    console.log('ç§’ä¼ æˆåŠŸï¼æ¶ˆæ¯å·²è‡ªåŠ¨å‘é€');
    return {
      file_uuid: uploadInfo.existing_file_url.split('/').pop(),
      file_url: uploadInfo.existing_file_url,
      message_uuid: uploadInfo.message_uuid
    };
  }
  
  // 5. é¢„ç­¾åPUTç›´ä¼ åˆ°MinIO
  await uploadWithProgress(file, uploadInfo.presigned_url, onProgress);
  
  // 6. ç¡®è®¤ä¸Šä¼ ï¼ˆè‡ªåŠ¨å‘é€æ¶ˆæ¯+WebSocketé€šçŸ¥ï¼‰
  const confirmResult = await confirmUpload(uploadInfo.file_key);
  
  return {
    file_uuid: confirmResult.file_url.split('/').pop(),
    file_url: confirmResult.file_url,
    message_uuid: confirmResult.message_uuid
  };
}
```

### å‘é€å¸¦æ–‡ä»¶çš„æ¶ˆæ¯

```javascript
// å‘é€å›¾ç‰‡/è§†é¢‘/æ–‡ä»¶æ¶ˆæ¯ï¼ˆä¸Šä¼ å®Œæˆåè‡ªåŠ¨å‘é€æ¶ˆæ¯ï¼‰
async function sendFileMessage(friendId, file, onProgress) {
  // ä¸Šä¼ å®Œæˆåconfirmä¼šè‡ªåŠ¨å‘é€æ¶ˆæ¯
  const result = await uploadFriendFile(file, friendId, onProgress);
  
  console.log('æ–‡ä»¶æ¶ˆæ¯å·²å‘é€:', result.message_uuid);
  return result;
}

// ä½¿ç”¨ç¤ºä¾‹
const fileInput = document.querySelector('#file-input');
fileInput.addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  
  const friendId = 'target_user_id';
  const progressBar = document.querySelector('.progress-bar');
  
  try {
    const result = await sendFileMessage(friendId, file, (percent) => {
      progressBar.style.width = percent + '%';
    });
    
    console.log('å‘é€æˆåŠŸï¼æ¶ˆæ¯UUID:', result.message_uuid);
    // WebSocketä¼šè‡ªåŠ¨æ¨é€æ¶ˆæ¯ç»™å¯¹æ–¹
  } catch (error) {
    console.error('å‘é€å¤±è´¥:', error.message);
  }
});
```

### é”™è¯¯å¤„ç†

| é”™è¯¯ | çŠ¶æ€ç  | è¯´æ˜ |
|------|--------|------|
| å¥½å‹IDä¸èƒ½ä¸ºç©º | 400 | `related_id` æœªæä¾› |
| ä¸æ˜¯å¥½å‹å…³ç³»ï¼Œæ— æ³•ä¸Šä¼ æ–‡ä»¶ | 400 | åŒæ–¹ä¸æ˜¯å¥½å‹ |

---

## 9. å¥½å‹æ–‡ä»¶é¢„ç­¾åURL â­ æ–°å¢

### æ¥å£ä¿¡æ¯

- **URL**: `/api/storage/friends-file/{uuid}/presigned-url`
- **æ–¹æ³•**: `POST`
- **éœ€è¦é‰´æƒ**: æ˜¯ï¼ˆBearer Tokenï¼‰

### åŠŸèƒ½è¯´æ˜

ç”Ÿæˆå¥½å‹æ–‡ä»¶çš„é¢„ç­¾åä¸‹è½½URLï¼Œæ”¯æŒå›¾ç‰‡é¢„è§ˆã€è§†é¢‘æµå¼æ’­æ”¾ã€æ–‡ä»¶ä¸‹è½½ã€‚

**è®¿é—®éªŒè¯æµç¨‹**ï¼š
1. éªŒè¯ç”¨æˆ·Token
2. æŸ¥è¯¢æ–‡ä»¶UUIDæ˜ å°„
3. éªŒè¯ç”¨æˆ·æ˜¯ä¼šè¯å‚ä¸è€…
4. **å®æ—¶éªŒè¯å¥½å‹å…³ç³»**ï¼ˆåˆ é™¤å¥½å‹åæ— æ³•è®¿é—®ï¼‰
5. ç”Ÿæˆé¢„ç­¾åURL

### è¯·æ±‚å‚æ•°

**Path Parameter**:
- `uuid`: æ–‡ä»¶UUIDï¼ˆä»æ¶ˆæ¯ä¸­è·å–çš„ `file_uuid`ï¼‰

**Request Body**:
```json
{
  "operation": "preview",
  "expires_in": 10800
}
```

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| operation | string | å¦ | æ“ä½œç±»å‹ï¼š"download" æˆ– "preview"ï¼Œé»˜è®¤ "download" |
| expires_in | number | å¦ | æœ‰æ•ˆæœŸï¼ˆç§’ï¼‰ï¼Œé»˜è®¤10800ï¼ˆ3å°æ—¶ï¼‰ï¼Œæœ€å¤§10800 |

### å“åº”ç¤ºä¾‹

**æˆåŠŸå“åº”**:
```json
{
  "presigned_url": "http://localhost:9000/friends-file/conv-alice-bob/images/xxx.jpg?X-Amz-Signature=...",
  "expires_at": "2025-12-03T15:30:00+00:00",
  "file_uuid": "d2f612d5-70b0-4d4e-8779-86cf6aeb2b30",
  "file_size": 1048576,
  "content_type": "image/jpeg",
  "warning": null
}
```

**é”™è¯¯å“åº”**:
```json
{
  "error": "å¥½å‹å…³ç³»å·²è§£é™¤ï¼Œæ— æ³•è®¿é—®æ–‡ä»¶"
}
```

### Fetch API è°ƒç”¨ç¤ºä¾‹

```javascript
// è·å–å¥½å‹æ–‡ä»¶é¢„ç­¾åURL
async function getFriendFilePresignedUrl(fileUuid) {
  const accessToken = localStorage.getItem('access_token');
  
  const response = await fetch(
    `/api/storage/friends-file/${fileUuid}/presigned-url`,
    {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        operation: 'preview',
        expires_in: 10800
      })
    }
  );
  
  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.error || 'è·å–é¢„ç­¾åURLå¤±è´¥');
  }
  
  const data = await response.json();
  return data.presigned_url;
}

// é¢„è§ˆèŠå¤©å›¾ç‰‡
async function previewChatImage(fileUuid) {
  try {
    const presignedUrl = await getFriendFilePresignedUrl(fileUuid);
    
    const img = document.createElement('img');
    img.src = presignedUrl;
    img.alt = 'èŠå¤©å›¾ç‰‡';
    document.body.appendChild(img);
  } catch (error) {
    if (error.message.includes('å¥½å‹å…³ç³»å·²è§£é™¤')) {
      alert('å¥½å‹å…³ç³»å·²è§£é™¤ï¼Œæ— æ³•æŸ¥çœ‹æ–‡ä»¶');
    } else {
      alert('åŠ è½½å¤±è´¥: ' + error.message);
    }
  }
}

// æ’­æ”¾èŠå¤©è§†é¢‘ï¼ˆæ”¯æŒæµå¼ä¼ è¾“ï¼‰
async function playChatVideo(fileUuid) {
  try {
    const presignedUrl = await getFriendFilePresignedUrl(fileUuid);
    
    const video = document.createElement('video');
    video.controls = true;
    video.style.width = '100%';
    
    const source = document.createElement('source');
    source.src = presignedUrl;
    source.type = 'video/mp4';
    video.appendChild(source);
    
    document.body.appendChild(video);
    video.play();
  } catch (error) {
    alert('æ’­æ”¾å¤±è´¥: ' + error.message);
  }
}
```

### cURL è°ƒç”¨ç¤ºä¾‹

```bash
# è·å–å¥½å‹æ–‡ä»¶é¢„ç­¾åURL
curl -X POST "http://localhost:8080/api/storage/friends-file/d2f612d5-70b0-4d4e-8779-86cf6aeb2b30/presigned-url" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"operation": "preview"}'
```

### é”™è¯¯å¤„ç†

| é”™è¯¯ | çŠ¶æ€ç  | è¯´æ˜ |
|------|--------|------|
| æ–‡ä»¶ä¸å­˜åœ¨ | 404 | UUIDæ— æ•ˆæˆ–æ–‡ä»¶å·²åˆ é™¤ |
| æ— æƒè®¿é—®æ­¤æ–‡ä»¶ | 403 | ä¸æ˜¯ä¼šè¯å‚ä¸è€… |
| å¥½å‹å…³ç³»å·²è§£é™¤ï¼Œæ— æ³•è®¿é—®æ–‡ä»¶ | 403 | åŒæ–¹å·²ä¸æ˜¯å¥½å‹ |
| æ™®é€šæ–‡ä»¶é¢„ç­¾åURLæœ€é•¿æœ‰æ•ˆæœŸä¸º3å°æ—¶ | 400 | expires_in è¶…è¿‡é™åˆ¶ |

---

## 10. å¥½å‹æ–‡ä»¶æ‰©å±•é¢„ç­¾åURL â­ æ–°å¢

### æ¥å£ä¿¡æ¯

- **URL**: `/api/storage/friends-file/{uuid}/presigned-url/extended`
- **æ–¹æ³•**: `POST`
- **éœ€è¦é‰´æƒ**: æ˜¯ï¼ˆBearer Tokenï¼‰

### åŠŸèƒ½è¯´æ˜

ä¸ºå¥½å‹è¶…å¤§æ–‡ä»¶ï¼ˆâ‰¥ 15GBï¼‰ç”Ÿæˆè‡ªå®šä¹‰æœ‰æ•ˆæœŸçš„é¢„ç­¾åURLã€‚

### è¯·æ±‚å‚æ•°

```json
{
  "operation": "download",
  "estimated_download_time": 86400
}
```

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| operation | string | å¦ | æ“ä½œç±»å‹ |
| estimated_download_time | number | æ˜¯ | é¢„è®¡ä¸‹è½½æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œæœ€å°‘10800ï¼ˆ3å°æ—¶ï¼‰ï¼Œæœ€å¤š604800ï¼ˆ7å¤©ï¼‰ |

### å“åº”ç¤ºä¾‹

```json
{
  "presigned_url": "http://localhost:9000/friends-file/conv-xxx/videos/large.mp4?X-Amz-Signature=...",
  "expires_at": "2025-12-04T12:00:00+00:00",
  "file_uuid": "...",
  "file_size": 30000000000,
  "content_type": "video/mp4",
  "warning": "æ­¤é“¾æ¥å°†åœ¨24å°æ—¶åè¿‡æœŸ"
}
```

### Fetch API è°ƒç”¨ç¤ºä¾‹

```javascript
// è¶…å¤§å¥½å‹æ–‡ä»¶é¢„ç­¾åURLè¯·æ±‚
async function getLargeFriendFilePresignedUrl(fileUuid, estimatedHours = 6) {
  const accessToken = localStorage.getItem('access_token');
  const estimatedSeconds = Math.min(estimatedHours * 3600, 604800);
  
  const response = await fetch(
    `http://localhost:8080/api/storage/friends-file/${fileUuid}/presigned-url/extended`,
    {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        operation: 'download',
        estimated_download_time: estimatedSeconds
      })
    }
  );
  
  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.error || 'è·å–é¢„ç­¾åURLå¤±è´¥');
  }
  
  const data = await response.json();
  if (data.warning) {
    console.warn(data.warning);
  }
  
  return data.presigned_url;
}
```

---

## å®Œæ•´å¥½å‹æ–‡ä»¶ä½¿ç”¨æµç¨‹

```javascript
// å®Œæ•´çš„å¥½å‹æ–‡ä»¶å¤„ç†æµç¨‹
class FriendFileManager {
  constructor() {
    this.presignedUrlCache = {};
  }
  
  // ä¸Šä¼ å¥½å‹æ–‡ä»¶
  async uploadFile(file, friendId) {
    return await uploadFriendFile(file, friendId);
  }
  
  // å‘é€æ–‡ä»¶æ¶ˆæ¯
  async sendFileMessage(friendId, file, messageType = 'image') {
    const { file_uuid } = await this.uploadFile(file, friendId);
    
    const accessToken = localStorage.getItem('access_token');
    const response = await fetch('http://localhost:8080/api/messages', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        receiver_id: friendId,
        message_type: messageType,
        message_content: file.name,
        file_uuid: file_uuid
      })
    });
    
    return await response.json();
  }
  
  // è·å–é¢„ç­¾åURLï¼ˆå¸¦ç¼“å­˜ï¼‰
  async getPresignedUrl(fileUuid) {
    // æ£€æŸ¥ç¼“å­˜
    const cached = this.presignedUrlCache[fileUuid];
    if (cached && new Date(cached.expiresAt) > new Date(Date.now() + 300000)) {
      return cached.url;
    }
    
    const accessToken = localStorage.getItem('access_token');
    const response = await fetch(
      `http://localhost:8080/api/storage/friends-file/${fileUuid}/presigned-url`,
      {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${accessToken}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ operation: 'preview' })
      }
    );
    
    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.error);
    }
    
    const data = await response.json();
    
    // ç¼“å­˜URL
    this.presignedUrlCache[fileUuid] = {
      url: data.presigned_url,
      expiresAt: data.expires_at
    };
    
    return data.presigned_url;
  }
  
  // é¢„è§ˆå›¾ç‰‡
  async previewImage(fileUuid, container) {
    const url = await this.getPresignedUrl(fileUuid);
    const img = document.createElement('img');
    img.src = url;
    container.appendChild(img);
  }
  
  // æ’­æ”¾è§†é¢‘
  async playVideo(fileUuid, container) {
    const url = await this.getPresignedUrl(fileUuid);
    const video = document.createElement('video');
    video.controls = true;
    video.src = url;
    container.appendChild(video);
    video.play();
  }
  
  // ä¸‹è½½æ–‡ä»¶
  async downloadFile(fileUuid, filename) {
    const url = await this.getPresignedUrl(fileUuid);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const fileManager = new FriendFileManager();

// å‘é€å›¾ç‰‡
const fileInput = document.querySelector('#file-input');
fileInput.addEventListener('change', async (e) => {
  const file = e.target.files[0];
  const friendId = 'bob';
  
  try {
    await fileManager.sendFileMessage(friendId, file, 'image');
    alert('å‘é€æˆåŠŸï¼');
  } catch (error) {
    alert('å‘é€å¤±è´¥: ' + error.message);
  }
});

// é¢„è§ˆæ¶ˆæ¯ä¸­çš„å›¾ç‰‡
async function renderChatMessage(message) {
  if (message.message_type === 'image' && message.file_uuid) {
    const container = document.getElementById('chat-container');
    await fileManager.previewImage(message.file_uuid, container);
  }
}
```

---

