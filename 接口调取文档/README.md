# HuanVae Chat æ¥å£è°ƒå–æ–‡æ¡£

å‰ç«¯è°ƒç”¨ç¤ºä¾‹æ–‡æ¡£ï¼Œä½¿ç”¨ Fetch APIã€‚

## ğŸ“‚ ç›®å½•ç»“æ„

```
æ¥å£è°ƒå–æ–‡æ¡£/
â”œâ”€â”€ README.md                    # æœ¬æ–‡æ¡£
â”œâ”€â”€ auth/
â”‚   â””â”€â”€ ç”¨æˆ·ç™»å½•æ³¨å†Œé‰´æƒéƒ¨åˆ†.md   # ç™»å½•ã€æ³¨å†Œã€Token åˆ·æ–°ã€è®¾å¤‡ç®¡ç†
â”œâ”€â”€ profile/
â”‚   â””â”€â”€ ä¸ªäººèµ„æ–™ç®¡ç†.md          # ä¸ªäººä¿¡æ¯ã€å¯†ç ä¿®æ”¹ã€å¤´åƒä¸Šä¼ 
â”œâ”€â”€ friends/
â”‚   â””â”€â”€ å¥½å‹æ·»åŠ åˆ é™¤.md          # å¥½å‹è¯·æ±‚ã€å¥½å‹ç®¡ç†
â”œâ”€â”€ messages/
â”‚   â””â”€â”€ å¥½å‹æ¶ˆæ¯.md              # å¥½å‹ç§èŠæ¶ˆæ¯
â”œâ”€â”€ groups/
â”‚   â””â”€â”€ ç¾¤èŠç®¡ç†.md              # ç¾¤èŠåˆ›å»ºã€æˆå‘˜ç®¡ç†ã€è§’è‰²ç®¡ç†ã€é‚€è¯·ç ã€å…¬å‘Š
â”œâ”€â”€ group_messages/
â”‚   â””â”€â”€ ç¾¤æ¶ˆæ¯.md                # ç¾¤èŠæ¶ˆæ¯å‘é€ã€è·å–ã€åˆ é™¤ã€æ’¤å›
â””â”€â”€ storage/
    â””â”€â”€ æ–‡ä»¶å­˜å‚¨ç®¡ç†.md          # æ–‡ä»¶ä¸Šä¼ ã€ä¸‹è½½ã€é¢„ç­¾åURL
```

## ğŸ”— å¿«é€Ÿå¯¼èˆª

### ç”¨æˆ·è®¤è¯
- [ç™»å½•æ³¨å†Œé‰´æƒ](./auth/ç”¨æˆ·ç™»å½•æ³¨å†Œé‰´æƒéƒ¨åˆ†.md)
  - ç”¨æˆ·æ³¨å†Œ
  - ç”¨æˆ·ç™»å½•
  - Token åˆ·æ–°
  - è®¾å¤‡ç®¡ç†

### ä¸ªäººèµ„æ–™
- [ä¸ªäººèµ„æ–™ç®¡ç†](./profile/ä¸ªäººèµ„æ–™ç®¡ç†.md)
  - è·å–ä¸ªäººä¿¡æ¯
  - æ›´æ–°ä¸ªäººä¿¡æ¯
  - ä¿®æ”¹å¯†ç 
  - ä¸Šä¼ å¤´åƒ

### å¥½å‹ç³»ç»Ÿ
- [å¥½å‹æ·»åŠ åˆ é™¤](./friends/å¥½å‹æ·»åŠ åˆ é™¤.md)
  - å‘é€å¥½å‹è¯·æ±‚
  - å¤„ç†å¥½å‹è¯·æ±‚
  - å¥½å‹åˆ—è¡¨
  - åˆ é™¤å¥½å‹

### ç§èŠæ¶ˆæ¯
- [å¥½å‹æ¶ˆæ¯](./messages/å¥½å‹æ¶ˆæ¯.md)
  - å‘é€æ¶ˆæ¯
  - è·å–æ¶ˆæ¯åˆ—è¡¨
  - åˆ é™¤æ¶ˆæ¯
  - æ’¤å›æ¶ˆæ¯

### ç¾¤èŠç³»ç»Ÿ
- [ç¾¤èŠç®¡ç†](./groups/ç¾¤èŠç®¡ç†.md)
  - åˆ›å»º/è§£æ•£ç¾¤èŠ
  - ç¾¤è®¾ç½®ï¼ˆä¿®æ”¹ç¾¤åç§°ã€ä¸Šä¼ ç¾¤å¤´åƒï¼‰
  - ç¾¤å†…æ˜µç§°ç®¡ç†
  - æˆå‘˜ç®¡ç†ï¼ˆé‚€è¯·ã€ç§»é™¤ã€é€€å‡ºï¼‰
  - è§’è‰²ç®¡ç†ï¼ˆç¾¤ä¸»ã€ç®¡ç†å‘˜ï¼‰
  - ç¦è¨€ç®¡ç†
  - é‚€è¯·ç ç®¡ç†
  - å…¥ç¾¤ç”³è¯·å¤„ç†
  - ç¾¤å…¬å‘Š

### ç¾¤æ¶ˆæ¯
- [ç¾¤æ¶ˆæ¯](./group_messages/ç¾¤æ¶ˆæ¯.md)
  - å‘é€ç¾¤æ¶ˆæ¯
  - è·å–ç¾¤æ¶ˆæ¯åˆ—è¡¨
  - åˆ é™¤æ¶ˆæ¯ï¼ˆä¸ªäººï¼‰
  - æ’¤å›æ¶ˆæ¯

### æ–‡ä»¶å­˜å‚¨
- [æ–‡ä»¶å­˜å‚¨ç®¡ç†](./storage/æ–‡ä»¶å­˜å‚¨ç®¡ç†.md)
  - è¯·æ±‚ä¸Šä¼ ï¼ˆç§’ä¼ ã€é¢„ç­¾åURLï¼‰
  - é¢„ç­¾åPUTç›´ä¼ MinIO
  - ç¡®è®¤ä¸Šä¼ å®Œæˆï¼ˆconfirmï¼‰
  - UUID è®¿é—® / é¢„ç­¾å URL
  - å¥½å‹æ–‡ä»¶è®¿é—®

## ğŸ”§ é€šç”¨é…ç½®

### API åŸºç¡€åœ°å€

```js
// å¼€å‘ç¯å¢ƒï¼ˆé€šè¿‡ Nginx ä»£ç†ï¼‰
const BASE = 'http://localhost';

// ç”Ÿäº§ç¯å¢ƒ
const BASE = 'https://api.huanvae.com';
```

### é€šç”¨è¯·æ±‚å°è£…

```js
/**
 * é€šç”¨ API è¯·æ±‚å°è£…
 * @param {string} path - API è·¯å¾„
 * @param {object} options - è¯·æ±‚é€‰é¡¹
 */
async function api(path, { method='GET', token, body, formData }={}) {
  const headers = {};
  
  // JSON è¯·æ±‚
  if (body) {
    headers['Content-Type'] = 'application/json';
  }
  
  // è®¤è¯ Token
  if (token) {
    headers['Authorization'] = `Bearer ${token}`;
  }
  
  const options = {
    method,
    headers,
    body: formData || (body ? JSON.stringify(body) : undefined)
  };
  
  const res = await fetch(`${BASE}${path}`, options);
  const data = await res.json().catch(() => ({}));
  
  if (!res.ok) {
    throw new Error(`${res.status} ${JSON.stringify(data)}`);
  }
  
  return data;
}
```

### Token ç®¡ç†

```js
// å­˜å‚¨ Token
function saveTokens(accessToken, refreshToken) {
  localStorage.setItem('access_token', accessToken);
  localStorage.setItem('refresh_token', refreshToken);
}

// è·å– Token
function getToken() {
  return localStorage.getItem('access_token');
}

// åˆ·æ–° Token
async function refreshToken() {
  const refreshToken = localStorage.getItem('refresh_token');
  if (!refreshToken) {
    throw new Error('No refresh token');
  }
  
  const res = await fetch(`${BASE}/api/auth/refresh`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ refresh_token: refreshToken })
  });
  
  if (!res.ok) {
    localStorage.clear();
    throw new Error('Token refresh failed');
  }
  
  const data = await res.json();
  saveTokens(data.access_token, data.refresh_token);
  return data.access_token;
}
```

## ğŸ“Š API ç«¯ç‚¹æ±‡æ€»

### è®¤è¯ç›¸å…³
| æ–¹æ³• | ç«¯ç‚¹ | è¯´æ˜ |
|------|------|------|
| POST | `/api/auth/register` | ç”¨æˆ·æ³¨å†Œ |
| POST | `/api/auth/login` | ç”¨æˆ·ç™»å½• |
| POST | `/api/auth/refresh` | åˆ·æ–° Token |
| POST | `/api/auth/logout` | ç”¨æˆ·ç™»å‡º |
| GET | `/api/auth/devices` | è·å–ç™»å½•è®¾å¤‡åˆ—è¡¨ |
| DELETE | `/api/auth/devices/{id}` | åˆ é™¤è®¾å¤‡ |

### ä¸ªäººèµ„æ–™
| æ–¹æ³• | ç«¯ç‚¹ | è¯´æ˜ |
|------|------|------|
| GET | `/api/profile` | è·å–ä¸ªäººä¿¡æ¯ |
| PUT | `/api/profile` | æ›´æ–°ä¸ªäººä¿¡æ¯ |
| PUT | `/api/profile/password` | ä¿®æ”¹å¯†ç  |
| POST | `/api/profile/avatar` | ä¸Šä¼ å¤´åƒ |

### å¥½å‹ç³»ç»Ÿ
| æ–¹æ³• | ç«¯ç‚¹ | è¯´æ˜ |
|------|------|------|
| POST | `/api/friends/requests` | å‘é€å¥½å‹è¯·æ±‚ |
| GET | `/api/friends/requests/pending` | è·å–å¾…å¤„ç†è¯·æ±‚ |
| GET | `/api/friends/requests/sent` | è·å–å‘å‡ºçš„è¯·æ±‚ |
| POST | `/api/friends/requests/approve` | åŒæ„å¥½å‹è¯·æ±‚ |
| POST | `/api/friends/requests/reject` | æ‹’ç»å¥½å‹è¯·æ±‚ |
| GET | `/api/friends` | è·å–å¥½å‹åˆ—è¡¨ |
| POST | `/api/friends/remove` | åˆ é™¤å¥½å‹ |

### ç§èŠæ¶ˆæ¯
| æ–¹æ³• | ç«¯ç‚¹ | è¯´æ˜ |
|------|------|------|
| POST | `/api/messages` | å‘é€æ¶ˆæ¯ |
| GET | `/api/messages` | è·å–æ¶ˆæ¯åˆ—è¡¨ï¼ˆ`before_time` æ—¶é—´æˆ³åˆ†é¡µï¼‰ |
| DELETE | `/api/messages/delete` | åˆ é™¤æ¶ˆæ¯ |
| POST | `/api/messages/recall` | æ’¤å›æ¶ˆæ¯ |

### ç¾¤èŠç³»ç»Ÿ
| æ–¹æ³• | ç«¯ç‚¹ | è¯´æ˜ |
|------|------|------|
| POST | `/api/groups` | åˆ›å»ºç¾¤èŠ |
| GET | `/api/groups/my` | è·å–æˆ‘çš„ç¾¤èŠ |
| GET | `/api/groups/search` | æœç´¢ç¾¤èŠ |
| GET | `/api/groups/{id}` | è·å–ç¾¤è¯¦æƒ… |
| PUT | `/api/groups/{id}` | æ›´æ–°ç¾¤ä¿¡æ¯ï¼ˆåç§°ã€ç®€ä»‹ï¼‰ |
| POST | `/api/groups/{id}/avatar` | ä¸Šä¼ ç¾¤å¤´åƒ |
| PUT | `/api/groups/{id}/nickname` | ä¿®æ”¹æˆ‘çš„ç¾¤å†…æ˜µç§° |
| DELETE | `/api/groups/{id}` | è§£æ•£ç¾¤èŠ |
| PUT | `/api/groups/{id}/join-mode` | ä¿®æ”¹å…¥ç¾¤æ¨¡å¼ |
| GET | `/api/groups/{id}/members` | è·å–æˆå‘˜åˆ—è¡¨ |
| POST | `/api/groups/{id}/invite` | é‚€è¯·æˆå‘˜ |
| POST | `/api/groups/{id}/leave` | é€€å‡ºç¾¤èŠ |
| DELETE | `/api/groups/{id}/members/{uid}` | ç§»é™¤æˆå‘˜ |
| POST | `/api/groups/{id}/transfer` | è½¬è®©ç¾¤ä¸» |
| POST | `/api/groups/{id}/admins` | è®¾ç½®ç®¡ç†å‘˜ |
| DELETE | `/api/groups/{id}/admins/{uid}` | å–æ¶ˆç®¡ç†å‘˜ |
| POST | `/api/groups/{id}/mute` | ç¦è¨€æˆå‘˜ |
| DELETE | `/api/groups/{id}/mute/{uid}` | è§£é™¤ç¦è¨€ |
| POST | `/api/groups/{id}/invite-codes` | ç”Ÿæˆé‚€è¯·ç  |
| GET | `/api/groups/{id}/invite-codes` | è·å–é‚€è¯·ç åˆ—è¡¨ |
| DELETE | `/api/groups/{id}/invite-codes/{cid}` | æ’¤é”€é‚€è¯·ç  |
| POST | `/api/groups/join-by-code` | é€šè¿‡é‚€è¯·ç å…¥ç¾¤ |
| POST | `/api/groups/{id}/apply` | ç”³è¯·å…¥ç¾¤ |
| GET | `/api/groups/{id}/requests` | è·å–å¾…å¤„ç†ç”³è¯· |
| POST | `/api/groups/{id}/requests/{rid}/approve` | åŒæ„ç”³è¯· |
| POST | `/api/groups/{id}/requests/{rid}/reject` | æ‹’ç»ç”³è¯· |
| GET | `/api/groups/invitations` | è·å–æ”¶åˆ°çš„é‚€è¯· |
| POST | `/api/groups/invitations/{rid}/accept` | æ¥å—é‚€è¯· |
| POST | `/api/groups/invitations/{rid}/decline` | æ‹’ç»é‚€è¯· |
| POST | `/api/groups/{id}/notices` | å‘å¸ƒå…¬å‘Š |
| GET | `/api/groups/{id}/notices` | è·å–å…¬å‘Šåˆ—è¡¨ |
| PUT | `/api/groups/{id}/notices/{nid}` | æ›´æ–°å…¬å‘Š |
| DELETE | `/api/groups/{id}/notices/{nid}` | åˆ é™¤å…¬å‘Š |

### ç¾¤æ¶ˆæ¯
| æ–¹æ³• | ç«¯ç‚¹ | è¯´æ˜ |
|------|------|------|
| POST | `/api/group-messages` | å‘é€ç¾¤æ¶ˆæ¯ |
| GET | `/api/group-messages` | è·å–ç¾¤æ¶ˆæ¯åˆ—è¡¨ï¼ˆ`before_time` æ—¶é—´æˆ³åˆ†é¡µï¼ŒJOIN ä¼˜åŒ–ï¼‰ |
| DELETE | `/api/group-messages/delete` | åˆ é™¤æ¶ˆæ¯ï¼ˆä¸ªäººï¼‰ |
| POST | `/api/group-messages/recall` | æ’¤å›æ¶ˆæ¯ |

### æ–‡ä»¶å­˜å‚¨
| æ–¹æ³• | ç«¯ç‚¹ | è¯´æ˜ |
|------|------|------|
| POST | `/api/storage/upload/request` | è¯·æ±‚ä¸Šä¼ ï¼ˆè¿”å›é¢„ç­¾åURLï¼‰ |
| POST | `/api/storage/upload/confirm` | ç¡®è®¤ä¸Šä¼ å®Œæˆï¼ˆé¢„ç­¾åä¸Šä¼ ä¸“ç”¨ï¼‰ |
| GET | `/api/storage/file/{uuid}` | UUID è®¿é—®æ–‡ä»¶ |
| POST | `/api/storage/file/{uuid}/presigned-url` | è·å–é¢„ç­¾å URLï¼ˆä¸‹è½½/é¢„è§ˆï¼‰ |
| POST | `/api/storage/file/{uuid}/presigned-url/extended` | è·å–æ‰©å±•é¢„ç­¾å URLï¼ˆå¤§æ–‡ä»¶ï¼‰ |
| GET | `/api/storage/files` | è·å–æ–‡ä»¶åˆ—è¡¨ |
| POST | `/api/storage/friends-file/{uuid}/presigned-url` | å¥½å‹æ–‡ä»¶é¢„ç­¾å URL |

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **HTTPS**ï¼šç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨ HTTPS
2. **Token è¿‡æœŸ**ï¼šAccess Token æœ‰æ•ˆæœŸ 15 åˆ†é’Ÿï¼Œéœ€åŠæ—¶åˆ·æ–°
3. **é”™è¯¯å¤„ç†**ï¼šå§‹ç»ˆå¤„ç† API è°ƒç”¨çš„é”™è¯¯æƒ…å†µ
4. **æ–‡ä»¶å¤§å°é™åˆ¶**ï¼š
   - å¤´åƒï¼šæœ€å¤§ 10MBï¼ˆç”¨æˆ·å¤´åƒã€ç¾¤å¤´åƒï¼‰
   - æ™®é€šæ–‡ä»¶ï¼š<5GB ä½¿ç”¨é¢„ç­¾åPUTï¼Œâ‰¥5GB ä½¿ç”¨åˆ†ç‰‡ä¸Šä¼ 
5. **æ¶ˆæ¯æ’¤å›**ï¼šæ™®é€šç”¨æˆ·åªèƒ½æ’¤å› 2 åˆ†é’Ÿå†…çš„æ¶ˆæ¯
6. **å®æ—¶æ¶ˆæ¯**ï¼šå·²æ”¯æŒ WebSocket å®æ—¶æ¨é€
7. **æ¶ˆæ¯åˆ†é¡µ**ï¼šä½¿ç”¨ `before_time` æ—¶é—´æˆ³åˆ†é¡µ
8. **æ¶ˆæ¯å½’æ¡£**ï¼š30å¤©å‰çš„å†å²æ¶ˆæ¯ä¼šè‡ªåŠ¨å½’æ¡£ï¼Œä»å¯æ­£å¸¸æŸ¥è¯¢
9. **æ–‡ä»¶ä¸Šä¼ **ï¼šä½¿ç”¨é¢„ç­¾åURLç›´ä¼ MinIOï¼Œä¸Šä¼ å**å¿…é¡»è°ƒç”¨confirmæ¥å£**ç¡®è®¤

## ğŸ“ æ›´æ–°æ—¥å¿—

- **2025-12-04**ï¼š
  - æ¶ˆæ¯æŸ¥è¯¢æ¥å£æ–°å¢ `before_time` æ—¶é—´æˆ³åˆ†é¡µå‚æ•°ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
  - ç¾¤æ¶ˆæ¯æŸ¥è¯¢ä½¿ç”¨ JOIN ä¼˜åŒ–ï¼Œä¸€æ¬¡æ€§è·å–å‘é€è€…ä¿¡æ¯
  - æ–°å¢æ¶ˆæ¯å½’æ¡£åŠŸèƒ½ï¼ˆ30å¤©è‡ªåŠ¨å½’æ¡£ï¼‰
  - æ–°å¢ç¾¤å¤´åƒä¸Šä¼ ã€ç¾¤å†…æ˜µç§°ä¿®æ”¹æ¥å£
  - **æ–‡ä»¶ä¸Šä¼ æ”¹ä¸ºé¢„ç­¾åURLç›´ä¼ MinIO**ï¼š
    - æ‰€æœ‰æ–‡ä»¶ç»Ÿä¸€ä½¿ç”¨é¢„ç­¾åURLç›´ä¼ 
    - `<5GB` ä½¿ç”¨ `presigned_put` å•æ¬¡PUTä¸Šä¼ 
    - `â‰¥5GB` ä½¿ç”¨ `presigned_multipart` åˆ†ç‰‡ä¸Šä¼ 
    - æ–°å¢ `/api/storage/upload/confirm` ç¡®è®¤ä¸Šä¼ æ¥å£
    - ä¸Šä¼ å®Œæˆåè§¦å‘WebSocketå®æ—¶é€šçŸ¥
- **2025-12-03**ï¼šæ–°å¢ç¾¤èŠç³»ç»Ÿå’Œç¾¤æ¶ˆæ¯æ¥å£æ–‡æ¡£
- **2025-11-25**ï¼šåˆå§‹ç‰ˆæœ¬ï¼ŒåŒ…å«è®¤è¯ã€å¥½å‹ã€æ¶ˆæ¯ã€æ–‡ä»¶å­˜å‚¨æ¥å£

