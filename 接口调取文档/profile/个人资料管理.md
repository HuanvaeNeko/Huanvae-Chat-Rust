# Profile æ¥å£ï¼ˆFetch APIï¼‰

ä¸ªäººèµ„æ–™ç®¡ç†ç›¸å…³æ¥å£çš„å‰ç«¯è°ƒç”¨ç¤ºä¾‹ï¼Œä½¿ç”¨ Fetch APIã€‚

## ğŸ”§ é€šç”¨å·¥å…·å‡½æ•°

```js
const BASE = 'http://localhost:8080';

/**
 * é€šç”¨ API è¯·æ±‚å°è£…
 * @param {string} path - API è·¯å¾„
 * @param {object} options - è¯·æ±‚é€‰é¡¹
 * @param {string} options.method - HTTP æ–¹æ³•
 * @param {string} options.token - Bearer Token
 * @param {object} options.body - è¯·æ±‚ä½“ï¼ˆè‡ªåŠ¨è½¬ JSONï¼‰
 * @param {FormData} options.formData - FormData å¯¹è±¡ï¼ˆç”¨äºæ–‡ä»¶ä¸Šä¼ ï¼‰
 */
async function api(path, { method='GET', token, body, formData }={}) {
  const headers = {};
  
  // JSON è¯·æ±‚
  if (body) {
    headers['Content-Type'] = 'application/json';
  }
  
  // è®¤è¯ Token
  if (token) {
    headers['Authorization'] = `Bearer ${token}`;
  }
  
  const options = {
    method,
    headers,
    body: formData || (body ? JSON.stringify(body) : undefined)
  };
  
  const res = await fetch(`${BASE}${path}`, options);
  const data = await res.json().catch(() => ({}));
  
  if (!res.ok) {
    throw new Error(`${res.status} ${JSON.stringify(data)}`);
  }
  
  return data;
}
```

---

## ğŸ“‹ æ¥å£åˆ—è¡¨

### 1. è·å–ä¸ªäººä¿¡æ¯ï¼ˆå—ä¿æŠ¤ï¼‰

**ç«¯ç‚¹**ï¼š`GET /api/profile`

**åŠŸèƒ½**ï¼šè·å–å½“å‰ç”¨æˆ·çš„å®Œæ•´ä¸ªäººä¿¡æ¯ï¼ˆä¸å«å¯†ç ï¼‰

**é‰´æƒ**ï¼šéœ€è¦ Bearer Token

**è¯·æ±‚ç¤ºä¾‹**ï¼š
```js
// è·å–ä¸ªäººä¿¡æ¯
const profile = await api('/api/profile', { token });

console.log(profile);
// è¾“å‡º:
// {
//   "data": {
//     "user_id": "testuser001",
//     "user_nickname": "æµ‹è¯•ç”¨æˆ·",
//     "user_email": "test@example.com",
//     "user_signature": "Hello, world!",
//     "user_avatar_url": "http://localhost:9000/avatars/testuser001.jpg",
//     "admin": "false",
//     "created_at": "2025-11-25T11:00:02.221791Z",
//     "updated_at": "2025-11-25T11:03:40.730806Z"
//   }
// }
```

**å“åº”å­—æ®µè¯´æ˜**ï¼š

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `user_id` | string | ç”¨æˆ· ID |
| `user_nickname` | string | æ˜µç§° |
| `user_email` | string\|null | é‚®ç®± |
| `user_signature` | string\|null | ä¸ªæ€§ç­¾å |
| `user_avatar_url` | string\|null | å¤´åƒ URL |
| `admin` | string | æ˜¯å¦ç®¡ç†å‘˜ ("true"/"false") |
| `created_at` | string | åˆ›å»ºæ—¶é—´ï¼ˆISO 8601ï¼‰ |
| `updated_at` | string | æ›´æ–°æ—¶é—´ï¼ˆISO 8601ï¼‰ |

---

### 2. æ›´æ–°ä¸ªäººä¿¡æ¯ï¼ˆå—ä¿æŠ¤ï¼‰

**ç«¯ç‚¹**ï¼š`PUT /api/profile`

**åŠŸèƒ½**ï¼šæ›´æ–°ç”¨æˆ·çš„é‚®ç®±å’Œ/æˆ–ä¸ªæ€§ç­¾å

**é‰´æƒ**ï¼šéœ€è¦ Bearer Token

**è¯·æ±‚ä½“**ï¼š
```typescript
{
  email?: string,        // æ–°é‚®ç®±ï¼ˆå¯é€‰ï¼‰
  signature?: string     // ä¸ªæ€§ç­¾åï¼ˆå¯é€‰ï¼‰
}
```

**éªŒè¯è§„åˆ™**ï¼š
- `email`: å¿…é¡»æ˜¯æœ‰æ•ˆé‚®ç®±æ ¼å¼
- `signature`: æœ€é•¿ 200 å­—ç¬¦
- è‡³å°‘æä¾›ä¸€ä¸ªå­—æ®µ

**è¯·æ±‚ç¤ºä¾‹**ï¼š
```js
// ä»…æ›´æ–°é‚®ç®±
await api('/api/profile', {
  method: 'PUT',
  token,
  body: {
    email: 'newemail@example.com'
  }
});

// ä»…æ›´æ–°ç­¾å
await api('/api/profile', {
  method: 'PUT',
  token,
  body: {
    signature: 'This is my new signature!'
  }
});

// åŒæ—¶æ›´æ–°é‚®ç®±å’Œç­¾å
await api('/api/profile', {
  method: 'PUT',
  token,
  body: {
    email: 'newemail@example.com',
    signature: 'Hello, world!'
  }
});
```

**æˆåŠŸå“åº”**ï¼š
```json
{
  "message": "Profile updated successfully"
}
```

**é”™è¯¯å“åº”**ï¼š
```json
{
  "error": "Validation error: email: Invalid email format"
}
```

---

### 3. ä¿®æ”¹å¯†ç ï¼ˆå—ä¿æŠ¤ï¼‰

**ç«¯ç‚¹**ï¼š`PUT /api/profile/password`

**åŠŸèƒ½**ï¼šä¿®æ”¹ç”¨æˆ·å¯†ç 

**é‰´æƒ**ï¼šéœ€è¦ Bearer Token

**è¯·æ±‚ä½“**ï¼š
```typescript
{
  old_password: string,  // æ—§å¯†ç ï¼ˆå¿…å¡«ï¼‰
  new_password: string   // æ–°å¯†ç ï¼ˆå¿…å¡«ï¼‰
}
```

**éªŒè¯è§„åˆ™**ï¼š
- `old_password`: è‡³å°‘ 6 å­—ç¬¦
- `new_password`: 6-100 å­—ç¬¦

**è¯·æ±‚ç¤ºä¾‹**ï¼š
```js
await api('/api/profile/password', {
  method: 'PUT',
  token,
  body: {
    old_password: 'oldpass123',
    new_password: 'newpass456'
  }
});
```

**æˆåŠŸå“åº”**ï¼š
```json
{
  "message": "Password updated successfully"
}
```

**é”™è¯¯å“åº”**ï¼š

æ—§å¯†ç é”™è¯¯ï¼ˆ401ï¼‰ï¼š
```json
{
  "error": "Old password is incorrect"
}
```

éªŒè¯é”™è¯¯ï¼ˆ400ï¼‰ï¼š
```json
{
  "error": "Validation error: new_password: Password must be 6-100 characters"
}
```

**é‡è¦æç¤º**ï¼š
- å¯†ç ä¿®æ”¹åç«‹å³ç”Ÿæ•ˆ
- æ—§å¯†ç éªŒè¯å¤±è´¥è¿”å› 401 çŠ¶æ€ç 
- å»ºè®®ä½¿ç”¨ HTTPS ä¼ è¾“å¯†ç 

---

### 4. ä¸Šä¼ å¤´åƒï¼ˆå—ä¿æŠ¤ï¼‰

**ç«¯ç‚¹**ï¼š`POST /api/profile/avatar`

**åŠŸèƒ½**ï¼šä¸Šä¼ ç”¨æˆ·å¤´åƒ

**é‰´æƒ**ï¼šéœ€è¦ Bearer Token

**è¯·æ±‚æ ¼å¼**ï¼š`multipart/form-data`

**è¡¨å•å­—æ®µ**ï¼š
- `avatar` æˆ– `file`: å›¾ç‰‡æ–‡ä»¶

**æ”¯æŒæ ¼å¼**ï¼šjpg, jpeg, png, gif, webp

**å¤§å°é™åˆ¶**ï¼šæœ€å¤§ 5MB

**è¯·æ±‚ç¤ºä¾‹**ï¼š

```js
// æ–¹æ³• 1ï¼šä»æ–‡ä»¶è¾“å…¥ä¸Šä¼ 
const fileInput = document.querySelector('#avatarInput');
const file = fileInput.files[0];

const formData = new FormData();
formData.append('avatar', file);

const result = await api('/api/profile/avatar', {
  method: 'POST',
  token,
  formData
});

console.log(result);
// {
//   "avatar_url": "http://localhost:9000/avatars/testuser001.jpg",
//   "message": "Avatar uploaded successfully"
// }
```

```js
// æ–¹æ³• 2ï¼šä» Blob ä¸Šä¼ 
const blob = await fetch('https://example.com/image.jpg').then(r => r.blob());

const formData = new FormData();
formData.append('avatar', blob, 'avatar.jpg');

const result = await api('/api/profile/avatar', {
  method: 'POST',
  token,
  formData
});
```

```js
// æ–¹æ³• 3ï¼šå®Œæ•´ç¤ºä¾‹ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
async function uploadAvatar(file, token) {
  try {
    // éªŒè¯æ–‡ä»¶å¤§å°
    const maxSize = 5 * 1024 * 1024; // 5MB
    if (file.size > maxSize) {
      alert('æ–‡ä»¶å¤ªå¤§ï¼Œæœ€å¤§ 5MB');
      return;
    }
    
    // éªŒè¯æ–‡ä»¶ç±»å‹
    const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
    if (!allowedTypes.includes(file.type)) {
      alert('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼');
      return;
    }
    
    // ä¸Šä¼ 
    const formData = new FormData();
    formData.append('avatar', file);
    
    const result = await api('/api/profile/avatar', {
      method: 'POST',
      token,
      formData
    });
    
    // æ›´æ–°é¡µé¢ä¸Šçš„å¤´åƒæ˜¾ç¤º
    document.querySelector('#userAvatar').src = result.avatar_url;
    alert('å¤´åƒä¸Šä¼ æˆåŠŸï¼');
    
    return result.avatar_url;
  } catch (error) {
    console.error('ä¸Šä¼ å¤±è´¥:', error);
    alert('ä¸Šä¼ å¤±è´¥: ' + error.message);
  }
}

// ä½¿ç”¨ç¤ºä¾‹
document.querySelector('#avatarInput').addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (file) {
    await uploadAvatar(file, token);
  }
});
```

**æˆåŠŸå“åº”**ï¼š
```json
{
  "avatar_url": "http://localhost:9000/avatars/testuser001.jpg",
  "message": "Avatar uploaded successfully"
}
```

**é”™è¯¯å“åº”**ï¼š

æ— æ–‡ä»¶ä¸Šä¼ ï¼ˆ400ï¼‰ï¼š
```json
{
  "error": "No file uploaded. Use field name 'avatar' or 'file'"
}
```

æ–‡ä»¶å¤ªå¤§ï¼ˆ400ï¼‰ï¼š
```json
{
  "error": "File too large. Maximum size: 5 MB, got: 8.42 MB"
}
```

ä¸æ”¯æŒçš„æ ¼å¼ï¼ˆ400ï¼‰ï¼š
```json
{
  "error": "Unsupported file format. Allowed: jpg, jpeg, png, gif, webp"
}
```

---

## ğŸ¨ å®Œæ•´ç¤ºä¾‹ï¼šä¸ªäººèµ„æ–™é¡µé¢

```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>ä¸ªäººèµ„æ–™</title>
  <style>
    .profile-container { max-width: 600px; margin: 50px auto; padding: 20px; }
    .avatar { width: 150px; height: 150px; border-radius: 50%; }
    .form-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 5px; font-weight: bold; }
    input, textarea { width: 100%; padding: 8px; box-sizing: border-box; }
    button { padding: 10px 20px; background: #007bff; color: white; border: none; cursor: pointer; }
    button:hover { background: #0056b3; }
  </style>
</head>
<body>
  <div class="profile-container">
    <h1>ä¸ªäººèµ„æ–™</h1>
    
    <!-- å¤´åƒæ˜¾ç¤º -->
    <div class="form-group">
      <img id="userAvatar" class="avatar" src="/default-avatar.png" alt="å¤´åƒ">
      <input type="file" id="avatarInput" accept="image/*">
      <button onclick="handleAvatarUpload()">ä¸Šä¼ å¤´åƒ</button>
    </div>
    
    <!-- åŸºæœ¬ä¿¡æ¯ -->
    <div class="form-group">
      <label>ç”¨æˆ· ID</label>
      <input id="userId" type="text" disabled>
    </div>
    
    <div class="form-group">
      <label>æ˜µç§°</label>
      <input id="nickname" type="text" disabled>
    </div>
    
    <div class="form-group">
      <label>é‚®ç®±</label>
      <input id="email" type="email">
    </div>
    
    <div class="form-group">
      <label>ä¸ªæ€§ç­¾å</label>
      <textarea id="signature" rows="3"></textarea>
    </div>
    
    <button onclick="handleUpdateProfile()">ä¿å­˜ä¿®æ”¹</button>
    
    <!-- ä¿®æ”¹å¯†ç  -->
    <h2>ä¿®æ”¹å¯†ç </h2>
    <div class="form-group">
      <label>æ—§å¯†ç </label>
      <input id="oldPassword" type="password">
    </div>
    
    <div class="form-group">
      <label>æ–°å¯†ç </label>
      <input id="newPassword" type="password">
    </div>
    
    <button onclick="handleUpdatePassword()">ä¿®æ”¹å¯†ç </button>
  </div>

  <script>
    const BASE = 'http://localhost:8080';
    let token = localStorage.getItem('access_token'); // ä» localStorage è·å– token
    
    // API è¯·æ±‚å°è£…
    async function api(path, { method='GET', token, body, formData }={}) {
      const headers = {};
      if (body) headers['Content-Type'] = 'application/json';
      if (token) headers['Authorization'] = `Bearer ${token}`;
      
      const res = await fetch(`${BASE}${path}`, {
        method,
        headers,
        body: formData || (body ? JSON.stringify(body) : undefined)
      });
      
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(`${res.status} ${JSON.stringify(data)}`);
      return data;
    }
    
    // åŠ è½½ä¸ªäººä¿¡æ¯
    async function loadProfile() {
      try {
        const response = await api('/api/profile', { token });
        const profile = response.data;
        
        document.querySelector('#userId').value = profile.user_id;
        document.querySelector('#nickname').value = profile.user_nickname;
        document.querySelector('#email').value = profile.user_email || '';
        document.querySelector('#signature').value = profile.user_signature || '';
        
        if (profile.user_avatar_url) {
          document.querySelector('#userAvatar').src = profile.user_avatar_url;
        }
      } catch (error) {
        alert('åŠ è½½å¤±è´¥: ' + error.message);
      }
    }
    
    // æ›´æ–°ä¸ªäººä¿¡æ¯
    async function handleUpdateProfile() {
      try {
        const email = document.querySelector('#email').value;
        const signature = document.querySelector('#signature').value;
        
        await api('/api/profile', {
          method: 'PUT',
          token,
          body: { email, signature }
        });
        
        alert('ä¿å­˜æˆåŠŸï¼');
      } catch (error) {
        alert('ä¿å­˜å¤±è´¥: ' + error.message);
      }
    }
    
    // ä¿®æ”¹å¯†ç 
    async function handleUpdatePassword() {
      try {
        const old_password = document.querySelector('#oldPassword').value;
        const new_password = document.querySelector('#newPassword').value;
        
        await api('/api/profile/password', {
          method: 'PUT',
          token,
          body: { old_password, new_password }
        });
        
        alert('å¯†ç ä¿®æ”¹æˆåŠŸï¼');
        document.querySelector('#oldPassword').value = '';
        document.querySelector('#newPassword').value = '';
      } catch (error) {
        alert('ä¿®æ”¹å¤±è´¥: ' + error.message);
      }
    }
    
    // ä¸Šä¼ å¤´åƒ
    async function handleAvatarUpload() {
      const file = document.querySelector('#avatarInput').files[0];
      if (!file) {
        alert('è¯·é€‰æ‹©æ–‡ä»¶');
        return;
      }
      
      try {
        const formData = new FormData();
        formData.append('avatar', file);
        
        const result = await api('/api/profile/avatar', {
          method: 'POST',
          token,
          formData
        });
        
        document.querySelector('#userAvatar').src = result.avatar_url;
        alert('å¤´åƒä¸Šä¼ æˆåŠŸï¼');
      } catch (error) {
        alert('ä¸Šä¼ å¤±è´¥: ' + error.message);
      }
    }
    
    // é¡µé¢åŠ è½½æ—¶è·å–ä¸ªäººä¿¡æ¯
    loadProfile();
  </script>
</body>
</html>
```

---

## ğŸ” Token ç®¡ç†å»ºè®®

```js
// å­˜å‚¨ Token
function saveToken(accessToken, refreshToken) {
  localStorage.setItem('access_token', accessToken);
  localStorage.setItem('refresh_token', refreshToken);
}

// è·å– Token
function getToken() {
  return localStorage.getItem('access_token');
}

// æ¸…é™¤ Token
function clearTokens() {
  localStorage.removeItem('access_token');
  localStorage.removeItem('refresh_token');
}

// æ£€æŸ¥ Token æ˜¯å¦å­˜åœ¨
function hasToken() {
  return !!localStorage.getItem('access_token');
}
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **HTTPS**ï¼šç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨ HTTPS
2. **Token å®‰å…¨**ï¼šä¸è¦åœ¨ URL ä¸­ä¼ é€’ Token
3. **æ–‡ä»¶å¤§å°**ï¼šå®¢æˆ·ç«¯åº”åœ¨ä¸Šä¼ å‰éªŒè¯æ–‡ä»¶å¤§å°
4. **é”™è¯¯å¤„ç†**ï¼šå§‹ç»ˆå¤„ç† API è°ƒç”¨çš„é”™è¯¯æƒ…å†µ
5. **ç”¨æˆ·ä½“éªŒ**ï¼šä¸Šä¼ å¤§æ–‡ä»¶æ—¶æ˜¾ç¤ºè¿›åº¦æ¡
6. **åˆ·æ–°æ˜¾ç¤º**ï¼šæ›´æ–°æˆåŠŸååˆ·æ–°é¡µé¢æ˜¾ç¤ºçš„ä¿¡æ¯

