# å¥½å‹æ¶ˆæ¯æ¥å£ï¼ˆFetch APIï¼‰

## ğŸ”§ å·¥å…·å‡½æ•°

```js
const BASE = 'http://localhost:8080';

async function api(path, { method='GET', token, body }={}) {
  const headers = { 'Content-Type': 'application/json' };
  if (token) headers['Authorization'] = `Bearer ${token}`;
  const res = await fetch(`${BASE}${path}`, {
    method,
    headers,
    body: body ? JSON.stringify(body) : undefined,
  });
  const data = await res.json().catch(() => ({}));
  if (!res.ok) throw new Error(`${res.status} ${JSON.stringify(data)}`);
  return data;
}
```

---

## ğŸ“¤ å‘é€æ¶ˆæ¯ï¼ˆå—ä¿æŠ¤ï¼‰

**è·¯å¾„**ï¼š`POST /api/messages`

**è¯·æ±‚å¤´**ï¼š
- `Authorization: Bearer <access_token>` - å¿…éœ€

**è¯·æ±‚ä½“**ï¼š
```json
{
  "receiver_id": "user456",
  "message_content": "ä½ å¥½ï¼Œåœ¨å—ï¼Ÿ",
  "message_type": "text",
  "file_uuid": null,
  "file_url": null,
  "file_size": null
}
```

**å­—æ®µè¯´æ˜**ï¼š
- `receiver_id` (å¿…éœ€): æ¥æ”¶è€…ç”¨æˆ·ID
- `message_content` (å¿…éœ€): æ¶ˆæ¯å†…å®¹
- `message_type` (å¿…éœ€): æ¶ˆæ¯ç±»å‹ (`text` | `image` | `video` | `file`)
- `file_uuid` (å¯é€‰): æ–‡ä»¶UUIDï¼ˆä¼˜å…ˆä½¿ç”¨ï¼Œå…³è” file-uuid-mapping è¡¨ï¼‰â­æ–°å¢
- `file_url` (å¯é€‰): æ–‡ä»¶URLï¼ˆå…¼å®¹ä¿ç•™ï¼‰
- `file_size` (å¯é€‰): æ–‡ä»¶å¤§å°ï¼Œå­—èŠ‚ï¼ˆåª’ä½“æ¶ˆæ¯æ—¶å¿…éœ€ï¼‰

**å“åº”**ï¼š
```json
{
  "message_uuid": "550e8400-e29b-41d4-a716-446655440000",
  "send_time": "2025-11-27T03:00:00Z"
}
```

**Fetch ç¤ºä¾‹**ï¼š
```js
// å‘é€æ–‡æœ¬æ¶ˆæ¯
const textMsg = await api('/api/messages', {
  method: 'POST',
  token: accessToken,
  body: {
    receiver_id: 'friend_user_123',
    message_content: 'ä½ å¥½ï¼Œæœ€è¿‘æ€ä¹ˆæ ·ï¼Ÿ',
    message_type: 'text'
  }
});
console.log('æ¶ˆæ¯å·²å‘é€:', textMsg.message_uuid);

// å‘é€å›¾ç‰‡æ¶ˆæ¯ï¼ˆä½¿ç”¨ file_uuidï¼‰â­æ¨èæ–¹å¼
const imageMsg = await api('/api/messages', {
  method: 'POST',
  token: accessToken,
  body: {
    receiver_id: 'friend_user_123',
    message_content: '[å›¾ç‰‡]',
    message_type: 'image',
    file_uuid: 'd2f612d5-70b0-4d4e-8779-86cf6aeb2b30',  // ä»ä¸Šä¼ å“åº”ä¸­è·å–
    file_size: 524288
  }
});

// å‘é€è§†é¢‘æ¶ˆæ¯
const videoMsg = await api('/api/messages', {
  method: 'POST',
  token: accessToken,
  body: {
    receiver_id: 'friend_user_123',
    message_content: '[è§†é¢‘]',
    message_type: 'video',
    file_url: 'http://localhost:9000/friends-file/conv-user1-user2/videos/clip.mp4',
    file_size: 5242880
  }
});

// å‘é€æ–‡ä»¶æ¶ˆæ¯
const fileMsg = await api('/api/messages', {
  method: 'POST',
  token: accessToken,
  body: {
    receiver_id: 'friend_user_123',
    message_content: 'document.pdf',
    message_type: 'file',
    file_url: 'http://localhost:9000/friends-file/conv-user1-user2/files/document.pdf',
    file_size: 1048576
  }
});
```

**é”™è¯¯å“åº”**ï¼š
- `400` - ä¸æ˜¯å¥½å‹å…³ç³»æˆ–è¯·æ±‚å‚æ•°é”™è¯¯
- `401` - æœªè®¤è¯æˆ–Tokenæ— æ•ˆ
- `500` - æœåŠ¡å™¨å†…éƒ¨é”™è¯¯

---

## ğŸ“¥ è·å–æ¶ˆæ¯åˆ—è¡¨ï¼ˆå—ä¿æŠ¤ï¼‰

**è·¯å¾„**ï¼š`GET /api/messages`

**è¯·æ±‚å¤´**ï¼š
- `Authorization: Bearer <access_token>` - å¿…éœ€

**æŸ¥è¯¢å‚æ•°**ï¼š
- `friend_id` (å¿…éœ€): å¥½å‹ç”¨æˆ·ID
- `before_time` (å¯é€‰): æ—¶é—´æˆ³åˆ†é¡µï¼ŒISO 8601 æ ¼å¼ï¼ˆå¦‚ `2025-12-04T14:00:00+00:00`ï¼‰
- `limit` (å¯é€‰): è¿”å›æ•°é‡ï¼Œé»˜è®¤50ï¼Œæœ€å¤§500

> ğŸ’¡ **æ€§èƒ½ä¼˜åŒ–**: ä½¿ç”¨æ—¶é—´æˆ³åˆ†é¡µç›´æ¥æ¯”è¾ƒï¼Œé¿å…å­æŸ¥è¯¢ï¼Œæ€§èƒ½æå‡çº¦ 30-50%

**å“åº”**ï¼š
```json
{
  "messages": [
    {
      "message_uuid": "550e8400-e29b-41d4-a716-446655440000",
      "sender_id": "user123",
      "receiver_id": "user456",
      "message_content": "ä½ å¥½",
      "message_type": "text",
      "file_uuid": null,
      "file_url": null,
      "file_size": null,
      "send_time": "2025-11-27T03:00:00Z"
    },
    {
      "message_uuid": "660e8400-e29b-41d4-a716-446655440001",
      "sender_id": "user456",
      "receiver_id": "user123",
      "message_content": "[å›¾ç‰‡]",
      "message_type": "image",
      "file_uuid": "d2f612d5-70b0-4d4e-8779-86cf6aeb2b30",
      "file_url": "http://localhost:8080/api/storage/file/d2f612d5-70b0-4d4e-8779-86cf6aeb2b30",
      "file_size": 524288,
      "send_time": "2025-11-27T03:01:00Z"
    }
  ],
  "has_more": false
}
```

**Fetch ç¤ºä¾‹**ï¼š
```js
// è·å–æœ€æ–°çš„50æ¡æ¶ˆæ¯
const messages = await api('/api/messages?friend_id=friend_user_123&limit=50', {
  method: 'GET',
  token: accessToken
});

console.log('æ¶ˆæ¯åˆ—è¡¨:', messages.messages);
console.log('æ˜¯å¦æœ‰æ›´å¤š:', messages.has_more);

// ä½¿ç”¨æ—¶é—´æˆ³åˆ†é¡µåŠ è½½æ›´å¤šæ¶ˆæ¯
if (messages.has_more) {
  const oldestMessage = messages.messages[messages.messages.length - 1];
  const beforeTime = encodeURIComponent(oldestMessage.send_time);
  const moreMessages = await api(
    `/api/messages?friend_id=friend_user_123&before_time=${beforeTime}&limit=50`,
    { method: 'GET', token: accessToken }
  );
}

// å®ç°ä¸‹æ‹‰åŠ è½½å†å²æ¶ˆæ¯
let allMessages = [];
let hasMore = true;
let beforeTime = null;

while (hasMore) {
  const query = new URLSearchParams({
    friend_id: 'friend_user_123',
    limit: '50'
  });
  if (beforeTime) query.set('before_time', beforeTime);
  
  const result = await api(`/api/messages?${query}`, {
    method: 'GET',
    token: accessToken
  });
  
  allMessages.push(...result.messages);
  hasMore = result.has_more;
  
  if (hasMore && result.messages.length > 0) {
    beforeTime = result.messages[result.messages.length - 1].send_time;
  }
  
  // å¯ä»¥æ·»åŠ å»¶è¿Ÿé¿å…è¿‡äºé¢‘ç¹çš„è¯·æ±‚
  if (hasMore) await new Promise(resolve => setTimeout(resolve, 100));
}

console.log('æ‰€æœ‰æ¶ˆæ¯:', allMessages);
```

**é”™è¯¯å“åº”**ï¼š
- `400` - ä¸æ˜¯å¥½å‹å…³ç³»æˆ–å‚æ•°é”™è¯¯
- `401` - æœªè®¤è¯æˆ–Tokenæ— æ•ˆ
- `500` - æœåŠ¡å™¨å†…éƒ¨é”™è¯¯

---

## ğŸ—‘ï¸ åˆ é™¤æ¶ˆæ¯ï¼ˆå—ä¿æŠ¤ï¼‰

**è·¯å¾„**ï¼š`DELETE /api/messages/delete`

**è¯·æ±‚å¤´**ï¼š
- `Authorization: Bearer <access_token>` - å¿…éœ€

**è¯·æ±‚ä½“**ï¼š
```json
{
  "message_uuid": "550e8400-e29b-41d4-a716-446655440000"
}
```

**å“åº”**ï¼š
```json
{
  "success": true,
  "message": "æ¶ˆæ¯åˆ é™¤æˆåŠŸ"
}
```

**Fetch ç¤ºä¾‹**ï¼š
```js
// åˆ é™¤å•æ¡æ¶ˆæ¯
const result = await api('/api/messages/delete', {
  method: 'DELETE',
  token: accessToken,
  body: {
    message_uuid: '550e8400-e29b-41d4-a716-446655440000'
  }
});

if (result.success) {
  console.log('æ¶ˆæ¯å·²åˆ é™¤');
  // ä»UIä¸­ç§»é™¤è¯¥æ¶ˆæ¯
}

// æ‰¹é‡åˆ é™¤æ¶ˆæ¯
const messageUuids = [
  '550e8400-e29b-41d4-a716-446655440000',
  '660e8400-e29b-41d4-a716-446655440001',
  '770e8400-e29b-41d4-a716-446655440002'
];

for (const uuid of messageUuids) {
  try {
    await api('/api/messages/delete', {
      method: 'DELETE',
      token: accessToken,
      body: { message_uuid: uuid }
    });
    console.log(`æ¶ˆæ¯ ${uuid} å·²åˆ é™¤`);
  } catch (error) {
    console.error(`åˆ é™¤æ¶ˆæ¯ ${uuid} å¤±è´¥:`, error);
  }
}
```

**ç‰¹ç‚¹**ï¼š
- è½¯åˆ é™¤ï¼Œä¸ä¼šç‰©ç†åˆ é™¤è®°å½•
- å‘é€è€…å’Œæ¥æ”¶è€…å¯ä»¥ç‹¬ç«‹åˆ é™¤
- åˆ é™¤åå½“å‰ç”¨æˆ·æ— æ³•å†æŸ¥çœ‹æ­¤æ¶ˆæ¯
- å¯¹æ–¹ä»å¯ä»¥æŸ¥çœ‹è¯¥æ¶ˆæ¯ï¼ˆé™¤éå¯¹æ–¹ä¹Ÿåˆ é™¤ï¼‰

**é”™è¯¯å“åº”**ï¼š
- `400` - æ¶ˆæ¯ä¸å­˜åœ¨
- `401` - æœªè®¤è¯æˆ–Tokenæ— æ•ˆ
- `403` - æ— æƒåˆ é™¤æ­¤æ¶ˆæ¯ï¼ˆæ—¢ä¸æ˜¯å‘é€è€…ä¹Ÿä¸æ˜¯æ¥æ”¶è€…ï¼‰
- `500` - æœåŠ¡å™¨å†…éƒ¨é”™è¯¯

---

## â†©ï¸ æ’¤å›æ¶ˆæ¯ï¼ˆå—ä¿æŠ¤ï¼‰

**è·¯å¾„**ï¼š`POST /api/messages/recall`

**è¯·æ±‚å¤´**ï¼š
- `Authorization: Bearer <access_token>` - å¿…éœ€

**è¯·æ±‚ä½“**ï¼š
```json
{
  "message_uuid": "550e8400-e29b-41d4-a716-446655440000"
}
```

**å“åº”**ï¼š
```json
{
  "success": true,
  "message": "æ¶ˆæ¯æ’¤å›æˆåŠŸ"
}
```

**Fetch ç¤ºä¾‹**ï¼š
```js
// æ’¤å›åˆšå‘é€çš„æ¶ˆæ¯
const recall = await api('/api/messages/recall', {
  method: 'POST',
  token: accessToken,
  body: {
    message_uuid: '550e8400-e29b-41d4-a716-446655440000'
  }
});

if (recall.success) {
  console.log('æ¶ˆæ¯å·²æ’¤å›');
  // ä»UIä¸­ç§»é™¤è¯¥æ¶ˆæ¯æˆ–æ˜¾ç¤º"æ­¤æ¶ˆæ¯å·²æ’¤å›"
}

// å®ç°å¸¦å€’è®¡æ—¶çš„æ’¤å›åŠŸèƒ½
async function sendWithRecallOption(receiverId, content) {
  // å‘é€æ¶ˆæ¯
  const sent = await api('/api/messages', {
    method: 'POST',
    token: accessToken,
    body: {
      receiver_id: receiverId,
      message_content: content,
      message_type: 'text'
    }
  });
  
  console.log('æ¶ˆæ¯å·²å‘é€:', sent.message_uuid);
  
  // æ˜¾ç¤ºæ’¤å›æŒ‰é’®ï¼Œ2åˆ†é’Ÿåè‡ªåŠ¨éšè—
  const recallButton = document.createElement('button');
  recallButton.textContent = 'æ’¤å›';
  recallButton.onclick = async () => {
    try {
      await api('/api/messages/recall', {
        method: 'POST',
        token: accessToken,
        body: { message_uuid: sent.message_uuid }
      });
      console.log('æ¶ˆæ¯å·²æ’¤å›');
    } catch (error) {
      console.error('æ’¤å›å¤±è´¥:', error);
    }
  };
  
  // 2åˆ†é’Ÿåç¦ç”¨æ’¤å›æŒ‰é’®
  setTimeout(() => {
    recallButton.disabled = true;
    recallButton.textContent = 'å·²è¶…è¿‡æ’¤å›æ—¶é™';
  }, 2 * 60 * 1000);
  
  return sent;
}
```

**é™åˆ¶**ï¼š
- åªèƒ½æ’¤å›è‡ªå·±å‘é€çš„æ¶ˆæ¯
- åªèƒ½æ’¤å›2åˆ†é’Ÿå†…çš„æ¶ˆæ¯
- æ’¤å›ååŒæ–¹éƒ½æ— æ³•æŸ¥çœ‹æ­¤æ¶ˆæ¯

**é”™è¯¯å“åº”**ï¼š
- `400` - æ¶ˆæ¯ä¸å­˜åœ¨æˆ–è¶…è¿‡2åˆ†é’Ÿæ’¤å›æ—¶é™
- `401` - æœªè®¤è¯æˆ–Tokenæ— æ•ˆ
- `403` - æ— æƒæ’¤å›æ­¤æ¶ˆæ¯ï¼ˆä¸æ˜¯å‘é€è€…ï¼‰
- `500` - æœåŠ¡å™¨å†…éƒ¨é”™è¯¯

---

## ğŸ”„ å®Œæ•´ç¤ºä¾‹ï¼šèŠå¤©ä¼šè¯

```js
class ChatSession {
  constructor(accessToken, friendId) {
    this.token = accessToken;
    this.friendId = friendId;
    this.messages = [];
    this.hasMore = true;
  }
  
  // åŠ è½½æœ€æ–°æ¶ˆæ¯
  async loadMessages(limit = 50) {
    const result = await api(`/api/messages?friend_id=${this.friendId}&limit=${limit}`, {
      method: 'GET',
      token: this.token
    });
    this.messages = result.messages;
    this.hasMore = result.has_more;
    return result;
  }
  
  // ä½¿ç”¨æ—¶é—´æˆ³åŠ è½½æ›´å¤šå†å²æ¶ˆæ¯
  async loadMoreMessages(limit = 50) {
    if (this.messages.length === 0) return await this.loadMessages(limit);
    if (!this.hasMore) return { messages: [], has_more: false };
    
    const oldestTime = encodeURIComponent(this.messages[this.messages.length - 1].send_time);
    const result = await api(
      `/api/messages?friend_id=${this.friendId}&before_time=${oldestTime}&limit=${limit}`,
      { method: 'GET', token: this.token }
    );
    
    this.messages.push(...result.messages);
    this.hasMore = result.has_more;
    return result;
  }
  
  // å‘é€æ–‡æœ¬æ¶ˆæ¯
  async sendText(content) {
    const result = await api('/api/messages', {
      method: 'POST',
      token: this.token,
      body: {
        receiver_id: this.friendId,
        message_content: content,
        message_type: 'text'
      }
    });
    
    // æ·»åŠ åˆ°æœ¬åœ°æ¶ˆæ¯åˆ—è¡¨
    await this.loadMessages();
    return result;
  }
  
  // å‘é€å›¾ç‰‡æ¶ˆæ¯
  async sendImage(fileUrl, fileSize) {
    const result = await api('/api/messages', {
      method: 'POST',
      token: this.token,
      body: {
        receiver_id: this.friendId,
        message_content: '[å›¾ç‰‡]',
        message_type: 'image',
        file_url: fileUrl,
        file_size: fileSize
      }
    });
    
    await this.loadMessages();
    return result;
  }
  
  // åˆ é™¤æ¶ˆæ¯
  async deleteMessage(messageUuid) {
    const result = await api('/api/messages/delete', {
      method: 'DELETE',
      token: this.token,
      body: { message_uuid: messageUuid }
    });
    
    // ä»æœ¬åœ°åˆ—è¡¨ç§»é™¤
    this.messages = this.messages.filter(m => m.message_uuid !== messageUuid);
    return result;
  }
  
  // æ’¤å›æ¶ˆæ¯
  async recallMessage(messageUuid) {
    const result = await api('/api/messages/recall', {
      method: 'POST',
      token: this.token,
      body: { message_uuid: messageUuid }
    });
    
    // ä»æœ¬åœ°åˆ—è¡¨ç§»é™¤
    this.messages = this.messages.filter(m => m.message_uuid !== messageUuid);
    return result;
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const chat = new ChatSession(myAccessToken, 'friend_user_123');

// åŠ è½½æ¶ˆæ¯
await chat.loadMessages();
console.log('å½“å‰æ¶ˆæ¯:', chat.messages);

// å‘é€æ¶ˆæ¯
await chat.sendText('ä½ å¥½ï¼');
await chat.sendImage('http://localhost:9000/.../photo.jpg', 524288);

// åŠ è½½æ›´å¤šå†å²æ¶ˆæ¯
await chat.loadMoreMessages();

// åˆ é™¤æ¶ˆæ¯
await chat.deleteMessage('550e8400-e29b-41d4-a716-446655440000');

// æ’¤å›æ¶ˆæ¯
await chat.recallMessage('660e8400-e29b-41d4-a716-446655440001');
```

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **å¥½å‹å…³ç³»éªŒè¯**ï¼šæ‰€æœ‰æ“ä½œéƒ½ä¼šéªŒè¯åŒæ–¹æ˜¯å¦ä¸ºå¥½å‹å…³ç³»
2. **æ¶ˆæ¯ç±»å‹**ï¼šå‘é€åª’ä½“æ¶ˆæ¯æ—¶å¿…é¡»æä¾› `file_url` å’Œ `file_size`
3. **æ—¶é—´æ ¼å¼**ï¼šæ‰€æœ‰æ—¶é—´å­—æ®µä½¿ç”¨ UTC æ—¶é—´ï¼ŒRFC3339 æ ¼å¼
4. **åˆ†é¡µåŠ è½½**ï¼šä½¿ç”¨ `before_time` æ—¶é—´æˆ³åˆ†é¡µ
5. **æ’¤å›é™åˆ¶**ï¼šåªèƒ½æ’¤å›2åˆ†é’Ÿå†…è‡ªå·±å‘é€çš„æ¶ˆæ¯
6. **è½¯åˆ é™¤**ï¼šåˆ é™¤æ“ä½œä¸ä¼šç‰©ç†åˆ é™¤è®°å½•ï¼ŒåŒæ–¹ç‹¬ç«‹åˆ é™¤
7. **Tokenè¿‡æœŸ**ï¼šAccess Token æœ‰æ•ˆæœŸ15åˆ†é’Ÿï¼Œè¿‡æœŸéœ€åˆ·æ–°
8. **é”™è¯¯å¤„ç†**ï¼šæ‰€æœ‰è¯·æ±‚éƒ½åº”è¯¥æ·»åŠ  try-catch å¤„ç†é”™è¯¯
9. **æ¶ˆæ¯å½’æ¡£**ï¼š30å¤©å‰çš„å†å²æ¶ˆæ¯ä¼šè‡ªåŠ¨å½’æ¡£ï¼Œä»å¯æŸ¥è¯¢

---

## ğŸ” å®‰å…¨å»ºè®®

1. **Token ä¿æŠ¤**ï¼š
   - å°† Access Token å­˜å‚¨åœ¨å†…å­˜æˆ– SessionStorage
   - ä¸è¦å°† Token æš´éœ²åœ¨ URL å‚æ•°ä¸­
   - ä½¿ç”¨ HTTPS ä¼ è¾“

2. **è¾“å…¥éªŒè¯**ï¼š
   - å‰ç«¯éªŒè¯æ¶ˆæ¯å†…å®¹é•¿åº¦
   - éªŒè¯æ–‡ä»¶å¤§å°å’Œç±»å‹
   - é˜²æ­¢ XSS æ”»å‡»ï¼Œè½¬ä¹‰æ˜¾ç¤ºå†…å®¹

3. **é”™è¯¯å¤„ç†**ï¼š
   - æ•è·å¹¶å¤„ç†æ‰€æœ‰å¯èƒ½çš„é”™è¯¯
   - å‘ç”¨æˆ·æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯æç¤º
   - è®°å½•é”™è¯¯æ—¥å¿—ç”¨äºè°ƒè¯•

4. **æ€§èƒ½ä¼˜åŒ–**ï¼š
   - ä½¿ç”¨åˆ†é¡µåŠ è½½é¿å…ä¸€æ¬¡åŠ è½½è¿‡å¤šæ¶ˆæ¯
   - å®ç°æ¶ˆæ¯ç¼“å­˜å‡å°‘ç½‘ç»œè¯·æ±‚
   - ä½¿ç”¨ WebSocket å®ç°å®æ—¶æ¶ˆæ¯æ¨é€ï¼ˆæœªæ¥åŠŸèƒ½ï¼‰

