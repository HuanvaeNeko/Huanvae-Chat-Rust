# Group Messages ç¾¤æ¶ˆæ¯æ¥å£ï¼ˆFetch APIï¼‰

ç¾¤æ¶ˆæ¯ç›¸å…³æ¥å£çš„å‰ç«¯è°ƒç”¨ç¤ºä¾‹ï¼Œä½¿ç”¨ Fetch APIã€‚

## ğŸ”§ é€šç”¨å·¥å…·å‡½æ•°

```js
const BASE = 'http://localhost:8080';

/**
 * é€šç”¨ API è¯·æ±‚å°è£…
 */
async function api(path, { method='GET', token, body }={}) {
  const headers = {};
  
  if (body) {
    headers['Content-Type'] = 'application/json';
  }
  
  if (token) {
    headers['Authorization'] = `Bearer ${token}`;
  }
  
  const res = await fetch(`${BASE}${path}`, {
    method,
    headers,
    body: body ? JSON.stringify(body) : undefined
  });
  
  const data = await res.json().catch(() => ({}));
  
  if (!res.ok) {
    throw new Error(`${res.status} ${JSON.stringify(data)}`);
  }
  
  return data;
}
```

---

## ğŸ“‹ æ¥å£åˆ—è¡¨

### 1. å‘é€ç¾¤æ¶ˆæ¯

**ç«¯ç‚¹**ï¼š`POST /api/group-messages`

**åŠŸèƒ½**ï¼šå‘ç¾¤èŠå‘é€æ¶ˆæ¯

**é™åˆ¶**ï¼š
- å¿…é¡»æ˜¯ç¾¤æˆå‘˜
- ä¸èƒ½è¢«ç¦è¨€

**è¯·æ±‚ä½“**ï¼š
```typescript
{
  group_id: string,          // ç¾¤èŠIDï¼ˆå¿…å¡«ï¼‰
  message_content: string,   // æ¶ˆæ¯å†…å®¹ï¼ˆå¿…å¡«ï¼‰
  message_type: string,      // æ¶ˆæ¯ç±»å‹ï¼ˆå¿…å¡«ï¼‰
  file_uuid?: string,        // æ–‡ä»¶UUIDï¼ˆå¯é€‰ï¼Œå‘é€æ–‡ä»¶æ—¶ä½¿ç”¨ï¼‰
  file_url?: string,         // æ–‡ä»¶URLï¼ˆå¯é€‰ï¼‰
  file_size?: number,        // æ–‡ä»¶å¤§å°ï¼ˆå¯é€‰ï¼‰
  reply_to?: string          // å›å¤çš„æ¶ˆæ¯UUIDï¼ˆå¯é€‰ï¼‰
}
```

**æ¶ˆæ¯ç±»å‹**ï¼š
| ç±»å‹ | è¯´æ˜ |
|------|------|
| `text` | æ–‡æœ¬æ¶ˆæ¯ |
| `image` | å›¾ç‰‡æ¶ˆæ¯ |
| `video` | è§†é¢‘æ¶ˆæ¯ |
| `file` | æ–‡ä»¶æ¶ˆæ¯ |
| `system` | ç³»ç»Ÿæ¶ˆæ¯ |

**è¯·æ±‚ç¤ºä¾‹**ï¼š

```js
// å‘é€æ–‡æœ¬æ¶ˆæ¯
const result = await api('/api/group-messages', {
  method: 'POST',
  token,
  body: {
    group_id: '019ae4ec-0dfe-7ac1-966e-876e9755561c',
    message_content: 'å¤§å®¶å¥½ï¼',
    message_type: 'text'
  }
});

console.log(result);
// {
//   "success": true,
//   "code": 200,
//   "data": {
//     "message_uuid": "019ae4ef-cbf6-7171-88c5-6a891004fc8f",
//     "send_time": "2025-12-03T15:58:31.926019Z"
//   }
// }
```

```js
// å‘é€å›¾ç‰‡æ¶ˆæ¯
const result = await api('/api/group-messages', {
  method: 'POST',
  token,
  body: {
    group_id: '019ae4ec-0dfe-7ac1-966e-876e9755561c',
    message_content: '[å›¾ç‰‡]',
    message_type: 'image',
    file_uuid: 'd2f612d5-70b0-4d4e-8779-86cf6aeb2b30'
  }
});
```

```js
// å›å¤æ¶ˆæ¯
const result = await api('/api/group-messages', {
  method: 'POST',
  token,
  body: {
    group_id: '019ae4ec-0dfe-7ac1-966e-876e9755561c',
    message_content: 'æˆ‘åŒæ„ä½ çš„è§‚ç‚¹',
    message_type: 'text',
    reply_to: '019ae4ef-cbf6-7171-88c5-6a891004fc8f'
  }
});
```

**é”™è¯¯å“åº”**ï¼š

è¢«ç¦è¨€ï¼ˆ403ï¼‰ï¼š
```json
{
  "success": false,
  "code": 403,
  "error": "ä½ å·²è¢«ç¦è¨€ï¼Œæ— æ³•å‘é€æ¶ˆæ¯"
}
```

éç¾¤æˆå‘˜ï¼ˆ403ï¼‰ï¼š
```json
{
  "success": false,
  "code": 403,
  "error": "ä½ ä¸æ˜¯è¯¥ç¾¤æˆå‘˜"
}
```

---

### 2. è·å–ç¾¤æ¶ˆæ¯åˆ—è¡¨

**ç«¯ç‚¹**ï¼š`GET /api/group-messages?group_id=xxx&before_uuid=xxx&limit=50`

**å‚æ•°**ï¼š
| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|-----|------|
| `group_id` | UUID | âœ… | ç¾¤èŠID |
| `before_uuid` | UUID | âŒ | ä»è¿™æ¡æ¶ˆæ¯ä¹‹å‰æŸ¥è¯¢ï¼ˆåˆ†é¡µï¼‰ |
| `limit` | number | âŒ | è¿”å›æ¡æ•°ï¼Œé»˜è®¤ 50ï¼Œæœ€å¤§ 500 |

**è¯·æ±‚ç¤ºä¾‹**ï¼š
```js
// è·å–æœ€æ–°æ¶ˆæ¯
const groupId = '019ae4ec-0dfe-7ac1-966e-876e9755561c';
const messages = await api(`/api/group-messages?group_id=${groupId}&limit=50`, { token });

console.log(messages);
// {
//   "success": true,
//   "code": 200,
//   "data": {
//     "messages": [
//       {
//         "message_uuid": "019ae4ef-cbf6-7171-88c5-6a891004fc8f",
//         "group_id": "019ae4ec-0dfe-7ac1-966e-876e9755561c",
//         "sender_id": "user_a",
//         "sender_nickname": "ç”¨æˆ·A",
//         "sender_avatar_url": "",
//         "message_content": "å¤§å®¶å¥½ï¼",
//         "message_type": "text",
//         "file_uuid": null,
//         "file_url": null,
//         "file_size": null,
//         "reply_to": null,
//         "send_time": "2025-12-03T15:58:31.926019Z",
//         "is_recalled": false
//       }
//     ],
//     "has_more": false
//   }
// }
```

```js
// åˆ†é¡µæŸ¥è¯¢ï¼ˆåŠ è½½æ›´å¤šå†å²æ¶ˆæ¯ï¼‰
const groupId = '019ae4ec-0dfe-7ac1-966e-876e9755561c';
const lastMessageUuid = '019ae4ef-cbf6-7171-88c5-6a891004fc8f';
const olderMessages = await api(
  `/api/group-messages?group_id=${groupId}&before_uuid=${lastMessageUuid}&limit=50`,
  { token }
);
```

**å“åº”å­—æ®µè¯´æ˜**ï¼š
| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `message_uuid` | UUID | æ¶ˆæ¯å”¯ä¸€æ ‡è¯† |
| `group_id` | UUID | ç¾¤èŠID |
| `sender_id` | string | å‘é€è€…ID |
| `sender_nickname` | string | å‘é€è€…æ˜µç§° |
| `sender_avatar_url` | string | å‘é€è€…å¤´åƒURL |
| `message_content` | string | æ¶ˆæ¯å†…å®¹ï¼ˆå·²æ’¤å›æ˜¾ç¤º "[æ¶ˆæ¯å·²æ’¤å›]"ï¼‰ |
| `message_type` | string | æ¶ˆæ¯ç±»å‹ |
| `file_uuid` | string \| null | æ–‡ä»¶UUID |
| `file_url` | string \| null | æ–‡ä»¶URL |
| `file_size` | number \| null | æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰ |
| `reply_to` | UUID \| null | å›å¤çš„æ¶ˆæ¯UUID |
| `send_time` | string | å‘é€æ—¶é—´ï¼ˆISO 8601ï¼‰ |
| `is_recalled` | boolean | æ˜¯å¦å·²æ’¤å› |
| `has_more` | boolean | æ˜¯å¦æœ‰æ›´å¤šå†å²æ¶ˆæ¯ |

---

### 3. åˆ é™¤æ¶ˆæ¯ï¼ˆä¸ªäººï¼‰

**ç«¯ç‚¹**ï¼š`DELETE /api/group-messages/delete`

**åŠŸèƒ½**ï¼šåˆ é™¤æ¶ˆæ¯ï¼ˆä»…å¯¹è‡ªå·±ä¸å¯è§ï¼Œä¸å½±å“å…¶ä»–ç¾¤æˆå‘˜ï¼‰

**è¯·æ±‚ä½“**ï¼š
```typescript
{
  message_uuid: string  // è¦åˆ é™¤çš„æ¶ˆæ¯UUID
}
```

**è¯·æ±‚ç¤ºä¾‹**ï¼š
```js
await api('/api/group-messages/delete', {
  method: 'DELETE',
  token,
  body: {
    message_uuid: '019ae4ef-cbf6-7171-88c5-6a891004fc8f'
  }
});

// {
//   "success": true,
//   "code": 200,
//   "data": {
//     "success": true,
//     "message": "æ¶ˆæ¯å·²åˆ é™¤"
//   }
// }
```

**è¯´æ˜**ï¼š
- è¿™æ˜¯"è½¯åˆ é™¤"ï¼Œä»…å¯¹å½“å‰ç”¨æˆ·ä¸å¯è§
- å…¶ä»–ç¾¤æˆå‘˜ä»ç„¶å¯ä»¥çœ‹åˆ°è¿™æ¡æ¶ˆæ¯
- æ— æ³•æ’¤é”€åˆ é™¤æ“ä½œ

---

### 4. æ’¤å›æ¶ˆæ¯

**ç«¯ç‚¹**ï¼š`POST /api/group-messages/recall`

**åŠŸèƒ½**ï¼šæ’¤å›æ¶ˆæ¯ï¼ˆæ‰€æœ‰äººéƒ½çœ‹ä¸åˆ°ï¼‰

**æƒé™**ï¼š
- **å‘é€è€…**ï¼šåªèƒ½æ’¤å› **2 åˆ†é’Ÿå†…** å‘é€çš„æ¶ˆæ¯
- **ç¾¤ä¸»/ç®¡ç†å‘˜**ï¼šå¯ä»¥æ’¤å›ä»»æ„æ¶ˆæ¯

**è¯·æ±‚ä½“**ï¼š
```typescript
{
  message_uuid: string  // è¦æ’¤å›çš„æ¶ˆæ¯UUID
}
```

**è¯·æ±‚ç¤ºä¾‹**ï¼š
```js
await api('/api/group-messages/recall', {
  method: 'POST',
  token,
  body: {
    message_uuid: '019ae4ef-cbf6-7171-88c5-6a891004fc8f'
  }
});

// {
//   "success": true,
//   "code": 200,
//   "data": {
//     "success": true,
//     "message": "æ¶ˆæ¯å·²æ’¤å›"
//   }
// }
```

**æ’¤å›åæ•ˆæœ**ï¼š
- æ‰€æœ‰äººçœ‹åˆ°çš„æ¶ˆæ¯å†…å®¹å˜ä¸º `[æ¶ˆæ¯å·²æ’¤å›]`
- æ–‡ä»¶ä¿¡æ¯ä¸å†è¿”å›
- æ¶ˆæ¯çš„ `is_recalled` å­—æ®µå˜ä¸º `true`

**é”™è¯¯å“åº”**ï¼š

è¶…è¿‡æ’¤å›æ—¶é™ï¼ˆ400ï¼‰ï¼š
```json
{
  "success": false,
  "code": 400,
  "error": "åªèƒ½æ’¤å› 2 åˆ†é’Ÿå†…å‘é€çš„æ¶ˆæ¯"
}
```

æƒé™ä¸è¶³ï¼ˆ403ï¼‰ï¼š
```json
{
  "success": false,
  "code": 403,
  "error": "åªæœ‰ç¾¤ä¸»æˆ–ç®¡ç†å‘˜å¯ä»¥æ’¤å›ä»–äººçš„æ¶ˆæ¯"
}
```

---

## ğŸ¨ å®Œæ•´ç¤ºä¾‹ï¼šç¾¤èŠæ¶ˆæ¯é¡µé¢

```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>ç¾¤èŠæ¶ˆæ¯</title>
  <style>
    .chat-container { max-width: 800px; margin: 0 auto; padding: 20px; }
    .messages { height: 500px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; }
    .message { margin-bottom: 15px; padding: 10px; background: #f5f5f5; border-radius: 8px; }
    .message.recalled { opacity: 0.6; font-style: italic; }
    .message-header { display: flex; align-items: center; margin-bottom: 5px; }
    .avatar { width: 32px; height: 32px; border-radius: 50%; margin-right: 8px; }
    .sender-name { font-weight: bold; margin-right: 10px; }
    .send-time { color: #999; font-size: 12px; }
    .message-content { margin-left: 40px; }
    .input-area { display: flex; margin-top: 10px; }
    .input-area input { flex: 1; padding: 10px; }
    .input-area button { padding: 10px 20px; background: #007bff; color: white; border: none; }
  </style>
</head>
<body>
  <div class="chat-container">
    <h1>ç¾¤èŠæ¶ˆæ¯</h1>
    
    <div class="messages" id="messagesContainer">
      <!-- æ¶ˆæ¯åˆ—è¡¨ -->
    </div>
    
    <div class="input-area">
      <input type="text" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯...">
      <button onclick="sendMessage()">å‘é€</button>
    </div>
  </div>

  <script>
    const BASE = 'http://localhost:8080';
    const token = localStorage.getItem('access_token');
    const groupId = '019ae4ec-0dfe-7ac1-966e-876e9755561c'; // ä»URLæˆ–çŠ¶æ€è·å–
    
    // API è¯·æ±‚å°è£…
    async function api(path, { method='GET', token, body }={}) {
      const headers = {};
      if (body) headers['Content-Type'] = 'application/json';
      if (token) headers['Authorization'] = `Bearer ${token}`;
      
      const res = await fetch(`${BASE}${path}`, {
        method,
        headers,
        body: body ? JSON.stringify(body) : undefined
      });
      
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(`${res.status} ${JSON.stringify(data)}`);
      return data;
    }
    
    // åŠ è½½æ¶ˆæ¯åˆ—è¡¨
    async function loadMessages() {
      try {
        const result = await api(`/api/group-messages?group_id=${groupId}&limit=50`, { token });
        const container = document.getElementById('messagesContainer');
        container.innerHTML = '';
        
        result.data.messages.forEach(msg => {
          const div = document.createElement('div');
          div.className = `message ${msg.is_recalled ? 'recalled' : ''}`;
          div.innerHTML = `
            <div class="message-header">
              <img class="avatar" src="${msg.sender_avatar_url || '/default-avatar.png'}" alt="">
              <span class="sender-name">${msg.sender_nickname}</span>
              <span class="send-time">${new Date(msg.send_time).toLocaleString()}</span>
            </div>
            <div class="message-content">${msg.message_content}</div>
          `;
          container.appendChild(div);
        });
        
        // æ»šåŠ¨åˆ°åº•éƒ¨
        container.scrollTop = container.scrollHeight;
      } catch (error) {
        console.error('åŠ è½½æ¶ˆæ¯å¤±è´¥:', error);
      }
    }
    
    // å‘é€æ¶ˆæ¯
    async function sendMessage() {
      const input = document.getElementById('messageInput');
      const content = input.value.trim();
      
      if (!content) return;
      
      try {
        await api('/api/group-messages', {
          method: 'POST',
          token,
          body: {
            group_id: groupId,
            message_content: content,
            message_type: 'text'
          }
        });
        
        input.value = '';
        loadMessages(); // åˆ·æ–°æ¶ˆæ¯åˆ—è¡¨
      } catch (error) {
        alert('å‘é€å¤±è´¥: ' + error.message);
      }
    }
    
    // æ’¤å›æ¶ˆæ¯
    async function recallMessage(messageUuid) {
      try {
        await api('/api/group-messages/recall', {
          method: 'POST',
          token,
          body: { message_uuid: messageUuid }
        });
        loadMessages();
      } catch (error) {
        alert('æ’¤å›å¤±è´¥: ' + error.message);
      }
    }
    
    // åˆ é™¤æ¶ˆæ¯ï¼ˆä¸ªäººï¼‰
    async function deleteMessage(messageUuid) {
      try {
        await api('/api/group-messages/delete', {
          method: 'DELETE',
          token,
          body: { message_uuid: messageUuid }
        });
        loadMessages();
      } catch (error) {
        alert('åˆ é™¤å¤±è´¥: ' + error.message);
      }
    }
    
    // å›è½¦å‘é€æ¶ˆæ¯
    document.getElementById('messageInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });
    
    // åˆå§‹åŠ è½½
    loadMessages();
    
    // å®šæ—¶åˆ·æ–°ï¼ˆç®€å•å®ç°ï¼Œå®é™…åº”ä½¿ç”¨ WebSocketï¼‰
    setInterval(loadMessages, 5000);
  </script>
</body>
</html>
```

---

## ğŸ” æƒé™æ§åˆ¶

| æ“ä½œ | ç¾¤ä¸» | ç®¡ç†å‘˜ | æ™®é€šæˆå‘˜ |
|------|-----|-------|---------|
| å‘é€æ¶ˆæ¯ | âœ… | âœ… | âœ…ï¼ˆæœªç¦è¨€ï¼‰ |
| è·å–æ¶ˆæ¯ | âœ… | âœ… | âœ… |
| åˆ é™¤æ¶ˆæ¯ï¼ˆä¸ªäººï¼‰ | âœ… | âœ… | âœ… |
| æ’¤å›è‡ªå·±çš„æ¶ˆæ¯ï¼ˆ2åˆ†é’Ÿå†…ï¼‰ | âœ… | âœ… | âœ… |
| æ’¤å›ä»»æ„æ¶ˆæ¯ | âœ… | âœ… | âŒ |

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ¶ˆæ¯å†…å®¹ä¸èƒ½ä¸ºç©º**ï¼šç©ºæ¶ˆæ¯ä¼šè¢«æ‹’ç»
2. **æ’¤å›æ—¶é™**ï¼šæ™®é€šæˆå‘˜åªèƒ½æ’¤å› 2 åˆ†é’Ÿå†…å‘é€çš„æ¶ˆæ¯
3. **åˆ é™¤ vs æ’¤å›**ï¼š
   - åˆ é™¤ï¼šä»…å¯¹è‡ªå·±ä¸å¯è§ï¼Œå…¶ä»–äººä»å¯çœ‹åˆ°
   - æ’¤å›ï¼šæ‰€æœ‰äººéƒ½çœ‹ä¸åˆ°åŸå†…å®¹
4. **ç¦è¨€æ£€æŸ¥**ï¼šè¢«ç¦è¨€çš„ç”¨æˆ·æ— æ³•å‘é€æ¶ˆæ¯
5. **åˆ†é¡µåŠ è½½**ï¼šä½¿ç”¨ `before_uuid` å‚æ•°åŠ è½½æ›´å¤šå†å²æ¶ˆæ¯
6. **å®æ—¶æ¶ˆæ¯**ï¼šç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨ WebSocket å®ç°å®æ—¶æ¶ˆæ¯æ¨é€

